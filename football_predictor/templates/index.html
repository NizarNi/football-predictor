<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Prediction - Safe Bet Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #0ea5e9;
            --accent-color: #f59e0b;
            --background-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --muted-text: #64748b;
            --analysis-bg: #f1f5f9;
            --league-badge-bg: #e2e8f0;
            --probability-bar-bg: #e2e8f0;
            --autocomplete-bg: #ffffff;
            --autocomplete-hover: #f8f9fa;
            --autocomplete-border: #dddddd;
        }
        
        body.dark-theme {
            --primary-color: #6366f1;
            --secondary-color: #22d3ee;
            --accent-color: #f59e0b;
            --background-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #ffffff;
            --border-color: #334155;
            --muted-text: #cbd5e1;
            --analysis-bg: #334155;
            --league-badge-bg: #334155;
            --probability-bar-bg: #334155;
            --autocomplete-bg: #1e293b;
            --autocomplete-hover: #334155;
            --autocomplete-border: #475569;
        }
        
        /* Dark mode - Proper color inheritance using CSS variables */
        body.dark-theme {
            color: var(--text-color);
        }
        
        /* Theme-aware text colors with !important to override Bootstrap */
        body.dark-theme .text-muted {
            color: #cbd5e1 !important;
        }
        
        body.dark-theme .text-dark {
            color: #e2e8f0 !important;
        }
        
        body.dark-theme .text-secondary {
            color: #94a3b8 !important;
        }
        
        body.dark-theme .text-body {
            color: #f1f5f9 !important;
        }
        
        /* Semantic colors - dark mode with better contrast (must override Bootstrap !important) */
        body.dark-theme .text-success {
            color: #4ade80 !important;
        }
        
        body.dark-theme .text-danger {
            color: #f87171 !important;
        }
        
        body.dark-theme .text-warning {
            color: #fbbf24 !important;
        }
        
        body.dark-theme .text-info {
            color: #38bdf8 !important;
        }
        
        body.dark-theme .text-primary {
            color: #6366f1 !important;
        }
        
        /* Bootstrap Alert overrides for dark mode */
        body.dark-theme .alert-warning {
            background-color: #78350f !important;
            border-color: #f59e0b !important;
            color: #fef3c7 !important;
        }
        
        body.dark-theme .alert-info {
            background-color: #0c4a6e !important;
            border-color: #0ea5e9 !important;
            color: #bae6fd !important;
        }
        
        body.dark-theme .alert-danger {
            background-color: #7f1d1d !important;
            border-color: #ef4444 !important;
            color: #fecaca !important;
        }
        
        body.dark-theme .alert-success {
            background-color: #064e3b !important;
            border-color: #10b981 !important;
            color: #d1fae5 !important;
        }
        
        /* Card body text - ensure proper inheritance */
        body.dark-theme .card-body {
            color: var(--text-color) !important;
        }
        
        body.dark-theme .card-body * {
            color: inherit;
        }
        
        body.dark-theme .card-text {
            color: #e2e8f0 !important;
        }
        
        body.dark-theme .card-title {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode - Fix light background highlight sections for readability */
        body.dark-theme .analysis-section[style*="background-color: #d1fae5"],
        body.dark-theme .analysis-section[style*="background: #d1fae5"] {
            background-color: #064e3b !important;
            border-color: #10b981 !important;
        }
        
        body.dark-theme .analysis-section[style*="background-color: #d1fae5"] *,
        body.dark-theme .analysis-section[style*="background: #d1fae5"] * {
            color: #d1fae5 !important;
        }
        
        body.dark-theme .alert[style*="background-color: #fef3c7"] {
            background-color: #78350f !important;
            border-color: #f59e0b !important;
            color: #fef3c7 !important;
        }
        
        body.dark-theme .match-card.arbitrage-match {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%) !important;
        }
        
        body.dark-theme .match-card.arbitrage-match * {
            color: #d1fae5 !important;
        }
        
        /* Tooltip styling - wider to prevent text wrapping and enable multi-line */
        .tooltip-inner {
            min-width: 250px !important;
            max-width: 350px !important;
            text-align: left;
            white-space: pre-line !important;
        }
        
        /* Match Context - CSS Grid layout for stable display */
        .match-context-grid {
            display: grid;
            grid-template-columns: minmax(120px, auto) 1fr;
            gap: 0.5rem 1rem;
            align-items: center;
        }
        
        .match-context-label {
            color: #6c757d;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        body.dark-theme .match-context-label {
            color: #94a3b8 !important;
        }
        
        .match-context-value {
            font-weight: 500;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .card {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background-color: var(--card-bg);
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #152b63;
            border-color: #152b63;
        }
        
        body.dark-theme .btn-primary:hover {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .match-card {
            cursor: pointer;
        }
        
        .match-card:hover {
            border-color: var(--secondary-color);
        }
        
        .match-card.popular-match {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, #fff9e6 0%, var(--card-bg) 100%);
        }
        
        body.dark-theme .match-card.popular-match {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--card-bg) 100%);
        }
        
        .match-card.popular-match::before {
            content: "‚≠ê POPULAR";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .match-card.arbitrage-match {
            border: 2px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, var(--card-bg) 100%);
        }
        
        body.dark-theme .match-card.arbitrage-match {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, var(--card-bg) 100%);
        }
        
        .match-card.arbitrage-match::after {
            content: "üí∞ ARBITRAGE";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #10b981;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        
        
        
        .match-card {
            position: relative;
        }
        
        .prediction-badge {
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .safe-bet {
            background-color: #10b981;
            color: white;
        }
        
        .risky-bet {
            background-color: #f59e0b;
            color: white;
        }
        
        .very-risky {
            background-color: #ef4444;
            color: white;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .team-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
            margin-right: 10px;
        }
        
        .odds-table {
            font-size: 0.9rem;
        }
        
        .odds-table th, .odds-table td {
            padding: 8px;
        }
        
        .stats-bar {
            height: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .home-stats {
            background-color: var(--primary-color);
        }
        
        .away-stats {
            background-color: var(--secondary-color);
        }
        
        .exact-score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .exact-score-item:last-child {
            border-bottom: none;
        }
        
        .probability-bar {
            height: 20px;
            border-radius: 10px;
            background-color: var(--probability-bar-bg);
            overflow: hidden;
            margin: 5px 0;
            transition: background-color 0.3s ease;
        }
        
        .probability-fill {
            height: 100%;
            background-color: var(--secondary-color);
        }
        
        .league-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: var(--league-badge-bg);
            color: var(--text-color);
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }
        
        .match-date {
            font-size: 0.8rem;
            color: var(--muted-text);
        }
        
        .analysis-section {
            background-color: var(--analysis-bg);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        
        .analysis-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            z-index: 999999;
            background: var(--autocomplete-bg);
            border: 1px solid var(--autocomplete-border);
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            width: calc(100% - 12px);
            margin-top: 2px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .autocomplete-item:hover {
            background-color: var(--autocomplete-hover);
        }
        
        .autocomplete-item .team-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .autocomplete-item .team-alias {
            font-size: 0.85rem;
            color: var(--muted-text);
            margin-left: 5px;
        }
        
        .autocomplete-item .team-league {
            font-size: 0.75rem;
            color: var(--muted-text);
            display: block;
        }
        
        @media (max-width: 768px) {
            .card-header {
                font-size: 1rem;
            }
            
            .prediction-badge {
                font-size: 0.8rem;
                padding: 5px 8px;
            }
        }
        
        /* Loading Animations */
        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.15);
                opacity: 0.7;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .loading-container {
            text-align: center;
            padding: 30px 20px;
        }
        
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: pulse 1.5s ease-in-out infinite;
            display: inline-block;
        }
        
        .progress-bar-container {
            position: relative;
            background-color: var(--border-color);
            border-radius: 20px;
            height: 30px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color));
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            border-radius: 20px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .loading-step-text {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: 500;
            animation: fadeInUp 0.3s ease;
        }
        
        .loading-tip {
            font-size: 0.9rem;
            color: var(--muted-text);
            margin-top: 15px;
            padding: 10px;
            background-color: var(--analysis-bg);
            border-radius: 8px;
            animation: fadeInUp 0.5s ease;
        }
        
        .loading-tip strong {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-futbol me-2"></i>
                Football Prediction - Safe Bet Analyzer
            </a>
            <div class="d-flex gap-3 align-items-center">
                <a href="/learn" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-graduation-cap me-1"></i>
                    <span class="d-none d-md-inline">Learn Analytics</span>
                </a>
                <button id="theme-toggle" class="btn btn-outline-light btn-sm" onclick="toggleTheme()">
                    <i id="theme-icon" class="fas fa-moon"></i>
                    <span id="theme-text" class="ms-2 d-none d-md-inline">Dark Mode</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-search me-2"></i> Find Matches
                    </div>
                    <div class="card-body">
                        <!-- Centered Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-8 offset-md-2" style="position: relative; z-index: 100000;">
                                <div style="position: relative; z-index: 100001;">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" id="team-search" class="form-control" placeholder="Search by team name or nickname (PSG, Barca, Bayern)..." autocomplete="off">
                                        <button class="btn btn-primary" id="search-btn">
                                            Search
                                        </button>
                                    </div>
                                    <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Bar -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap align-items-center justify-content-center gap-3">
                                    <div class="d-flex align-items-center">
                                        <label class="me-2 mb-0 fw-bold">
                                            <i class="fas fa-filter me-1"></i> Show Only:
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="arbitrage-filter-checkbox">
                                        <label class="form-check-label" for="arbitrage-filter-checkbox">
                                            üí∞ Arbitrage Opportunities
                                        </label>
                                    </div>
                                    
                                    <div id="filter-badge" class="badge bg-success" style="display: none; font-size: 0.9rem;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- League Browse Buttons -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-2">Browse by League:</small>
                                    <div class="d-flex flex-wrap justify-content-center">
                                        <button class="btn btn-outline-primary m-1" data-league="PL">Premier League</button>
                                        <button class="btn btn-outline-primary m-1" data-league="PD">La Liga</button>
                                        <button class="btn btn-outline-primary m-1" data-league="BL1">Bundesliga</button>
                                        <button class="btn btn-outline-primary m-1" data-league="SA">Serie A</button>
                                        <button class="btn btn-outline-primary m-1" data-league="FL1">Ligue 1</button>
                                        <button class="btn btn-outline-primary m-1" data-league="CL">Champions League</button>
                                        <button class="btn btn-outline-primary m-1" data-league="EL">Europa League</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 col-lg-5">
                <div id="matches-container">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calendar-alt me-2"></i> Matches
                        </div>
                        <div class="card-body">
                            <div id="matches-list">
                                <div class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-12 col-lg-7">
                <div id="prediction-container" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i> Match Prediction
                        </div>
                        <div class="card-body">
                            <div id="match-details">
                                <h4 id="match-teams" class="mb-3"></h4>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span id="match-league" class="league-badge"></span>
                                    <span id="match-date" class="match-date"></span>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-trophy me-2"></i> 1X2 Prediction
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Hybrid Model: 60% Elo (ClubElo historical ratings) + 40% Market (30+ bookmaker consensus). Combines historical performance with current market sentiment for balanced predictions. Source: ClubElo.com + The Odds API" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="prediction-1x2">
                                                <div class="loading">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <i class="fas fa-chart-line me-2"></i> Match Context
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="League standings (Understat), Historical xG trends (FBref), PPDA defensive metrics (Understat), and team form indicators" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="match-context">
                                                <p class="text-muted">Select a match to view context</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-exchange-alt me-2"></i> Over/Under Predictions
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Averaged across 2.25, 2.5, and 2.75 goal lines from 30+ bookmakers for more robust predictions. Source: The Odds API" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="prediction-over-under">
                                                <div class="text-center">
                                                    <button id="load-over-under-btn" class="btn btn-primary">
                                                        <i class="fas fa-chart-bar me-2"></i> Show Over/Under Odds
                                                    </button>
                                                    <p class="text-muted mt-2 small">Click to fetch detailed over/under predictions from bookmakers</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-chart-bar me-2"></i> Betting Analysis
                                        </div>
                                        <div class="card-body">
                                            <div id="betting-analysis">
                                                <div class="text-center">
                                                    <button onclick="loadBettingAnalysis()" class="btn btn-primary">
                                                        <i class="fas fa-coins me-2"></i> Show Betting Analysis
                                                    </button>
                                                    <p class="text-muted mt-2 small">View arbitrage opportunities, best odds, and betting tips</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">¬© 2025 Football Prediction - Safe Bet Analyzer</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables for theme toggle access
        let currentMatchData = null;
        let currentOverUnderData = null;
        let currentXgData = null;
        
        // Theme-aware color helper functions (global scope for theme toggle)
        function isDarkTheme() {
            return document.body.classList.contains('dark-theme');
        }
        
        function getThemeColors() {
            const dark = isDarkTheme();
            return {
                primary: dark ? '#6366f1' : '#1e3a8a',
                secondary: dark ? '#22d3ee' : '#0ea5e9',
                muted: dark ? '#94a3b8' : '#64748b',
                xgFor: '#28a745',  // Keep green for xGF
                xgAgainst: '#dc3545',  // Keep red for xGA
                winGreen: '#28a745',
                drawGray: dark ? '#94a3b8' : '#6c757d',
                lossRed: '#dc3545',
                chartGrid: dark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(0, 0, 0, 0.05)',
                chartText: dark ? '#94a3b8' : '#64748b',
                infoBoxBg: dark ? 'rgba(99, 102, 241, 0.15)' : '#e7f3ff',
                infoBoxBorder: dark ? 'rgba(99, 102, 241, 0.3)' : '#b3d9ff',
                infoBoxIcon: dark ? '#6366f1' : '#0066cc',
                xgAnalysisBg: dark ? 'rgba(99, 102, 241, 0.15)' : '#f0f4ff',
                xgAnalysisBorder: dark ? 'rgba(99, 102, 241, 0.3)' : '#6366f1',
                xgAnalysisText: dark ? '#818cf8' : '#6366f1'
            };
        }
        
        // Format form indicators helper (global scope for theme toggle)
        function formatFormIndicators(formString) {
            if (!formString) return '';
            
            const colors = getThemeColors();
            // Reverse to show oldest‚Üínewest (left to right)
            const formArray = formString.split('').reverse();
            return `<div style="display: inline-flex; gap: 2px; white-space: nowrap;">` + formArray.map(result => {
                let bgColor = '';
                
                if (result === 'W') {
                    bgColor = colors.winGreen;
                } else if (result === 'D') {
                    bgColor = colors.drawGray;
                } else if (result === 'L') {
                    bgColor = colors.lossRed;
                }
                
                return `<span style="display: inline-block; width: 24px; height: 24px; background-color: ${bgColor}; color: white; text-align: center; line-height: 24px; font-size: 12px; font-weight: bold; border-radius: 3px;">${result}</span>`;
            }).join('') + `</div>`;
        }
        
        // Create xG trend chart helper (global scope for theme toggle)
        function createXgTrendChart(canvasId, recentMatches, teamName) {
            if (!recentMatches || recentMatches.length === 0) return null;
            
            // Backend sends newest‚Üíoldest, so reverse for chronological display (oldest‚Üínewest left to right)
            const matches = [...recentMatches].reverse();
            const colors = getThemeColors();
            
            const rollingWindow = 5;
            const xgForRolling = [];
            const xgAgainstRolling = [];
            const labels = [];
            
            for (let i = 0; i < matches.length; i++) {
                const startIdx = Math.max(0, i - rollingWindow + 1);
                const window = matches.slice(startIdx, i + 1);
                
                const avgXgFor = window.reduce((sum, m) => sum + m.xg_for, 0) / window.length;
                const avgXgAgainst = window.reduce((sum, m) => sum + m.xg_against, 0) / window.length;
                
                xgForRolling.push(avgXgFor);
                xgAgainstRolling.push(avgXgAgainst);
                
                const vs = matches[i].is_home ? 'vs' : '@';
                labels.push(`${vs} ${matches[i].opponent.substring(0, 10)}`);
            }
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'xG For (Rolling Avg)',
                            data: xgForRolling,
                            borderColor: colors.xgFor,
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'xG Against (Rolling Avg)',
                            data: xgAgainstRolling,
                            borderColor: colors.xgAgainst,
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 },
                                color: colors.chartText
                            }
                        },
                        title: {
                            display: true,
                            text: `${teamName} - Rolling 5-Match xG Trend`,
                            font: { size: 12, weight: 'bold' },
                            color: colors.chartText
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const match = matches[idx];
                                    const vs = match.is_home ? 'vs' : '@';
                                    const result = match.result || 'N/A';
                                    const score = match.score || '';
                                    return `${vs} ${match.opponent} ${score ? '(' + score + ')' : ''} - ${result}`;
                                },
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const match = matches[idx];
                                    const rollingAvg = context.parsed.y.toFixed(2);
                                    const actualXg = context.datasetIndex === 0 ? match.xg_for.toFixed(2) : match.xg_against.toFixed(2);
                                    const metric = context.datasetIndex === 0 ? 'xGF' : 'xGA';
                                    return [
                                        `Rolling Avg: ${rollingAvg}`,
                                        `This Match ${metric}: ${actualXg}`
                                    ];
                                },
                                footer: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const xgFor = xgForRolling[idx];
                                    const xgAgainst = xgAgainstRolling[idx];
                                    if (xgFor > xgAgainst) {
                                        return '‚úÖ Good form (Creating > Conceding)';
                                    } else if (xgAgainst > xgFor) {
                                        return '‚ùå Struggling (Conceding > Creating)';
                                    } else {
                                        return '‚öñÔ∏è Balanced';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Expected Goals per Game',
                                font: { size: 11, weight: 'bold' },
                                color: colors.chartText
                            },
                            ticks: {
                                font: { size: 10 },
                                color: colors.chartText
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return isDarkTheme() ? 'rgba(148, 163, 184, 0.3)' : 'rgba(0, 0, 0, 0.3)';
                                    }
                                    return colors.chartGrid;
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                color: colors.chartText
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Fuzzy team name normalization for logo matching (league-gated to prevent cross-league collisions)
        function fuzzyNormalizeTeamName(apiName, league) {
            apiName = apiName.trim();
            const lower = apiName.toLowerCase();
            
            // Normalize league identifier to handle variations (remove spaces for matching)
            const leagueLower = (league || '').toLowerCase().replace(/\s+/g, '');  // Remove all spaces
            const isPremierLeague = leagueLower.includes('premier') || leagueLower === 'epl';
            const isLaLiga = leagueLower.includes('laliga') || leagueLower.includes('spain') || leagueLower.includes('primera') || leagueLower === 'pd';
            const isBundesliga = leagueLower.includes('bundesliga') || leagueLower.includes('germany') || leagueLower === 'bl1';
            const isSerieA = leagueLower.includes('seriea') || leagueLower.includes('italy') || leagueLower === 'sa';
            const isLigue1 = leagueLower.includes('ligue1') || leagueLower.includes('ligue') || leagueLower.includes('france') || leagueLower === 'fl1';
            
            // League-specific patterns to avoid cross-league collisions (e.g., Inter Miami vs Inter Milan)
            const patterns = [
                // Bundesliga teams
                { test: /^bayern/i, result: 'FC Bayern M√ºnchen', leagues: [isBundesliga] },
                { test: /^dortmund|^bvb$/i, result: 'Borussia Dortmund', leagues: [isBundesliga] },
                { test: /^(?:rb\s+)?leipzig$/i, result: 'RB Leipzig', leagues: [isBundesliga] },
                { test: /^leverkusen|^bayer$/i, result: 'Bayer 04 Leverkusen', leagues: [isBundesliga] },
                { test: /^(?:union\s+)?berlin$/i, result: '1. FC Union Berlin', leagues: [isBundesliga] },
                { test: /^freiburg|^sc\s+freiburg$/i, result: 'SC Freiburg', leagues: [isBundesliga] },
                { test: /^frankfurt|^eintracht$/i, result: 'Eintracht Frankfurt', leagues: [isBundesliga] },
                { test: /^gladbach|^m.?gladbach|^borussia\s+m/i, result: 'Borussia M√∂nchengladbach', leagues: [isBundesliga] },
                { test: /^wolfsburg|^vfl\s+wolfsburg$/i, result: 'VfL Wolfsburg', leagues: [isBundesliga] },
                { test: /^stuttgart|^vfb$/i, result: 'VfB Stuttgart', leagues: [isBundesliga] },
                { test: /^hoffenheim|^tsg$/i, result: 'TSG 1899 Hoffenheim', leagues: [isBundesliga] },
                { test: /^mainz|^fsv\s+mainz$/i, result: '1. FSV Mainz 05', leagues: [isBundesliga] },
                { test: /^(?:sv\s+)?(?:werder\s+)?bremen$/i, result: 'SV Werder Bremen', leagues: [isBundesliga] },
                { test: /^augsburg|^fc\s+augsburg$/i, result: 'FC Augsburg', leagues: [isBundesliga] },
                { test: /^bochum|^vfl\s+bochum$/i, result: 'VfL Bochum 1848', leagues: [isBundesliga] },
                { test: /^heidenheim|^fc\s+heidenheim$/i, result: '1. FC Heidenheim 1846', leagues: [isBundesliga] },
                { test: /^st\.?\s+pauli|^pauli$/i, result: 'FC St. Pauli', leagues: [isBundesliga] },
                
                // La Liga teams
                { test: /^bar[c√ß]a|^barcelona/i, result: 'FC Barcelona', leagues: [isLaLiga] },
                { test: /^real\s+madrid/i, result: 'Real Madrid CF', leagues: [isLaLiga] },
                { test: /^atl[e√©]tico\s+madrid/i, result: 'Atl√©tico de Madrid', leagues: [isLaLiga] },
                { test: /^sevilla$/i, result: 'Sevilla FC', leagues: [isLaLiga] },
                { test: /^valencia$/i, result: 'Valencia CF', leagues: [isLaLiga] },
                { test: /^(?:real\s+)?betis$/i, result: 'Real Betis', leagues: [isLaLiga] },
                { test: /^villarreal$/i, result: 'Villarreal CF', leagues: [isLaLiga] },
                { test: /^athletic|^bilbao$/i, result: 'Athletic Club', leagues: [isLaLiga] },
                { test: /^(?:real\s+)?sociedad$/i, result: 'Real Sociedad', leagues: [isLaLiga] },
                { test: /^getafe$/i, result: 'Getafe CF', leagues: [isLaLiga] },
                { test: /^espanyol$/i, result: 'RCD Espanyol', leagues: [isLaLiga] },
                { test: /^celta|^vigo$/i, result: 'RC Celta de Vigo', leagues: [isLaLiga] },
                
                // Serie A teams (Inter/Milan only for Serie A to avoid Inter Miami collision)
                { test: /^inter(?:\s+milan)?$/i, result: 'FC Internazionale Milano', leagues: [isSerieA] },
                { test: /^(?:ac\s+)?milan$/i, result: 'AC Milan', leagues: [isSerieA] },
                { test: /^juve|^juventus/i, result: 'Juventus FC', leagues: [isSerieA] },
                { test: /^roma|^as\s+roma$/i, result: 'AS Roma', leagues: [isSerieA] },
                { test: /^napoli|^ssc\s+napoli$/i, result: 'SSC Napoli', leagues: [isSerieA] },
                { test: /^lazio|^ss\s+lazio$/i, result: 'SS Lazio', leagues: [isSerieA] },
                { test: /^atalanta$/i, result: 'Atalanta BC', leagues: [isSerieA] },
                { test: /^fiorentina$/i, result: 'ACF Fiorentina', leagues: [isSerieA] },
                { test: /^torino$/i, result: 'Torino FC', leagues: [isSerieA] },
                { test: /^bologna$/i, result: 'Bologna FC 1909', leagues: [isSerieA] },
                
                // Ligue 1 teams (PSG only for Ligue 1 to avoid Paris FC collision)
                { test: /^psg$|^paris\s+saint/i, result: 'Paris Saint-Germain', leagues: [isLigue1] },
                { test: /^marseille|^om$/i, result: 'Olympique de Marseille', leagues: [isLigue1] },
                { test: /^lyon|^ol$/i, result: 'Olympique Lyonnais', leagues: [isLigue1] },
                { test: /^monaco|^as\s+monaco$/i, result: 'AS Monaco', leagues: [isLigue1] },
                { test: /^lille|^losc$/i, result: 'LOSC Lille', leagues: [isLigue1] },
                { test: /^nice|^ogc\s+nice$/i, result: 'OGC Nice', leagues: [isLigue1] },
                { test: /^lens|^rc\s+lens$/i, result: 'RC Lens', leagues: [isLigue1] },
                { test: /^rennes|^stade\s+rennais$/i, result: 'Stade Rennais FC', leagues: [isLigue1] },
                
                // Premier League teams
                { test: /^arsenal$/i, result: 'Arsenal FC', leagues: [isPremierLeague] },
                { test: /^liverpool$/i, result: 'Liverpool FC', leagues: [isPremierLeague] },
                { test: /^chelsea$/i, result: 'Chelsea FC', leagues: [isPremierLeague] },
                { test: /^(?:man(?:chester)?\s+)?city$/i, result: 'Manchester City', leagues: [isPremierLeague] },
                { test: /^(?:man(?:chester)?\s+)?united$/i, result: 'Manchester United', leagues: [isPremierLeague] },
                { test: /^tottenham|^spurs$/i, result: 'Tottenham Hotspur', leagues: [isPremierLeague] },
                { test: /^newcastle/i, result: 'Newcastle United', leagues: [isPremierLeague] },
                { test: /^west\s+ham/i, result: 'West Ham United', leagues: [isPremierLeague] },
                { test: /^aston\s+villa$/i, result: 'Aston Villa', leagues: [isPremierLeague] },
                { test: /^brighton/i, result: 'Brighton & Hove Albion', leagues: [isPremierLeague] },
                { test: /^(?:afc\s+)?bournemouth$/i, result: 'AFC Bournemouth', leagues: [isPremierLeague] },
                { test: /^wolves|^wolverhampton/i, result: 'Wolverhampton Wanderers', leagues: [isPremierLeague] },
                { test: /^everton$/i, result: 'Everton FC', leagues: [isPremierLeague] },
                { test: /^brentford$/i, result: 'Brentford FC', leagues: [isPremierLeague] },
                { test: /^fulham$/i, result: 'Fulham FC', leagues: [isPremierLeague] },
                { test: /^crystal\s+palace$/i, result: 'Crystal Palace', leagues: [isPremierLeague] },
                { test: /^nottingham\s+forest$/i, result: 'Nottingham Forest', leagues: [isPremierLeague] },
                { test: /^southampton$/i, result: 'Southampton FC', leagues: [isPremierLeague] },
                { test: /^leicester/i, result: 'Leicester City', leagues: [isPremierLeague] },
                { test: /^ipswich/i, result: 'Ipswich Town', leagues: [isPremierLeague] },
                { test: /^burnley$/i, result: 'Burnley FC', leagues: [isPremierLeague] },
            ];
            
            // Check pattern matches with league gating
            for (const pattern of patterns) {
                // Only apply pattern if ANY of the league conditions match
                const leagueMatches = pattern.leagues.some(condition => condition === true);
                if (leagueMatches && pattern.test.test(apiName)) {
                    return pattern.result;
                }
            }
            
            // If no pattern matched, return original (safe fallback)
            return apiName;
        }
        
        // Team name to filename mapping (Odds API name ‚Üí GitHub filename)
        function normalizeTeamNameForLogo(teamName) {
            const nameMap = {
                // Premier League
                'Arsenal': 'Arsenal FC',
                'Liverpool': 'Liverpool FC',
                'Manchester United': 'Manchester United',
                'Manchester City': 'Manchester City',
                'Chelsea': 'Chelsea FC',
                'Tottenham': 'Tottenham Hotspur',
                'Tottenham Hotspur': 'Tottenham Hotspur',
                'Newcastle': 'Newcastle United',
                'Newcastle United': 'Newcastle United',
                'Aston Villa': 'Aston Villa',
                'Brighton': 'Brighton & Hove Albion',
                'Brighton & Hove Albion': 'Brighton & Hove Albion',
                'West Ham': 'West Ham United',
                'West Ham United': 'West Ham United',
                'Everton': 'Everton FC',
                'Brentford': 'Brentford FC',
                'Fulham': 'Fulham FC',
                'Crystal Palace': 'Crystal Palace',
                'AFC Bournemouth': 'AFC Bournemouth',
                'Bournemouth': 'AFC Bournemouth',
                'Wolves': 'Wolverhampton Wanderers',
                'Wolverhampton': 'Wolverhampton Wanderers',
                'Nottingham Forest': 'Nottingham Forest',
                'Southampton': 'Southampton FC',
                'Leicester': 'Leicester City',
                'Leicester City': 'Leicester City',
                'Ipswich': 'Ipswich Town',
                'Ipswich Town': 'Ipswich Town',
                'Burnley': 'Burnley FC',
                // La Liga
                'Barcelona': 'FC Barcelona',
                'FC Barcelona': 'FC Barcelona',
                'Bar√ßa': 'FC Barcelona',
                'Real Madrid': 'Real Madrid CF',
                'Madrid': 'Real Madrid CF',
                'Atletico Madrid': 'Atl√©tico de Madrid',
                'Atl√©tico Madrid': 'Atl√©tico de Madrid',
                'Atleti': 'Atl√©tico de Madrid',
                'Sevilla': 'Sevilla FC',
                'Valencia': 'Valencia CF',
                'Real Betis': 'Real Betis',
                'Betis': 'Real Betis',
                'Villarreal': 'Villarreal CF',
                'Athletic Bilbao': 'Athletic Club',
                'Athletic Club': 'Athletic Club',
                'Real Sociedad': 'Real Sociedad',
                'Sociedad': 'Real Sociedad',
                'Getafe': 'Getafe CF',
                'Espanyol': 'RCD Espanyol',
                'Celta Vigo': 'RC Celta de Vigo',
                'Celta': 'RC Celta de Vigo',
                // Bundesliga
                'Bayern Munich': 'FC Bayern M√ºnchen',
                'Bayern M√ºnchen': 'FC Bayern M√ºnchen',
                'Bayern': 'FC Bayern M√ºnchen',
                'Borussia Dortmund': 'Borussia Dortmund',
                'Dortmund': 'Borussia Dortmund',
                'RB Leipzig': 'RB Leipzig',
                'Leipzig': 'RB Leipzig',
                'Bayer Leverkusen': 'Bayer 04 Leverkusen',
                'Leverkusen': 'Bayer 04 Leverkusen',
                'Union Berlin': '1. FC Union Berlin',
                'Freiburg': 'SC Freiburg',
                'Eintracht Frankfurt': 'Eintracht Frankfurt',
                'Frankfurt': 'Eintracht Frankfurt',
                'Borussia M√∂nchengladbach': 'Borussia M√∂nchengladbach',
                "Borussia M'Gladbach": 'Borussia M√∂nchengladbach',
                'Gladbach': 'Borussia M√∂nchengladbach',
                'VfL Wolfsburg': 'VfL Wolfsburg',
                'Wolfsburg': 'VfL Wolfsburg',
                'VfB Stuttgart': 'VfB Stuttgart',
                'Stuttgart': 'VfB Stuttgart',
                'TSG 1899 Hoffenheim': 'TSG 1899 Hoffenheim',
                'TSG Hoffenheim': 'TSG 1899 Hoffenheim',
                'Hoffenheim': 'TSG 1899 Hoffenheim',
                '1. FSV Mainz 05': '1. FSV Mainz 05',
                'Mainz': '1. FSV Mainz 05',
                'SV Werder Bremen': 'SV Werder Bremen',
                'Werder Bremen': 'SV Werder Bremen',
                'Bremen': 'SV Werder Bremen',
                'FC Augsburg': 'FC Augsburg',
                'Augsburg': 'FC Augsburg',
                'VfL Bochum 1848': 'VfL Bochum 1848',
                'VfL Bochum': 'VfL Bochum 1848',
                'Bochum': 'VfL Bochum 1848',
                '1. FC Heidenheim 1846': '1. FC Heidenheim 1846',
                'FC Heidenheim': '1. FC Heidenheim 1846',
                'Heidenheim': '1. FC Heidenheim 1846',
                'FC St. Pauli': 'FC St. Pauli',
                'St. Pauli': 'FC St. Pauli',
                // Serie A
                'Juventus': 'Juventus FC',
                'Juve': 'Juventus FC',
                'Inter': 'FC Internazionale Milano',
                'Inter Milan': 'FC Internazionale Milano',
                'Internazionale': 'FC Internazionale Milano',
                'AC Milan': 'AC Milan',
                'Milan': 'AC Milan',
                'Roma': 'AS Roma',
                'AS Roma': 'AS Roma',
                'Napoli': 'SSC Napoli',
                'SSC Napoli': 'SSC Napoli',
                'Lazio': 'SS Lazio',
                'SS Lazio': 'SS Lazio',
                'Atalanta': 'Atalanta BC',
                'Atalanta BC': 'Atalanta BC',
                'Fiorentina': 'ACF Fiorentina',
                'ACF Fiorentina': 'ACF Fiorentina',
                'Torino': 'Torino FC',
                'Bologna': 'Bologna FC 1909',
                // Ligue 1
                'Paris Saint-Germain': 'Paris Saint-Germain',
                'Paris Saint Germain': 'Paris Saint-Germain',
                'PSG': 'Paris Saint-Germain',
                'Marseille': 'Olympique de Marseille',
                'OM': 'Olympique de Marseille',
                'Olympique Marseille': 'Olympique de Marseille',
                'Lyon': 'Olympique Lyonnais',
                'OL': 'Olympique Lyonnais',
                'Olympique Lyon': 'Olympique Lyonnais',
                'Monaco': 'AS Monaco',
                'AS Monaco': 'AS Monaco',
                'Lille': 'LOSC Lille',
                'LOSC': 'LOSC Lille',
                'Nice': 'OGC Nice',
                'OGC Nice': 'OGC Nice',
                'Lens': 'RC Lens',
                'RC Lens': 'RC Lens',
                'Rennes': 'Stade Rennais FC',
                'Stade Rennais': 'Stade Rennais FC'
            };
            
            return nameMap[teamName] || teamName;
        }
        
        // Team logo helper function
        function getTeamLogoUrl(teamName, league) {
            const leagueMap = {
                'Premier League': 'England - Premier League',
                'EPL': 'England - Premier League',
                'English Premier League': 'England - Premier League',
                'La Liga': 'Spain - LaLiga',
                'Spanish La Liga': 'Spain - LaLiga',
                'Spain La Liga': 'Spain - LaLiga',
                'Bundesliga': 'Germany - Bundesliga',
                'German Bundesliga': 'Germany - Bundesliga',
                'Germany Bundesliga': 'Germany - Bundesliga',
                'Serie A': 'Italy - Serie A',
                'Italian Serie A': 'Italy - Serie A',
                'Italy Serie A': 'Italy - Serie A',
                'Ligue 1': 'France - Ligue 1',
                'French Ligue 1': 'France - Ligue 1',
                'France Ligue 1': 'France - Ligue 1',
                'Ligue 1 - France': 'France - Ligue 1',
                'UEFA Champions League': null,  // No CL folder, teams fallback to domestic league
                'Champions League': null,
                'UEFA Europa League': null,
                'Europa League': null
            };
            
            const leagueFolder = leagueMap[league];
            if (!leagueFolder) {
                // For UEFA competitions, we don't have logos available
                return '';
            }
            
            // Try pattern-based fuzzy normalization first
            let normalizedTeamName = fuzzyNormalizeTeamName(teamName, league);
            
            // If fuzzy didn't change it, try the explicit mapping table
            if (normalizedTeamName === teamName) {
                normalizedTeamName = normalizeTeamNameForLogo(teamName);
            }
            
            // Encode team name for URL (keep spaces, &, etc. as they appear in filenames)
            const teamFileName = encodeURIComponent(normalizedTeamName + '.png');
            
            return `https://raw.githubusercontent.com/luukhopman/football-logos/master/logos/${encodeURIComponent(leagueFolder)}/${teamFileName}`;
        }
        
        // Calculate WCAG contrast ratio
        function getContrastRatio(rgb1, rgb2) {
            const lum1 = 0.2126 * Math.pow(rgb1[0]/255, 2.2) + 0.7152 * Math.pow(rgb1[1]/255, 2.2) + 0.0722 * Math.pow(rgb1[2]/255, 2.2);
            const lum2 = 0.2126 * Math.pow(rgb2[0]/255, 2.2) + 0.7152 * Math.pow(rgb2[1]/255, 2.2) + 0.0722 * Math.pow(rgb2[2]/255, 2.2);
            const lighter = Math.max(lum1, lum2);
            const darker = Math.min(lum1, lum2);
            return (lighter + 0.05) / (darker + 0.05);
        }
        
        // Helper function to ensure color has proper contrast by adjusting the color
        function ensureColorContrast(color, isDark) {
            if (!color) return { color: null, shadow: '' };
            
            // Convert hex to RGB
            const hex = color.replace('#', '');
            let r = parseInt(hex.substr(0, 2), 16);
            let g = parseInt(hex.substr(2, 2), 16);
            let b = parseInt(hex.substr(4, 2), 16);
            
            // Background colors
            const lightBg = [248, 250, 252]; // #f8fafc
            const darkBg = [30, 41, 59]; // #1e293b
            const bgColor = isDark ? darkBg : lightBg;
            
            // Check initial contrast ratio
            let contrastRatio = getContrastRatio([r, g, b], bgColor);
            
            // If contrast is already good, return original color
            if (contrastRatio >= 4.5) {
                return { color: color, shadow: '' };
            }
            
            // Iteratively adjust color until contrast ‚â•4.5:1
            const maxIterations = 30;
            for (let i = 0; i < maxIterations && contrastRatio < 4.5; i++) {
                if (isDark) {
                    // In dark mode, lighten by adding (works for black)
                    r = Math.min(255, r + 15);
                    g = Math.min(255, g + 15);
                    b = Math.min(255, b + 15);
                } else {
                    // In light mode, darken by subtracting
                    r = Math.max(0, r - 15);
                    g = Math.max(0, g - 15);
                    b = Math.max(0, b - 15);
                }
                contrastRatio = getContrastRatio([r, g, b], bgColor);
            }
            
            // Convert adjusted RGB back to hex
            const toHex = (val) => val.toString(16).padStart(2, '0');
            const adjustedColor = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            
            return { color: adjustedColor, shadow: '' };
        }
        
        // Get team brand color based on team name
        function getTeamBrandColor(teamName) {
            const teamColors = {
                // Premier League
                'Manchester United': '#DA291C',
                'Man United': '#DA291C',
                'Manchester City': '#6CABDD',
                'Man City': '#6CABDD',
                'Liverpool': '#C8102E',
                'Chelsea': '#034694',
                'Arsenal': '#EF0107',
                'Tottenham': '#132257',
                'Tottenham Hotspur': '#132257',
                'Spurs': '#132257',
                'Newcastle': '#241F20',
                'Newcastle United': '#241F20',
                'West Ham': '#7A263A',
                'West Ham United': '#7A263A',
                'Aston Villa': '#95BFE5',
                'Brighton': '#0057B8',
                'Everton': '#003399',
                'Leicester': '#003090',
                'Leicester City': '#003090',
                'Wolves': '#FDB913',
                'Wolverhampton': '#FDB913',
                'Crystal Palace': '#1B458F',
                'Fulham': '#000000',
                'Brentford': '#E30613',
                'Southampton': '#D71920',
                'Nottingham Forest': '#DD0000',
                'Bournemouth': '#DA291C',
                'Ipswich': '#3050A0',
                'Ipswich Town': '#3050A0',
                'Burnley': '#6C1D45',  // Claret
                'Burnley FC': '#6C1D45',
                
                // La Liga
                'Real Madrid': '#FEBE10',
                'Barcelona': '#A50044',
                'Atletico Madrid': '#CB3524',
                'Atl√©tico Madrid': '#CB3524',
                'Sevilla': '#D62123',
                'Valencia': '#EE3524',
                'Real Sociedad': '#0A3AB9',
                'Real Betis': '#00954C',
                'Villarreal': '#FFE667',
                'Athletic Bilbao': '#EE2523',
                'Celta Vigo': '#83C1EB',
                'Espanyol': '#007BC7',
                'Getafe': '#005999',
                'Osasuna': '#D21F3C',
                'Rayo Vallecano': '#E4002B',
                'Mallorca': '#E20613',
                'Las Palmas': '#FFED00',
                'Girona': '#CC0000',
                
                // Bundesliga
                'Bayern Munich': '#DC052D',
                'Borussia Dortmund': '#FDE100',
                'Dortmund': '#FDE100',
                'RB Leipzig': '#DD0741',
                'Bayer Leverkusen': '#E32221',
                'Borussia Monchengladbach': '#000000',
                'Eintracht Frankfurt': '#E1000F',
                'VfL Wolfsburg': '#65B32E',
                'Union Berlin': '#EB1923',
                'SC Freiburg': '#E2001A',
                'Hoffenheim': '#1961B5',
                'VfB Stuttgart': '#E32219',
                'Mainz': '#C3151C',
                'Werder Bremen': '#1D9053',
                
                // Serie A
                'Juventus': '#000000',
                'Inter Milan': '#0068A8',
                'Inter': '#0068A8',
                'AC Milan': '#FB090B',
                'Milan': '#FB090B',
                'Napoli': '#00569F',
                'Roma': '#FCC44A',
                'AS Roma': '#FCC44A',
                'Lazio': '#87D8F7',
                'Atalanta': '#003171',
                'Fiorentina': '#6C2F8A',
                'Torino': '#8B1D1C',
                'Genoa': '#A81F31',
                'Sampdoria': '#003C80',
                'Udinese': '#000000',
                'Bologna': '#004A98',
                'Sassuolo': '#006838',
                'Hellas Verona': '#0F52A0',
                'Cagliari': '#D0011B',
                'Empoli': '#005EB8',
                
                // Ligue 1
                'Paris Saint Germain': '#004170',
                'PSG': '#004170',
                'Marseille': '#2FAEE0',
                'Monaco': '#C8102E',
                'AS Monaco': '#C8102E',
                'Lyon': '#DA020E',
                'Lille': '#E30613',
                'Nice': '#ED1C2E',
                'Rennes': '#E30513',
                'Lens': '#FFC627',
                'Montpellier': '#F39200',
                'Nantes': '#FEF100',
                'Strasbourg': '#009CDE',
                'Reims': '#E30613',
                'Brest': '#E30613',
                'Toulouse': '#411E5E',
                
                // Champions League / Europa teams
                'Ajax': '#D2122E',
                'Benfica': '#E30613',
                'Porto': '#003D8F',
                'Sporting CP': '#006940',
                'Celtic': '#009B48',
                'Rangers': '#0F47AF',
                'PSV': '#ED1B2E'
            };
            
            return teamColors[teamName] || null;
        }
        
        // Global functions for onclick access (must be outside DOMContentLoaded)
        function showMatchContextButton(match) {
            const matchContext = document.getElementById('match-context');
            if (!match || !match.league) {
                matchContext.innerHTML = '<p class="text-muted">Match context unavailable</p>';
                return;
            }
            
            matchContext.innerHTML = `
                <div class="text-center py-3">
                    <button class="btn btn-primary btn-lg" onclick="loadMatchContext(currentMatchData)">
                        <i class="fas fa-chart-bar me-2"></i>Show Match Context
                    </button>
                    <p class="text-muted small mt-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>League standings, team form, xG metrics & PPDA
                    </p>
                </div>
            `;
        }
        
        function updateProgressStatus(message, icon = 'spinner fa-spin') {
            const matchContext = document.getElementById('match-context');
            matchContext.innerHTML = `
                <div class="text-center py-3">
                    <div class="mb-2">
                        <i class="fas fa-${icon} fa-2x text-primary"></i>
                    </div>
                    <p class="text-muted mb-0">${message}</p>
                </div>
            `;
        }
        
        function loadMatchContext(match) {
            const matchContext = document.getElementById('match-context');
            if (!match || !match.league) {
                matchContext.innerHTML = '<p class="text-muted">Match context unavailable</p>';
                return;
            }
            
            // Clear xG data from previous match to prevent stale data
            currentXgData = null;
            
            // Show initial progress
            updateProgressStatus('üîç Initiating data fetch...', 'search');
            
            // Use league_code from match data (added in odds_api_client.py)
            const leagueCode = match.league_code || match.league;
            
            // Fallback mapping for older data without league_code
            const leagueMapFallback = {
                'UEFA Champions League': 'CL',
                'EPL': 'PL',
                'Premier League': 'PL',
                'English Premier League': 'PL',
                'La Liga': 'PD',
                'Spanish La Liga': 'PD',
                'Spain La Liga': 'PD',
                'La Liga - Spain': 'PD',
                'Bundesliga': 'BL1',
                'German Bundesliga': 'BL1',
                'Germany Bundesliga': 'BL1',
                'Serie A': 'SA',
                'Italian Serie A': 'SA',
                'Italy Serie A': 'SA',
                'Ligue 1': 'FL1',
                'French Ligue 1': 'FL1',
                'France Ligue 1': 'FL1',
                'Ligue 1 - France': 'FL1',
                'UEFA Europa League': 'EL'
            };
            
            // Apply fallback mapping if league code is a display name
            const finalLeagueCode = leagueMapFallback[leagueCode] || leagueCode;
            
            // Update progress: Fetching from Understat
            setTimeout(() => updateProgressStatus('üìä Fetching standings from Understat...', 'database'), 100);
            
            // Add timeout to prevent endless loading (increased to 40s for Understat)
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 40000)
            );
            
            // Start context fetch
            const contextFetch = fetch(`/match/${match.id}/context?league=${finalLeagueCode}&home_team=${encodeURIComponent(match.home_team)}&away_team=${encodeURIComponent(match.away_team)}`)
                .then(r => r.json())
                .then(data => {
                    updateProgressStatus('üìà Calculating xG metrics from FBref...', 'chart-line');
                    return data;
                });
            
            // Start xG fetch after context starts
            const xgFetch = fetch(`/match/${match.id}/xg?league=${finalLeagueCode}&home_team=${encodeURIComponent(match.home_team)}&away_team=${encodeURIComponent(match.away_team)}`)
                .then(r => r.json())
                .then(data => {
                    updateProgressStatus('üéØ Processing PPDA coefficients...', 'bullseye');
                    return data;
                });
            
            // Fetch both standings context and xG data in parallel with timeout
            Promise.race([
                Promise.all([contextFetch, xgFetch]),
                timeoutPromise
            ])
            .then(([contextData, xgData]) => {
                updateProgressStatus('‚ú® Finalizing data...', 'check-circle');
                
                if (contextData.error) {
                    matchContext.innerHTML = `<p class="text-muted">${contextData.narrative || 'Context unavailable'}</p>`;
                    return;
                }
                
                // Merge xG data into context data
                contextData.xg = xgData.xg || null;
                
                setTimeout(() => displayMatchContextData(contextData), 300);
            })
            .catch(error => {
                console.error('Error loading context:', error);
                const errorMsg = error.message === 'Request timeout' 
                    ? 'Match context loading timed out after 40 seconds. Please try again.' 
                    : 'Unable to load match context';
                matchContext.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>${errorMsg}
                        <button class="btn btn-sm btn-outline-primary mt-2 d-block" onclick="loadMatchContext(currentMatchData)">
                            <i class="fas fa-redo me-1"></i>Retry
                        </button>
                    </div>
                `;
            });
        }
        
        function displayMatchContextData(contextData) {
            const matchContext = document.getElementById('match-context');
            let html = '';
            
            if (contextData.narrative) {
                const alertClass = contextData.has_data ? 'alert-info' : 'alert-warning';
                const icon = contextData.has_data ? 'fa-info-circle' : 'fa-exclamation-triangle';
                html += `<div class="alert ${alertClass} mb-3 small"><i class="fas ${icon} me-2"></i>${contextData.narrative}</div>`;
            }
            
            const hasHomeData = contextData.home_team && (contextData.home_team.position || contextData.home_team.points || contextData.home_team.form);
            const hasAwayData = contextData.away_team && (contextData.away_team.position || contextData.away_team.points || contextData.away_team.form);
            
            if (hasHomeData || hasAwayData) {
                html += `<div class="row">`;
                
                // Home team column
                html += `<div class="col-md-6 ${hasAwayData ? 'border-end' : ''}">`;
                const homeLogoUrl = getTeamLogoUrl(currentMatchData.home_team, currentMatchData.league);
                const homeBrandColor = getTeamBrandColor(currentMatchData.home_team);
                const homeColorData = homeBrandColor ? ensureColorContrast(homeBrandColor, isDarkTheme()) : { color: 'var(--primary-color)', shadow: '' };
                html += `<h6 class="fw-bold mb-2" style="color: ${homeColorData.color}; ${homeColorData.shadow}"><i class="fas fa-home me-1"></i><img src="${homeLogoUrl}" alt="${currentMatchData.home_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.home_team}</h6>`;
                
                // Add home team stats...
                if (hasHomeData) {
                    html += displayTeamStats(contextData.home_team, contextData.xg?.home_stats);
                } else {
                    html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                }
                html += `</div>`;
                
                // Away team column
                html += `<div class="col-md-6">`;
                const awayLogoUrl = getTeamLogoUrl(currentMatchData.away_team, currentMatchData.league);
                const awayBrandColor = getTeamBrandColor(currentMatchData.away_team);
                const awayColorData = awayBrandColor ? ensureColorContrast(awayBrandColor, isDarkTheme()) : { color: '#ef4444', shadow: '' };
                html += `<h6 class="fw-bold mb-2" style="color: ${awayColorData.color}; ${awayColorData.shadow}"><i class="fas fa-plane-departure me-1"></i><img src="${awayLogoUrl}" alt="${currentMatchData.away_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.away_team}</h6>`;
                
                if (hasAwayData) {
                    html += displayTeamStats(contextData.away_team, contextData.xg?.away_stats);
                } else {
                    html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                }
                html += `</div>`;
                html += `</div>`;
                
                // Add Elo predictions comparison if available
                if (contextData.elo_predictions) {
                    html += displayEloPredictionsComparison(contextData.elo_predictions, currentMatchData);
                }
                
                // Add xG trend charts
                if (contextData.xg) {
                    html += displayXgCharts(contextData.xg);
                }
            }
            
            matchContext.innerHTML = html;
            
            // Destroy old charts if they exist
            if (window.homeXgChart) {
                window.homeXgChart.destroy();
                window.homeXgChart = null;
            }
            if (window.awayXgChart) {
                window.awayXgChart.destroy();
                window.awayXgChart = null;
            }
            
            // Create xG trend charts if data available
            if (contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0) {
                window.homeXgChart = createXgTrendChart('home-xg-chart', contextData.xg.home_stats.recent_matches, currentMatchData.home_team);
            }
            if (contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0) {
                window.awayXgChart = createXgTrendChart('away-xg-chart', contextData.xg.away_stats.recent_matches, currentMatchData.away_team);
            }
            
            // Tooltips will be auto-initialized by the global MutationObserver
        }
        
        function formatFormWithOpponents(recentMatches) {
            if (!recentMatches || recentMatches.length === 0) return '';
            
            // Display chronologically: oldest first (GW1) to newest (GW5)
            // Matches come in reverse order (newest first), so reverse them
            const chronologicalMatches = [...recentMatches].reverse();
            
            const formItems = chronologicalMatches.map((match, index) => {
                const indicator = match.result === 'W' ? 'üü©' : match.result === 'D' ? '‚¨ú' : 'üü•';
                const homeAwayIcon = match.is_home ? 'üè†' : '‚úàÔ∏è';
                const opponent = match.opponent || 'Unknown';
                // Truncate long opponent names
                const displayOpponent = opponent.length > 15 ? opponent.substring(0, 13) + '...' : opponent;
                // Only show gameweek if actual data exists (no fake fallback)
                const gwDisplay = match.gameweek ? `GW${match.gameweek} ` : '';
                
                return `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 0; font-size: 0.85rem;">${indicator} ${homeAwayIcon} ${gwDisplay}vs ${displayOpponent}</div>`;
            });
            
            return `<div style="line-height: 1.3;">${formItems.join('')}</div>`;
        }
        
        function displayTeamStats(teamData, xgStats) {
            let html = `<div class="match-context-grid">`;
            if (teamData.position) {
                html += `<div class="match-context-label">Position:</div><div class="match-context-value"><span class="badge bg-secondary">${teamData.position}</span></div>`;
            }
            if (teamData.points !== null && teamData.points !== undefined) {
                html += `<div class="match-context-label">Points:</div><div class="match-context-value"><strong>${teamData.points}</strong></div>`;
            }
            
            // Form display: Use FBref with opponents if available, fallback to Understat
            const hasFBrefForm = xgStats && xgStats.recent_matches && xgStats.recent_matches.length > 0;
            if (hasFBrefForm) {
                const formDisplay = formatFormWithOpponents(xgStats.recent_matches);
                html += `<div class="match-context-label">Form: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Last 5 match results from FBref with opponents (üü© Win, ‚¨ú Draw, üü• Loss)" style="cursor: help; font-size: 0.8em;"></i></div><div class="match-context-value">${formDisplay}</div>`;
            } else if (teamData.form) {
                // Fallback to Understat form if FBref unavailable
                html += `<div class="match-context-label">Form:</div><div class="match-context-value">${formatFormIndicators(teamData.form)}</div>`;
            }
            
            // Add Elo rating if available
            if (teamData.elo_rating !== null && teamData.elo_rating !== undefined) {
                const eloClass = teamData.elo_rating >= 1900 ? 'text-success' : teamData.elo_rating >= 1700 ? 'text-primary' : 'text-muted';
                html += `<div class="match-context-label">‚ö° Elo Rating: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="ClubElo.com rating based on historical performance from 2010 to present, updated twice daily (5am/5pm UTC). Ranges: 1900+ = Elite (top European clubs), 1700-1900 = Strong (Europa League quality), 1500-1700 = Average (mid-table), <1500 = Weak" style="cursor: help; font-size: 0.8em; min-width: 250px;"></i></div><div class="match-context-value ${eloClass}"><strong>${teamData.elo_rating.toFixed(0)}</strong></div>`;
            }
            
            // Add PPDA prominently if available
            if (teamData.ppda_coef !== null && teamData.ppda_coef !== undefined) {
                html += `<div style="grid-column: 1 / -1;"><hr class="my-1"></div>`;
                html += `<div class="match-context-label"><strong>üõ°Ô∏è PPDA:</strong> <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Passes Per Defensive Action - measures pressing intensity. <8.0 = Extreme High Press (Klopp/Guardiola style), 8-12 = High Press (modern attacking teams), 12-15 = Medium Press (balanced), 15-20 = Low/Passive Block (defensive teams), >20 = Extremely Passive (deep defending). Lower = more aggressive pressing." style="cursor: help; font-size: 0.8em; min-width: 250px;"></i></div><div class="match-context-value"><strong class="text-primary">${teamData.ppda_coef}</strong></div>`;
            }
            if (teamData.xG !== null && teamData.xG !== undefined) {
                const gamesPlayed = teamData.played || 0;
                const xgPerGame = gamesPlayed > 0 ? (teamData.xG / gamesPlayed).toFixed(2) : '0.00';
                
                // Build rich xG tooltip with attack strength analysis
                let xgTooltip = `üìä Season xG: ${teamData.xG.toFixed(1)} over ${gamesPlayed} games (${xgPerGame}/game)`;
                
                // Add attack rating and context
                if (teamData.attack_rating) {
                    const ratingEmoji = teamData.attack_rating === 'Elite' ? 'üî•' : teamData.attack_rating === 'Strong' ? 'üí™' : teamData.attack_rating === 'Average' ? '‚öΩ' : teamData.attack_rating === 'Weak' ? '‚ö†Ô∏è' : 'üìâ';
                    xgTooltip += `\n\n${ratingEmoji} Attack Strength: ${teamData.attack_rating}`;
                }
                
                // Add league ranking context
                if (teamData.xg_percentile !== null && teamData.xg_percentile !== undefined && teamData.position) {
                    const percentileRank = Math.round(teamData.xg_percentile);
                    const contextPhrase = percentileRank >= 75 ? 'Top attacking team' : percentileRank >= 50 ? 'Above average attack' : percentileRank >= 25 ? 'Below average attack' : 'Weak attack';
                    xgTooltip += `\nüìà League Rank: ${contextPhrase} (${percentileRank}th percentile)`;
                }
                
                // Add league comparison (HIGHER xG = BETTER attack)
                if (teamData.league_stats && teamData.league_stats.xg_mean) {
                    const leagueAvg = teamData.league_stats.xg_mean.toFixed(2);
                    const diff = parseFloat(xgPerGame) - parseFloat(leagueAvg);
                    const vsLeague = diff > 0 ? `+${diff.toFixed(2)} above avg ‚úÖ (stronger attack)` : diff < 0 ? `${diff.toFixed(2)} below avg ‚ö†Ô∏è (weaker attack)` : 'At league average';
                    xgTooltip += `\n‚öñÔ∏è vs League Avg (${leagueAvg}/game): ${vsLeague}`;
                }
                
                // Add trend indicator
                if (teamData.recent_trend) {
                    const trendEmoji = teamData.recent_trend === 'above' ? 'üìà' : teamData.recent_trend === 'below' ? 'üìâ' : '‚û°Ô∏è';
                    const trendText = teamData.recent_trend === 'above' ? 'Recent form ABOVE season average' : teamData.recent_trend === 'below' ? 'Recent form BELOW season average' : 'Recent form matches season average';
                    xgTooltip += `\n${trendEmoji} Trend: ${trendText}`;
                }
                
                // Add match impact prediction
                xgTooltip += `\n\nüí° Impact: ${parseFloat(xgPerGame) >= 1.8 ? 'High goal threat - expect multiple chances' : parseFloat(xgPerGame) >= 1.2 ? 'Decent attacking threat - should create chances' : parseFloat(xgPerGame) >= 0.8 ? 'Moderate threat - limited chances expected' : 'Low scoring threat - struggle to create'}`;
                
                html += `<div class="match-context-label">Season xG: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${xgTooltip}" style="cursor: help; font-size: 0.8em; min-width: 250px;"></i></div><div class="match-context-value"><strong>${teamData.xG.toFixed(1)}</strong></div>`;
            }
            if (teamData.xGA !== null && teamData.xGA !== undefined) {
                const gamesPlayed = teamData.played || 0;
                const xgaPerGame = gamesPlayed > 0 ? (teamData.xGA / gamesPlayed).toFixed(2) : '0.00';
                
                // Build rich xGA tooltip with defensive strength analysis (LOWER is BETTER for defense)
                let xgaTooltip = `üõ°Ô∏è Season xGA: ${teamData.xGA.toFixed(1)} over ${gamesPlayed} games (${xgaPerGame}/game)\n\nLower xGA = Stronger Defense üõ°Ô∏è\nHigher xGA = Weaker Defense ‚ö†Ô∏è`;
                
                // Add defense rating and context
                if (teamData.defense_rating) {
                    const ratingEmoji = teamData.defense_rating === 'Elite' ? 'üè∞' : teamData.defense_rating === 'Strong' ? 'üí™' : teamData.defense_rating === 'Average' ? 'üõ°Ô∏è' : teamData.defense_rating === 'Weak' ? '‚ö†Ô∏è' : 'üö®';
                    xgaTooltip += `\n\n${ratingEmoji} Defense Strength: ${teamData.defense_rating}`;
                }
                
                // Add league ranking context
                if (teamData.xga_percentile !== null && teamData.xga_percentile !== undefined) {
                    const percentileRank = Math.round(teamData.xga_percentile);
                    const contextPhrase = percentileRank >= 75 ? 'Elite defense' : percentileRank >= 50 ? 'Solid defense' : percentileRank >= 25 ? 'Porous defense' : 'Leaky defense';
                    xgaTooltip += `\nüìä League Rank: ${contextPhrase} (${percentileRank}th percentile - lower xGA is better)`;
                }
                
                // Add clean sheet probability estimate
                const cleanSheetProb = parseFloat(xgaPerGame) < 0.8 ? 'High (50-60%)' : parseFloat(xgaPerGame) < 1.2 ? 'Moderate (30-40%)' : parseFloat(xgaPerGame) < 1.6 ? 'Low (15-25%)' : 'Very Low (<15%)';
                xgaTooltip += `\nüß§ Clean Sheet Chance: ${cleanSheetProb}`;
                
                // Add league comparison (LOWER xGA = BETTER defense - opposite of xG!)
                if (teamData.league_stats && teamData.league_stats.xga_mean) {
                    const leagueAvg = teamData.league_stats.xga_mean.toFixed(2);
                    const diff = parseFloat(xgaPerGame) - parseFloat(leagueAvg);
                    const vsLeague = diff < 0 ? `${Math.abs(diff).toFixed(2)} below avg ‚úÖ (stronger defense)` : diff > 0 ? `+${diff.toFixed(2)} above avg ‚ö†Ô∏è (weaker defense)` : 'At league average';
                    xgaTooltip += `\n‚öñÔ∏è vs League Avg (${leagueAvg}/game): ${vsLeague}`;
                }
                
                // Add defensive form context
                if (teamData.recent_trend) {
                    const trendEmoji = teamData.recent_trend === 'below' ? 'üìâ‚úÖ' : teamData.recent_trend === 'above' ? 'üìà‚ö†Ô∏è' : '‚û°Ô∏è';
                    const trendText = teamData.recent_trend === 'below' ? 'Recent defense IMPROVING (conceding less)' : teamData.recent_trend === 'above' ? 'Recent defense DECLINING (conceding more)' : 'Recent defense stable';
                    xgaTooltip += `\n${trendEmoji} Trend: ${trendText}`;
                }
                
                // Add match context analysis
                xgaTooltip += `\n\nüí° Match Impact: ${parseFloat(xgaPerGame) < 0.9 ? 'Very tight defense - opponent will struggle to score' : parseFloat(xgaPerGame) < 1.3 ? 'Decent defense - opponent may get limited chances' : parseFloat(xgaPerGame) < 1.7 ? 'Vulnerable defense - opponent likely to create chances' : 'Weak defense - opponent expected to score easily'}`;
                
                html += `<div class="match-context-label">Season xGA: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${xgaTooltip}" style="cursor: help; font-size: 0.8em; min-width: 250px;"></i></div><div class="match-context-value"><strong>${teamData.xGA.toFixed(1)}</strong></div>`;
            }
            
            // Add xG metrics from FBref if available
            if (xgStats) {
                html += `<div style="grid-column: 1 / -1;"><hr class="my-1"></div>`;
                html += `<div class="match-context-label"><i class="fas fa-chart-line me-1"></i>xG For (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals trends per game from FBref" style="cursor: help; font-size: 0.8em;"></i></div><div class="match-context-value"><strong>${xgStats.xg_for_per_game}</strong> <small class="text-muted">/game</small></div>`;
                html += `<div class="match-context-label"><i class="fas fa-shield-alt me-1"></i>xGA (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals Against per game from FBref" style="cursor: help; font-size: 0.8em;"></i></div><div class="match-context-value"><strong>${xgStats.xg_against_per_game}</strong> <small class="text-muted">/game</small></div>`;
                if (xgStats.scoring_clinicality !== undefined && xgStats.scoring_clinicality !== null) {
                    const clinicality = xgStats.scoring_clinicality;
                    const clinicalityClass = clinicality > 0 ? 'text-success' : 'text-danger';
                    html += `<div class="match-context-label">Scoring Clinicality: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Goals scored vs expected per game. Positive = clinical finishing, Negative = wasteful" style="cursor: help; font-size: 0.8em;"></i></div><div class="match-context-value ${clinicalityClass}"><strong>${clinicality > 0 ? '+' : ''}${clinicality}</strong> <small class="text-muted">/game</small></div>`;
                }
                // Form is now displayed above with opponents, no need to duplicate here
            }
            html += `</div>`;
            return html;
        }
        
        function displayEloPredictionsComparison(eloPreds, matchData) {
            // Calculate hybrid predictions (60% Elo, 40% Market)
            const marketPreds = matchData.predictions['1X2'];
            if (!marketPreds) return '';
            
            const hybridHomeWin = (eloPreds.home_win * 0.6) + (marketPreds.home_win.probability * 0.4);
            const hybridDraw = (eloPreds.draw * 0.6) + (marketPreds.draw.probability * 0.4);
            const hybridAwayWin = (eloPreds.away_win * 0.6) + (marketPreds.away_win.probability * 0.4);
            
            // Detect value bets (10%+ divergence between Elo and Market)
            const homeDiv = Math.abs(eloPreds.home_win - marketPreds.home_win.probability);
            const drawDiv = Math.abs(eloPreds.draw - marketPreds.draw.probability);
            const awayDiv = Math.abs(eloPreds.away_win - marketPreds.away_win.probability);
            
            const hasValueBet = homeDiv >= 0.10 || drawDiv >= 0.10 || awayDiv >= 0.10;
            
            let html = `
                <hr class="my-3">
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-center mb-3">
                            <i class="fas fa-chart-pie me-2"></i>Prediction Models Comparison
                            <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" data-bs-title="Elo = Historical performance (ClubElo), Market = Bookmaker consensus (30+ bookmakers), Hybrid = 60% Elo + 40% Market for balanced predictions" style="cursor: help; font-size: 0.8em;"></i>
                        </h6>
            `;
            
            if (hasValueBet) {
                html += `
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i><strong>Value Bet Detected!</strong> 
                        Significant divergence (‚â•10%) between Elo and Market predictions suggests potential betting opportunity.
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                <div class="row text-center small">
                    <div class="col-4">
                        <div class="card bg-body-secondary mb-2">
                            <div class="card-body py-2 px-1">
                                <strong class="d-block mb-2">üìä Market Odds</strong>
                                <div class="mb-1">
                                    <span class="badge ${marketPreds.home_win.probability > marketPreds.away_win.probability && marketPreds.home_win.probability > marketPreds.draw.probability ? 'bg-success' : 'bg-secondary'}">${matchData.home_team}</span>
                                    <div><strong>${(marketPreds.home_win.probability * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div class="mb-1">
                                    <span class="badge ${marketPreds.draw.probability > marketPreds.home_win.probability && marketPreds.draw.probability > marketPreds.away_win.probability ? 'bg-success' : 'bg-secondary'}">Draw</span>
                                    <div><strong>${(marketPreds.draw.probability * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div>
                                    <span class="badge ${marketPreds.away_win.probability > marketPreds.home_win.probability && marketPreds.away_win.probability > marketPreds.draw.probability ? 'bg-success' : 'bg-secondary'}">${matchData.away_team}</span>
                                    <div><strong>${(marketPreds.away_win.probability * 100).toFixed(1)}%</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-body-secondary mb-2">
                            <div class="card-body py-2 px-1">
                                <strong class="d-block mb-2">‚ö° Elo Model</strong>
                                <div class="mb-1 ${homeDiv >= 0.10 ? 'text-warning fw-bold' : ''}">
                                    <span class="badge ${eloPreds.home_win > eloPreds.away_win && eloPreds.home_win > eloPreds.draw ? 'bg-success' : 'bg-secondary'}">${matchData.home_team}</span>
                                    <div><strong>${(eloPreds.home_win * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div class="mb-1 ${drawDiv >= 0.10 ? 'text-warning fw-bold' : ''}">
                                    <span class="badge ${eloPreds.draw > eloPreds.home_win && eloPreds.draw > eloPreds.away_win ? 'bg-success' : 'bg-secondary'}">Draw</span>
                                    <div><strong>${(eloPreds.draw * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div class="${awayDiv >= 0.10 ? 'text-warning fw-bold' : ''}">
                                    <span class="badge ${eloPreds.away_win > eloPreds.home_win && eloPreds.away_win > eloPreds.draw ? 'bg-success' : 'bg-secondary'}">${matchData.away_team}</span>
                                    <div><strong>${(eloPreds.away_win * 100).toFixed(1)}%</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-primary-subtle mb-2">
                            <div class="card-body py-2 px-1">
                                <strong class="d-block mb-2">üéØ Hybrid (60/40)</strong>
                                <div class="mb-1">
                                    <span class="badge ${hybridHomeWin > hybridAwayWin && hybridHomeWin > hybridDraw ? 'bg-primary' : 'bg-secondary'}">${matchData.home_team}</span>
                                    <div><strong>${(hybridHomeWin * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div class="mb-1">
                                    <span class="badge ${hybridDraw > hybridHomeWin && hybridDraw > hybridAwayWin ? 'bg-primary' : 'bg-secondary'}">Draw</span>
                                    <div><strong>${(hybridDraw * 100).toFixed(1)}%</strong></div>
                                </div>
                                <div>
                                    <span class="badge ${hybridAwayWin > hybridHomeWin && hybridAwayWin > hybridDraw ? 'bg-primary' : 'bg-secondary'}">${matchData.away_team}</span>
                                    <div><strong>${(hybridAwayWin * 100).toFixed(1)}%</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function displayXgCharts(xgData) {
            const hasHomeXgChart = xgData.home_stats && xgData.home_stats.recent_matches && xgData.home_stats.recent_matches.length > 0;
            const hasAwayXgChart = xgData.away_stats && xgData.away_stats.recent_matches && xgData.away_stats.recent_matches.length > 0;
            
            if (!hasHomeXgChart && !hasAwayXgChart) {
                return '';
            }
            
            let html = `
                <hr class="my-3">
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="text-center mb-3">
                            <i class="fas fa-chart-area me-2"></i>xG Trends (FBref)
                            <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" data-bs-title="Rolling 5-match average of Expected Goals - Shows attacking/defensive performance trends over recent games" style="cursor: help; font-size: 0.8em;"></i>
                        </h6>
                    </div>
                </div>
                <div class="row">
            `;
            
            if (hasHomeXgChart) {
                html += `
                    <div class="col-md-${hasAwayXgChart ? '5' : '12'}">
                        <div class="text-center mb-2">
                            <span class="badge bg-primary">${currentMatchData.home_team}</span>
                        </div>
                        <div style="max-height: 320px; overflow: hidden; position: relative;">
                            <canvas id="home-xg-chart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                `;
            }
            
            if (hasHomeXgChart && hasAwayXgChart) {
                html += `
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <h4 class="text-muted mb-0">VS</h4>
                    </div>
                `;
            }
            
            if (hasAwayXgChart) {
                html += `
                    <div class="col-md-${hasHomeXgChart ? '5' : '12'}">
                        <div class="text-center mb-2">
                            <span class="badge bg-danger">${currentMatchData.away_team}</span>
                        </div>
                        <div style="max-height: 320px; overflow: hidden; position: relative;">
                            <canvas id="away-xg-chart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const teamSearchInput = document.getElementById('team-search');
            const searchBtn = document.getElementById('search-btn');
            const leagueButtons = document.querySelectorAll('[data-league]');
            const matchesList = document.getElementById('matches-list');
            const predictionContainer = document.getElementById('prediction-container');
            const matchTeams = document.getElementById('match-teams');
            const matchLeague = document.getElementById('match-league');
            const matchDate = document.getElementById('match-date');
            const prediction1x2 = document.getElementById('prediction-1x2');
            const predictionOverUnder = document.getElementById('prediction-over-under');
            const bettingAnalysis = document.getElementById('betting-analysis');
            const matchContext = document.getElementById('match-context');
            
            // Comprehensive team database with nicknames and aliases (unique aliases only)
            const teamDatabase = [
                { name: "Arsenal", aliases: ["Gunners", "AFC"], league: "Premier League" },
                { name: "Liverpool", aliases: ["Reds", "LFC"], league: "Premier League" },
                { name: "Manchester United", aliases: ["Man Utd", "Man United", "United", "Red Devils", "MUFC"], league: "Premier League" },
                { name: "Manchester City", aliases: ["Man City", "City", "Citizens", "MCFC"], league: "Premier League" },
                { name: "Chelsea", aliases: ["Blues", "CFC"], league: "Premier League" },
                { name: "Tottenham", aliases: ["Spurs", "Tottenham Hotspur", "THFC"], league: "Premier League" },
                { name: "Newcastle", aliases: ["Newcastle United", "Magpies", "NUFC"], league: "Premier League" },
                { name: "Aston Villa", aliases: ["Villa", "AVFC"], league: "Premier League" },
                { name: "Brighton", aliases: ["Brighton & Hove Albion", "Seagulls", "BHAFC"], league: "Premier League" },
                { name: "West Ham", aliases: ["West Ham United", "Hammers", "WHUFC"], league: "Premier League" },
                { name: "Barcelona", aliases: ["Barca", "Bar√ßa", "Blaugrana"], league: "La Liga" },
                { name: "Real Madrid", aliases: ["Madrid", "Real", "Los Blancos", "RM"], league: "La Liga" },
                { name: "Atletico Madrid", aliases: ["Atleti", "Atletico", "ATM"], league: "La Liga" },
                { name: "Sevilla", aliases: ["SFC"], league: "La Liga" },
                { name: "Valencia", aliases: ["VCF"], league: "La Liga" },
                { name: "Real Betis", aliases: ["Betis"], league: "La Liga" },
                { name: "Bayern Munich", aliases: ["Bayern", "FCB", "FC Bayern", "Die Roten"], league: "Bundesliga" },
                { name: "Borussia Dortmund", aliases: ["Dortmund", "BVB", "Die Schwarzgelben"], league: "Bundesliga" },
                { name: "RB Leipzig", aliases: ["Leipzig", "RBL"], league: "Bundesliga" },
                { name: "Bayer Leverkusen", aliases: ["Leverkusen", "B04"], league: "Bundesliga" },
                { name: "Juventus", aliases: ["Juve", "Bianconeri", "Old Lady"], league: "Serie A" },
                { name: "Inter Milan", aliases: ["Inter", "Internazionale", "Nerazzurri"], league: "Serie A" },
                { name: "AC Milan", aliases: ["Milan", "Rossoneri", "ACM"], league: "Serie A" },
                { name: "Roma", aliases: ["AS Roma", "Giallorossi"], league: "Serie A" },
                { name: "Napoli", aliases: ["SSC Napoli", "Partenopei"], league: "Serie A" },
                { name: "Lazio", aliases: ["SS Lazio", "Biancocelesti"], league: "Serie A" },
                { name: "Paris Saint Germain", aliases: ["PSG", "Paris SG", "Paris"], league: "Ligue 1" },
                { name: "Marseille", aliases: ["OM", "Olympique Marseille"], league: "Ligue 1" },
                { name: "Lyon", aliases: ["Olympique Lyon", "OL"], league: "Ligue 1" },
                { name: "Monaco", aliases: ["AS Monaco", "ASM"], league: "Ligue 1" },
                { name: "Lille", aliases: ["LOSC"], league: "Ligue 1" }
            ];
            
            
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
            
            // Autocomplete functionality
            teamSearchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }
                
                // Find matching teams
                const matches = teamDatabase.filter(team => {
                    const nameMatch = team.name.toLowerCase().includes(query);
                    const aliasMatch = team.aliases.some(alias => alias.toLowerCase().includes(query));
                    return nameMatch || aliasMatch;
                }).slice(0, 3); // Limit to 3 results
                
                if (matches.length > 0) {
                    autocompleteDropdown.innerHTML = matches.map(team => {
                        const matchedAlias = team.aliases.find(alias => alias.toLowerCase().includes(query));
                        const displayAlias = matchedAlias ? `<span class="team-alias">(${matchedAlias})</span>` : '';
                        
                        return `
                            <div class="autocomplete-item" data-team="${team.name}">
                                <span class="team-name">${team.name}</span>
                                ${displayAlias}
                                <span class="team-league">${team.league}</span>
                            </div>
                        `;
                    }).join('');
                    
                    autocompleteDropdown.style.display = 'block';
                    
                    // Add click listeners to autocomplete items
                    document.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const teamName = this.getAttribute('data-team');
                            teamSearchInput.value = teamName;
                            autocompleteDropdown.style.display = 'none';
                            searchTeam();
                        });
                    });
                } else {
                    autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!teamSearchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                    autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Event listeners
            searchBtn.addEventListener('click', searchTeam);
            teamSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    autocompleteDropdown.style.display = 'none';
                    searchTeam();
                }
            });
            
            leagueButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const league = this.getAttribute('data-league');
                    getUpcomingMatches(league);
                });
            });
            
            // Filter control event listeners
            const arbitrageFilterCheckbox = document.getElementById('arbitrage-filter-checkbox');
            
            if (arbitrageFilterCheckbox) {
                arbitrageFilterCheckbox.addEventListener('change', applyFilters);
            }
            
            // Functions
            function normalizeTeamName(input) {
                // Check if input matches any team name or alias
                const inputLower = input.toLowerCase();
                
                for (const team of teamDatabase) {
                    // Check if it matches the canonical name
                    if (team.name.toLowerCase() === inputLower) {
                        return team.name;
                    }
                    
                    // Check if it matches any alias
                    const matchedAlias = team.aliases.find(alias => alias.toLowerCase() === inputLower);
                    if (matchedAlias) {
                        return team.name;
                    }
                }
                
                // If no match found, return original input
                return input;
            }
            
            function searchTeam() {
                let teamName = teamSearchInput.value.trim();
                if (!teamName) return;
                
                // Normalize the team name (resolve aliases to canonical names)
                teamName = normalizeTeamName(teamName);
                
                matchesList.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `team_name=${encodeURIComponent(teamName)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        matchesList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayMatches(data.matches);
                })
                .catch(error => {
                    console.error('Error:', error);
                    matchesList.innerHTML = `<p class="text-danger">Error searching for team: ${error.message}</p>`;
                });
            }
            
            function getUpcomingMatches(league) {
                matchesList.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch(`/upcoming?league=${encodeURIComponent(league)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        matchesList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayMatches(data.matches);
                })
                .catch(error => {
                    console.error('Error:', error);
                    matchesList.innerHTML = `<p class="text-danger">Error getting upcoming matches: ${error.message}</p>`;
                });
            }
            
            // Update the filter badge with match counts
            function updateFilterBadge(filteredCount, totalCount, arbitrageFilter) {
                const badge = document.getElementById('filter-badge');
                
                if (filteredCount === totalCount) {
                    badge.style.display = 'none';
                    return;
                }
                
                badge.style.display = 'inline-block';
                
                let badgeText = '';
                if (arbitrageFilter) {
                    badgeText = `${filteredCount} Arbitrage ${filteredCount === 1 ? 'Opportunity' : 'Opportunities'}`;
                }
                
                badge.textContent = badgeText;
            }
            
            function displayMatches(matches) {
                if (!matches || matches.length === 0) {
                    matchesList.innerHTML = `<p class="text-center text-muted">No matches found</p>`;
                    return;
                }
                
                // Store matches globally
                window.currentMatches = matches;
                
                // Get current filter settings from the top filter bar
                const arbitrageFilter = document.getElementById('arbitrage-filter-checkbox')?.checked || false;
                
                // Apply filters
                let filteredMatches = matches;
                
                // Filter for arbitrage
                if (arbitrageFilter) {
                    filteredMatches = filteredMatches.filter(match => 
                        match.predictions && 
                        match.predictions.arbitrage && 
                        match.predictions.arbitrage.is_arbitrage
                    );
                }
                
                // Update filter badge
                updateFilterBadge(filteredMatches.length, matches.length, arbitrageFilter);
                
                const popularTeams = [
                    'Bayern M√ºnchen', 'Paris Saint-Germain', 'Arsenal', 'Real Madrid', 'Liverpool FC',
                    'Barcelona', 'Chelsea FC', 'Manchester City', 'Inter Milan', 'Borussia Dortmund',
                    'Atl√©tico Madrid', 'SSC Napoli', 'Palmeiras', 'AS Roma', 'Crystal Palace',
                    'Atalanta', 'Aston Villa', 'Newcastle United', 'Bayer Leverkusen', 'AC Milan',
                    'Sporting', 'Villarreal', 'Juventus', 'Flamengo', 'PSV Eindhoven',
                    'Brighton & Hove Albion', 'Galatasaray', 'Benfica', 'AFC Bournemouth', 'Real Betis',
                    'Tottenham Hotspur', 'FC Porto', 'Eintracht Frankfurt', 'Feyenoord', 'Marseille',
                    'Everton FC', 'Lille', 'RB Leipzig', 'Club Brugge', 'Slavia Prague',
                    'Union St.Gilloise', 'Olympiakos', 'Lyon', 'Lazio', 'Al Hilal',
                    'FK Red Star Belgrade', 'Brentford FC', 'Bologna', 'Athletic Bilbao', 'Manchester United'
                ];
                
                let html = '';
                filteredMatches.forEach((match, filteredIndex) => {
                    const homeTeam = match.home_team.toLowerCase();
                    const awayTeam = match.away_team.toLowerCase();
                    const isPopular = popularTeams.some(team => 
                        homeTeam.includes(team.toLowerCase()) || awayTeam.includes(team.toLowerCase())
                    );
                    const hasArbitrage = match.predictions && 
                                       match.predictions.arbitrage && 
                                       match.predictions.arbitrage.is_arbitrage;
                    const popularClass = isPopular ? ' popular-match' : '';
                    const arbitrageClass = hasArbitrage ? ' arbitrage-match' : '';
                    
                    // Find the original index in the full matches array
                    const originalIndex = matches.findIndex(m => 
                        m.home_team === match.home_team && 
                        m.away_team === match.away_team && 
                        m.commence_time === match.commence_time
                    );
                    
                    const homeLogo = getTeamLogoUrl(match.home_team, match.league);
                    const awayLogo = getTeamLogoUrl(match.away_team, match.league);
                    
                    html += `
                        <div class="card match-card mb-2${popularClass}${arbitrageClass}" data-match-index="${originalIndex}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <img src="${homeLogo}" alt="${match.home_team}" style="width: 28px; height: 28px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">
                                            <span class="fw-bold">${match.home_team}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <img src="${awayLogo}" alt="${match.away_team}" style="width: 28px; height: 28px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">
                                            <span class="fw-bold">${match.away_team}</span>
                                        </div>
                                        <div class="small text-muted mt-2">${match.league || 'Unknown League'}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small text-muted">${match.datetime || 'TBD'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                matchesList.innerHTML = html;
                
                // Add click event to match cards
                document.querySelectorAll('.match-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const matchIndex = parseInt(this.getAttribute('data-match-index'));
                        displayMatchPredictions(window.currentMatches[matchIndex]);
                    });
                });
            }
            
            // Reapply filters when filter controls change
            function applyFilters() {
                if (window.currentMatches) {
                    displayMatches(window.currentMatches);
                }
            }
            
            function displayMatchPredictions(match) {
                // Show prediction container
                predictionContainer.style.display = 'block';
                
                // Store current match data
                currentMatchData = match;
                
                // Update match details with logos
                const homeLogo = getTeamLogoUrl(match.home_team, match.league);
                const awayLogo = getTeamLogoUrl(match.away_team, match.league);
                matchTeams.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <div class="d-flex align-items-center">
                            <img src="${homeLogo}" alt="${match.home_team}" style="width: 36px; height: 36px; object-fit: contain; margin-right: 10px;" onerror="this.style.display='none'">
                            <span>${match.home_team}</span>
                        </div>
                        <span class="text-muted">vs</span>
                        <div class="d-flex align-items-center">
                            <img src="${awayLogo}" alt="${match.away_team}" style="width: 36px; height: 36px; object-fit: contain; margin-right: 10px;" onerror="this.style.display='none'">
                            <span>${match.away_team}</span>
                        </div>
                    </div>
                `;
                matchLeague.textContent = match.league || 'Unknown League';
                matchDate.textContent = match.datetime || 'TBD';
                
                // Show on-demand Match Context button instead of auto-loading
                showMatchContextButton(match);
                
                // Display predictions from Odds API with Elo if available
                if (match.predictions && match.predictions['1x2']) {
                    display1X2Prediction(match.predictions['1x2'], match.elo_predictions);
                    resetOverUnderButton();
                    resetBettingAnalysisButton();
                } else {
                    prediction1x2.innerHTML = '<p class="text-muted">No predictions available for this match</p>';
                    resetOverUnderButton();
                    resetBettingAnalysisButton();
                }
            }
            
            function resetOverUnderButton() {
                predictionOverUnder.innerHTML = `
                    <div class="text-center">
                        <button onclick="loadOverUnderPredictions()" class="btn btn-primary">
                            <i class="fas fa-chart-bar me-2"></i> Show Over/Under Odds
                        </button>
                        <p class="text-muted mt-2 small">Click to fetch detailed over/under predictions from bookmakers</p>
                    </div>
                `;
            }
            
            function loadOverUnderPredictions() {
                console.log('loadOverUnderPredictions called');
                console.log('currentMatchData:', currentMatchData);
                
                if (!currentMatchData) {
                    console.error('No currentMatchData available');
                    predictionOverUnder.innerHTML = '<p class="text-danger">No match data available</p>';
                    return;
                }
                
                predictionOverUnder.innerHTML = loadingSpinner();
                
                const eventId = currentMatchData.event_id;
                const sportKey = currentMatchData.sport_key;
                
                console.log('eventId:', eventId, 'sportKey:', sportKey);
                
                if (!eventId || !sportKey) {
                    predictionOverUnder.innerHTML = '<p class="text-danger">Unable to load over/under odds for this match (missing event_id or sport_key)</p>';
                    return;
                }
                
                const url = `/match/${eventId}/totals?sport_key=${sportKey}`;
                console.log('Fetching:', url);
                
                fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.error) {
                        predictionOverUnder.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayTotalsData(data.totals);
                })
                .catch(error => {
                    console.error('Error fetching over/under:', error);
                    predictionOverUnder.innerHTML = `<p class="text-danger">Failed to load over/under odds: ${error.message}</p>`;
                });
            }
            
            // Make function available globally for inline onclick handler
            window.loadOverUnderPredictions = loadOverUnderPredictions;
            
            function resetBettingAnalysisButton() {
                bettingAnalysis.innerHTML = `
                    <div class="text-center">
                        <button onclick="loadBettingAnalysis()" class="btn btn-primary">
                            <i class="fas fa-coins me-2"></i> Show Betting Analysis
                        </button>
                        <p class="text-muted mt-2 small">View arbitrage opportunities, best odds, and betting tips</p>
                    </div>
                `;
            }
            
            function loadBettingAnalysis() {
                if (!currentMatchData) {
                    bettingAnalysis.innerHTML = '<p class="text-danger">No match data available</p>';
                    return;
                }
                
                bettingAnalysis.innerHTML = loadingSpinner();
                
                // Fetch xG data if not already loaded (from Match Context)
                if (!currentXgData && currentMatchData.league) {
                    // Use league_code from match data
                    const leagueCode = currentMatchData.league_code || currentMatchData.league;
                    
                    const leagueMap = {
                        'UEFA Champions League': 'CL',
                        'EPL': 'PL',
                        'Premier League': 'PL',
                        'English Premier League': 'PL',
                        'La Liga': 'PD',
                        'Spanish La Liga': 'PD',
                        'Spain La Liga': 'PD',
                        'La Liga - Spain': 'PD',
                        'Bundesliga': 'BL1',
                        'German Bundesliga': 'BL1',
                        'Germany Bundesliga': 'BL1',
                        'Serie A': 'SA',
                        'Italian Serie A': 'SA',
                        'Italy Serie A': 'SA',
                        'Ligue 1': 'FL1',
                        'French Ligue 1': 'FL1',
                        'France Ligue 1': 'FL1',
                        'Ligue 1 - France': 'FL1',
                        'UEFA Europa League': 'EL'
                    };
                    
                    const finalLeagueCode = leagueMap[leagueCode] || leagueCode;
                    
                    fetch(`/match/${currentMatchData.id}/xg?league=${finalLeagueCode}&home_team=${encodeURIComponent(currentMatchData.home_team)}&away_team=${encodeURIComponent(currentMatchData.away_team)}`)
                    .then(r => r.json())
                    .then(xgData => {
                        currentXgData = xgData.xg || null;
                        displayOddsBasedAnalysis(currentMatchData);
                    })
                    .catch(error => {
                        console.error('Error fetching xG:', error);
                        currentXgData = null;
                        displayOddsBasedAnalysis(currentMatchData);
                    });
                } else {
                    // xG data already loaded or unavailable
                    displayOddsBasedAnalysis(currentMatchData);
                }
            }
            
            // Make function available globally for inline onclick handler
            window.loadBettingAnalysis = loadBettingAnalysis;
            
            function displayTotalsData(totalsData) {
                if (!totalsData || !totalsData.predictions || totalsData.predictions.length === 0) {
                    predictionOverUnder.innerHTML = '<p class="text-muted">No over/under odds available for this match</p>';
                    return;
                }
                
                // Store Over/Under data globally
                currentOverUnderData = totalsData;
                
                let html = `<div class="row">`;
                
                totalsData.predictions.forEach(prediction => {
                    const safetyClass = prediction.confidence >= 60 ? 'safe-bet' : 'risky-bet';
                    const safetyText = prediction.confidence >= 60 ? 'Confident' : 'Lower Confidence';
                    
                    const enhancedInfo = prediction.enhanced && prediction.lines_used ? 
                        `<p class="text-info small mt-2"><i class="fas fa-info-circle me-1"></i>Enhanced calculation using ${prediction.lines_used.join(', ')} goal lines from ${prediction.bookmaker_count} bookmakers</p>` : 
                        '';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    Over/Under ${prediction.line} Goals
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <span class="prediction-badge ${safetyClass}">
                                            ${prediction.prediction} (${prediction.confidence}%)
                                            <i class="fas ${prediction.confidence >= 60 ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                                            ${safetyText}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Over ${prediction.line}:</span>
                                            <span>${(prediction.probabilities.over * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.over * 100}%; background-color: ${getThemeColors().secondary};"></div>
                                        </div>
                                        ${prediction.best_odds.over ? `<small class="text-muted">Best odds: ${prediction.best_odds.over.price.toFixed(2)} (${prediction.best_odds.over.bookmaker})</small>` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Under ${prediction.line}:</span>
                                            <span>${(prediction.probabilities.under * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.under * 100}%; background-color: ${getThemeColors().muted};"></div>
                                        </div>
                                        ${prediction.best_odds.under ? `<small class="text-muted">Best odds: ${prediction.best_odds.under.price.toFixed(2)} (${prediction.best_odds.under.bookmaker})</small>` : ''}
                                    </div>
                                    ${enhancedInfo || `<p class="text-muted small mt-2">${prediction.bookmaker_count} bookmakers</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                predictionOverUnder.innerHTML = html;
                
                // Regenerate betting tips with Over/Under data if betting analysis is already shown
                if (bettingAnalysis.innerHTML && !bettingAnalysis.innerHTML.includes('Show Betting Analysis')) {
                    displayOddsBasedAnalysis(currentMatchData);
                }
            }
            
            function displayMatchContextData(contextData) {
                const matchContext = document.getElementById('match-context');
                let html = '';
                
                if (contextData.narrative) {
                    const alertClass = contextData.has_data ? 'alert-info' : 'alert-warning';
                    const icon = contextData.has_data ? 'fa-info-circle' : 'fa-exclamation-triangle';
                    html += `<div class="alert ${alertClass} mb-3 small"><i class="fas ${icon} me-2"></i>${contextData.narrative}</div>`;
                }
                
                const hasHomeData = contextData.home_team && (contextData.home_team.position || contextData.home_team.points || contextData.home_team.form);
                const hasAwayData = contextData.away_team && (contextData.away_team.position || contextData.away_team.points || contextData.away_team.form);
                
                if (hasHomeData || hasAwayData) {
                    html += `<div class="row">`;
                    
                    // Home team column  
                    html += `<div class="col-12 col-md-6 mb-3 mb-md-0 ${hasAwayData ? 'border-md-end' : ''}">`;
                    const homeLogoUrl = getTeamLogoUrl(currentMatchData.home_team, currentMatchData.league);
                    const homeBrandColor = getTeamBrandColor(currentMatchData.home_team);
                    const homeColorData = homeBrandColor ? ensureColorContrast(homeBrandColor, isDarkTheme()) : { color: 'var(--primary-color)', shadow: '' };
                    html += `<h6 class="fw-bold mb-2 text-truncate" style="color: ${homeColorData.color}; ${homeColorData.shadow}"><i class="fas fa-home me-1"></i><img src="${homeLogoUrl}" alt="${currentMatchData.home_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.home_team}</h6>`;
                    
                    if (hasHomeData) {
                        html += `<table class="table table-sm table-borderless mb-0"><tbody>`;
                        if (contextData.home_team.position) {
                            html += `<tr><td class="text-muted" style="width: 80px;">Position:</td><td><span class="badge bg-secondary">${contextData.home_team.position}</span></td></tr>`;
                        }
                        if (contextData.home_team.points !== null && contextData.home_team.points !== undefined) {
                            html += `<tr><td class="text-muted">Points:</td><td><strong>${contextData.home_team.points}</strong></td></tr>`;
                        }
                        // Form display: Use FBref with opponents if available, fallback to Understat
                        const hasHomeFBrefForm = contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0;
                        if (hasHomeFBrefForm) {
                            const formDisplay = formatFormWithOpponents(contextData.xg.home_stats.recent_matches);
                            html += `<tr><td class="text-muted">Form: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Last 5 match results from FBref with opponents (üü© Win, ‚¨ú Draw, üü• Loss)" style="cursor: help; font-size: 0.8em;"></i></td><td class="small">${formDisplay}</td></tr>`;
                        } else if (contextData.home_team.form) {
                            // Fallback to Understat form if FBref unavailable
                            html += `<tr><td class="text-muted">Form:</td><td>${formatFormIndicators(contextData.home_team.form)}</td></tr>`;
                        }
                        
                        // Add PPDA prominently if available from Understat
                        if (contextData.home_team.ppda_coef !== null && contextData.home_team.ppda_coef !== undefined) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><strong>üõ°Ô∏è PPDA:</strong> <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Passes Per Defensive Action - measures pressing intensity. <8.0 = Extreme High Press (Klopp/Guardiola style), 8-12 = High Press (modern attacking teams), 12-15 = Medium Press (balanced), 15-20 = Low/Passive Block (defensive teams), >20 = Extremely Passive (deep defending). Lower = more aggressive pressing." style="cursor: help; font-size: 0.8em;"></i></td><td><strong class="text-primary">${contextData.home_team.ppda_coef}</strong></td></tr>`;
                        }
                        if (contextData.home_team.xG !== null && contextData.home_team.xG !== undefined) {
                            const homeGamesPlayed = contextData.home_team.played || 0;
                            const homeXgPerGame = homeGamesPlayed > 0 ? (contextData.home_team.xG / homeGamesPlayed).toFixed(2) : '0.00';
                            const leagueXgAvg = contextData.home_team.league_stats && contextData.home_team.league_stats.xg_mean ? contextData.home_team.league_stats.xg_mean.toFixed(2) : '1.40';
                            const seasonDisplay = contextData.season_display || '2025/26';
                            const homeXgTooltip = homeGamesPlayed > 0 
                                ? `${contextData.home_team.xG} xG in ${homeGamesPlayed} games (avg ${homeXgPerGame}/game). League avg: ${leagueXgAvg}/game. Based on shot quality.`
                                : `Cumulative Expected Goals for ${seasonDisplay} season from Understat.`;
                            html += `<tr><td class="text-muted">Season xG: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${homeXgTooltip}" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.home_team.xG}</strong></td></tr>`;
                        }
                        if (contextData.home_team.xGA !== null && contextData.home_team.xGA !== undefined) {
                            const homeGamesPlayed = contextData.home_team.played || 0;
                            const homeXgaPerGame = homeGamesPlayed > 0 ? (contextData.home_team.xGA / homeGamesPlayed).toFixed(2) : '0.00';
                            const leagueXgaAvg = contextData.home_team.league_stats && contextData.home_team.league_stats.xga_mean ? contextData.home_team.league_stats.xga_mean.toFixed(2) : '1.40';
                            const homeXgaTooltip = homeGamesPlayed > 0 
                                ? `${contextData.home_team.xGA} xGA in ${homeGamesPlayed} games (avg ${homeXgaPerGame}/game).\n\nLeague avg: ${leagueXgaAvg}/game\nLower xGA = Stronger Defense üõ°Ô∏è\nHigher xGA = Weaker Defense ‚ö†Ô∏è`
                                : `Cumulative Expected Goals Against for ${seasonDisplay} season from Understat.\n\nLower xGA = Stronger Defense`;
                            html += `<tr><td class="text-muted">Season xGA: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${homeXgaTooltip}" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.home_team.xGA}</strong></td></tr>`;
                        }
                        
                        // Add xG metrics if available
                        if (contextData.xg && contextData.xg.home_stats) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-chart-line me-1"></i>xG For (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals trends per game from FBref" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.home_stats.xg_for_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-shield-alt me-1"></i>xGA (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals Against per game from FBref" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.home_stats.xg_against_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            if (contextData.xg.home_stats.scoring_clinicality !== undefined && contextData.xg.home_stats.scoring_clinicality !== null) {
                                const clinicality = contextData.xg.home_stats.scoring_clinicality;
                                const clinicalityClass = clinicality > 0 ? 'text-success' : 'text-danger';
                                html += `<tr><td class="text-muted">Scoring Clinicality: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Goals scored vs expected per game. Positive = clinical finishing, Negative = wasteful" style="cursor: help; font-size: 0.8em;"></i></td><td class="${clinicalityClass}"><strong>${clinicality > 0 ? '+' : ''}${clinicality}</strong> <small class="text-muted">/game</small></td></tr>`;
                            }
                            // Form is now displayed above with opponents, no need to duplicate here
                        }
                        html += `</tbody></table>`;
                    } else {
                        html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                    }
                    html += `</div>`;
                    
                    // Away team column
                    html += `<div class="col-12 col-md-6">`;
                    const awayLogoUrl = getTeamLogoUrl(currentMatchData.away_team, currentMatchData.league);
                    const awayBrandColor = getTeamBrandColor(currentMatchData.away_team);
                    const awayColorData = awayBrandColor ? ensureColorContrast(awayBrandColor, isDarkTheme()) : { color: '#ef4444', shadow: '' };
                    html += `<h6 class="fw-bold mb-2 text-truncate" style="color: ${awayColorData.color}; ${awayColorData.shadow}"><i class="fas fa-plane-departure me-1"></i><img src="${awayLogoUrl}" alt="${currentMatchData.away_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.away_team}</h6>`;
                    
                    if (hasAwayData) {
                        html += `<table class="table table-sm table-borderless mb-0"><tbody>`;
                        if (contextData.away_team.position) {
                            html += `<tr><td class="text-muted" style="width: 80px;">Position:</td><td><span class="badge bg-secondary">${contextData.away_team.position}</span></td></tr>`;
                        }
                        if (contextData.away_team.points !== null && contextData.away_team.points !== undefined) {
                            html += `<tr><td class="text-muted">Points:</td><td><strong>${contextData.away_team.points}</strong></td></tr>`;
                        }
                        // Form display: Use FBref with opponents if available, fallback to Understat
                        const hasAwayFBrefForm = contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0;
                        if (hasAwayFBrefForm) {
                            const formDisplay = formatFormWithOpponents(contextData.xg.away_stats.recent_matches);
                            html += `<tr><td class="text-muted">Form: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Last 5 match results from FBref with opponents (üü© Win, ‚¨ú Draw, üü• Loss)" style="cursor: help; font-size: 0.8em;"></i></td><td class="small">${formDisplay}</td></tr>`;
                        } else if (contextData.away_team.form) {
                            // Fallback to Understat form if FBref unavailable
                            html += `<tr><td class="text-muted">Form:</td><td>${formatFormIndicators(contextData.away_team.form)}</td></tr>`;
                        }
                        
                        // Add PPDA prominently if available from Understat
                        if (contextData.away_team.ppda_coef !== null && contextData.away_team.ppda_coef !== undefined) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><strong>üõ°Ô∏è PPDA:</strong> <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Passes Per Defensive Action - measures pressing intensity. <8.0 = Extreme High Press (Klopp/Guardiola style), 8-12 = High Press (modern attacking teams), 12-15 = Medium Press (balanced), 15-20 = Low/Passive Block (defensive teams), >20 = Extremely Passive (deep defending). Lower = more aggressive pressing." style="cursor: help; font-size: 0.8em;"></i></td><td><strong class="text-primary">${contextData.away_team.ppda_coef}</strong></td></tr>`;
                        }
                        if (contextData.away_team.xG !== null && contextData.away_team.xG !== undefined) {
                            const awayGamesPlayed = contextData.away_team.played || 0;
                            const awayXgPerGame = awayGamesPlayed > 0 ? (contextData.away_team.xG / awayGamesPlayed).toFixed(2) : '0.00';
                            const leagueXgAvg = contextData.away_team.league_stats && contextData.away_team.league_stats.xg_mean ? contextData.away_team.league_stats.xg_mean.toFixed(2) : '1.40';
                            const awayXgTooltip = awayGamesPlayed > 0 
                                ? `${contextData.away_team.xG} xG in ${awayGamesPlayed} games (avg ${awayXgPerGame}/game). League avg: ${leagueXgAvg}/game. Based on shot quality.`
                                : `Cumulative Expected Goals for ${seasonDisplay} season from Understat.`;
                            html += `<tr><td class="text-muted">Season xG: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${awayXgTooltip}" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.away_team.xG}</strong></td></tr>`;
                        }
                        if (contextData.away_team.xGA !== null && contextData.away_team.xGA !== undefined) {
                            const awayGamesPlayed = contextData.away_team.played || 0;
                            const awayXgaPerGame = awayGamesPlayed > 0 ? (contextData.away_team.xGA / awayGamesPlayed).toFixed(2) : '0.00';
                            const leagueXgaAvg = contextData.away_team.league_stats && contextData.away_team.league_stats.xga_mean ? contextData.away_team.league_stats.xga_mean.toFixed(2) : '1.40';
                            const awayXgaTooltip = awayGamesPlayed > 0 
                                ? `${contextData.away_team.xGA} xGA in ${awayGamesPlayed} games (avg ${awayXgaPerGame}/game).\n\nLeague avg: ${leagueXgaAvg}/game\nLower xGA = Stronger Defense üõ°Ô∏è\nHigher xGA = Weaker Defense ‚ö†Ô∏è`
                                : `Cumulative Expected Goals Against for ${seasonDisplay} season from Understat.\n\nLower xGA = Stronger Defense`;
                            html += `<tr><td class="text-muted">Season xGA: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="${awayXgaTooltip}" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.away_team.xGA}</strong></td></tr>`;
                        }
                        
                        // Add xG metrics if available
                        if (contextData.xg && contextData.xg.away_stats) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-chart-line me-1"></i>xG For (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals trends per game from FBref" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.away_stats.xg_for_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-shield-alt me-1"></i>xGA (FBref): <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical Expected Goals Against per game from FBref" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.away_stats.xg_against_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            if (contextData.xg.away_stats.scoring_clinicality !== undefined && contextData.xg.away_stats.scoring_clinicality !== null) {
                                const clinicality = contextData.xg.away_stats.scoring_clinicality;
                                const clinicalityClass = clinicality > 0 ? 'text-success' : 'text-danger';
                                html += `<tr><td class="text-muted">Scoring Clinicality: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Goals scored vs expected per game. Positive = clinical finishing, Negative = wasteful" style="cursor: help; font-size: 0.8em;"></i></td><td class="${clinicalityClass}"><strong>${clinicality > 0 ? '+' : ''}${clinicality}</strong> <small class="text-muted">/game</small></td></tr>`;
                            }
                            // Form is now displayed above with opponents, no need to duplicate here
                        }
                        html += `</tbody></table>`;
                    } else {
                        html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                    }
                    html += `</div>`;
                    
                    html += `</div>`;
                    
                    // Add side-by-side xG trend comparison section
                    const hasHomeXgChart = contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0;
                    const hasAwayXgChart = contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0;
                    
                    if (hasHomeXgChart || hasAwayXgChart) {
                        // Add explanation box before charts
                        const themeColors = getThemeColors();
                        html += `
                            <div class="alert alert-primary mb-3 small mt-4" style="background-color: ${themeColors.infoBoxBg}; border-color: ${themeColors.infoBoxBorder};">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-chart-line me-2 mt-1" style="color: ${themeColors.infoBoxIcon};"></i>
                                    <div>
                                        <strong>üìà How to Read xG Trend Charts:</strong><br>
                                        <span style="color: ${themeColors.xgFor}; font-weight: 600;">‚óè</span> <strong style="color: ${themeColors.xgFor};">Green line (xGF)</strong> = Goals created per game<br>
                                        <span style="color: ${themeColors.xgAgainst}; font-weight: 600;">‚óè</span> <strong style="color: ${themeColors.xgAgainst};">Red line (xGA)</strong> = Goals conceded per game<br>
                                        <span class="ms-3">‚úÖ Green ABOVE red = Good attacking form</span><br>
                                        <span class="ms-3">‚ùå Red ABOVE green = Defensive struggles</span><br>
                                        <span class="ms-3">üìà Rising green = Attack improving | üìâ Falling red = Defense improving</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        html += `
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3 text-center">
                                        <i class="fas fa-chart-area me-2"></i>xG Trend Comparison
                                    </h6>
                                </div>
                            </div>
                            <div class="row">
                        `;
                        
                        if (hasHomeXgChart) {
                            html += `
                                <div class="col-md-${hasAwayXgChart ? '5' : '12'}">
                                    <div class="text-center mb-2">
                                        <span class="badge bg-primary">${currentMatchData.home_team}</span>
                                    </div>
                                    <div style="max-height: 320px; overflow: hidden; position: relative;">
                                        <canvas id="home-xg-chart" style="height: 300px;"></canvas>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (hasHomeXgChart && hasAwayXgChart) {
                            html += `
                                <div class="col-md-2 d-flex align-items-center justify-content-center">
                                    <h4 class="text-muted mb-0">VS</h4>
                                </div>
                            `;
                        }
                        
                        if (hasAwayXgChart) {
                            html += `
                                <div class="col-md-${hasHomeXgChart ? '5' : '12'}">
                                    <div class="text-center mb-2">
                                        <span class="badge bg-danger">${currentMatchData.away_team}</span>
                                    </div>
                                    <div style="max-height: 320px; overflow: hidden; position: relative;">
                                        <canvas id="away-xg-chart" style="height: 300px;"></canvas>
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                }
                
                matchContext.innerHTML = html;
                
                // Destroy old charts if they exist to prevent memory leaks
                if (window.homeXgChart) {
                    window.homeXgChart.destroy();
                    window.homeXgChart = null;
                }
                if (window.awayXgChart) {
                    window.awayXgChart.destroy();
                    window.awayXgChart = null;
                }
                
                // Create xG trend charts if data available
                if (contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0) {
                    window.homeXgChart = createXgTrendChart('home-xg-chart', contextData.xg.home_stats.recent_matches, currentMatchData.home_team);
                }
                if (contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0) {
                    window.awayXgChart = createXgTrendChart('away-xg-chart', contextData.xg.away_stats.recent_matches, currentMatchData.away_team);
                }
                
                // Tooltips will be auto-initialized by the global MutationObserver
            }
            
            function display1X2Prediction(prediction, eloPredictions) {
                if (!prediction) {
                    prediction1x2.innerHTML = `<p class="text-muted">No prediction available</p>`;
                    return;
                }
                
                // Calculate hybrid if Elo available
                let hybridHome, hybridDraw, hybridAway;
                let finalPrediction = prediction.prediction;
                let finalConfidence = prediction.confidence;
                
                if (eloPredictions) {
                    hybridHome = (eloPredictions.home_win * 0.6) + (prediction.probabilities.HOME_WIN * 0.4);
                    hybridDraw = (eloPredictions.draw * 0.6) + (prediction.probabilities.DRAW * 0.4);
                    hybridAway = (eloPredictions.away_win * 0.6) + (prediction.probabilities.AWAY_WIN * 0.4);
                    
                    // Determine prediction based on highest hybrid percentage
                    const maxHybrid = Math.max(hybridHome, hybridDraw, hybridAway);
                    if (maxHybrid === hybridHome) {
                        finalPrediction = 'HOME_WIN';
                        finalConfidence = hybridHome * 100;
                    } else if (maxHybrid === hybridDraw) {
                        finalPrediction = 'DRAW';
                        finalConfidence = hybridDraw * 100;
                    } else {
                        finalPrediction = 'AWAY_WIN';
                        finalConfidence = hybridAway * 100;
                    }
                }
                
                const safetyClass = finalConfidence >= 60 ? 'safe-bet' : 'risky-bet';
                const safetyText = finalConfidence >= 60 ? 'Safe Bet' : 'Risky Bet';
                
                let html = `
                    <div class="text-center mb-3">
                        <span class="prediction-badge ${safetyClass}">
                            ${finalPrediction} (${finalConfidence.toFixed(1)}%)
                            <i class="fas ${finalConfidence >= 60 ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                            ${safetyText}
                        </span>
                    </div>
                `;
                
                // Show comparison table if Elo available
                if (eloPredictions) {
                    const homeDiv = Math.abs(eloPredictions.home_win - prediction.probabilities.HOME_WIN);
                    const drawDiv = Math.abs(eloPredictions.draw - prediction.probabilities.DRAW);
                    const awayDiv = Math.abs(eloPredictions.away_win - prediction.probabilities.AWAY_WIN);
                    
                    html += `
                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-bordered text-center">
                                <thead>
                                    <tr class="table-active">
                                        <th>Outcome</th>
                                        <th>Market Odds <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Bookmaker consensus from 30+ bookmakers" style="cursor: help; font-size: 0.7em;"></i></th>
                                        <th>Elo Model <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Historical performance from ClubElo (2010-present)" style="cursor: help; font-size: 0.7em;"></i></th>
                                        <th>Hybrid (60/40) <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="60% Elo + 40% Market for balanced predictions" style="cursor: help; font-size: 0.7em;"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>üè† Home Win</strong></td>
                                        <td>${(prediction.probabilities.HOME_WIN * 100).toFixed(1)}%</td>
                                        <td>${(eloPredictions.home_win * 100).toFixed(1)}% ${homeDiv >= 0.10 ? (eloPredictions.home_win > prediction.probabilities.HOME_WIN ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : ''}</td>
                                        <td><strong>${(hybridHome * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>ü§ù Draw <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Draw% varies across models: Market uses bookmaker odds, Elo uses historical team ratings, xG uses statistical goal expectations. Each model calculates differently - this is normal!" style="cursor: help; font-size: 0.7em;"></i></strong></td>
                                        <td>${(prediction.probabilities.DRAW * 100).toFixed(1)}%</td>
                                        <td>${(eloPredictions.draw * 100).toFixed(1)}% ${drawDiv >= 0.10 ? (eloPredictions.draw > prediction.probabilities.DRAW ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : ''}</td>
                                        <td><strong>${(hybridDraw * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>‚úàÔ∏è Away Win</strong></td>
                                        <td>${(prediction.probabilities.AWAY_WIN * 100).toFixed(1)}%</td>
                                        <td>${(eloPredictions.away_win * 100).toFixed(1)}% ${awayDiv >= 0.10 ? (eloPredictions.away_win > prediction.probabilities.AWAY_WIN ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : ''}</td>
                                        <td><strong>${(hybridAway * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="alert alert-info small mb-0 mt-2">
                                <strong>üìä Betting Opportunities Explained:</strong>
                                <ul class="mb-0 mt-1">
                                    <li><strong>‚¨ÜÔ∏è Elo Higher than Market (‚â•10%):</strong> Elo model sees higher probability - potential VALUE BET opportunity</li>
                                    <li><strong>‚¨áÔ∏è Elo Lower than Market (‚â•10%):</strong> Market overvaluing this outcome - avoid or bet against</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback to original display if no Elo
                    html += `
                        <div class="mt-3">
                            <h6>Probability Breakdown: <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-title="Probabilities calculated from bookmaker consensus (30+ sources via The Odds API). Converted from decimal odds using implied probability formula." style="cursor: help; font-size: 0.75em;"></i></h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Home Win:</span>
                                    <span>${(prediction.probabilities.HOME_WIN * 100).toFixed(1)}%</span>
                                </div>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${prediction.probabilities.HOME_WIN * 100}%; background-color: ${getThemeColors().primary};"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Draw:</span>
                                    <span>${(prediction.probabilities.DRAW * 100).toFixed(1)}%</span>
                                </div>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${prediction.probabilities.DRAW * 100}%; background-color: ${getThemeColors().muted};"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Away Win:</span>
                                    <span>${(prediction.probabilities.AWAY_WIN * 100).toFixed(1)}%</span>
                                </div>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${prediction.probabilities.AWAY_WIN * 100}%; background-color: ${getThemeColors().secondary};"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                prediction1x2.innerHTML = html;
                // Reinitialize tooltips for new elements
                initTooltips();
            }
            
            function displayOverUnderPredictions(predictions) {
                if (!predictions) {
                    predictionOverUnder.innerHTML = `<p class="text-muted">No predictions available</p>`;
                    return;
                }
                
                const thresholds = ['0.5', '1.5', '2.5', '3.5'];
                const availablePredictions = thresholds.filter(t => predictions[t]);
                const isSinglePrediction = availablePredictions.length === 1;
                
                let html = `<div class="row${isSinglePrediction ? ' justify-content-center' : ''}">`;
                
                thresholds.forEach(threshold => {
                    const prediction = predictions[threshold];
                    if (!prediction) return;
                    
                    const safetyClass = prediction.is_safe_bet ? 'safe-bet' : 'risky-bet';
                    const safetyText = prediction.is_safe_bet ? 'Safe Bet' : 'Risky Bet';
                    
                    html += `
                        <div class="col-md-${isSinglePrediction ? '8' : '6'} mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    Over/Under ${threshold}
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <span class="prediction-badge ${safetyClass}">
                                            ${prediction.prediction} (${(prediction.confidence * 100).toFixed(1)}%)
                                            <i class="fas ${prediction.is_safe_bet ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                                            ${safetyText}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Over:</span>
                                            <span>${(prediction.probabilities.OVER * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.OVER * 100}%; background-color: ${getThemeColors().secondary};"></div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Under:</span>
                                            <span>${(prediction.probabilities.UNDER * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.UNDER * 100}%; background-color: ${getThemeColors().muted};"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                predictionOverUnder.innerHTML = html;
            }
            
            function generateBettingTips(pred1x2, overUnderData, xgData, eloPredictions) {
                if (!pred1x2.probabilities) {
                    return '';
                }
                
                const probs = pred1x2.probabilities;
                const homeWin = probs.HOME_WIN || 0;
                const draw = probs.DRAW || 0;
                const awayWin = probs.AWAY_WIN || 0;
                
                // Calculate hybrid predictions if Elo data available (60% Elo, 40% Market)
                let hybridHomeWin = homeWin;
                let hybridDraw = draw;
                let hybridAwayWin = awayWin;
                let hasEloDivergence = false;
                let valueBetOutcome = null;
                
                if (eloPredictions) {
                    hybridHomeWin = (eloPredictions.home_win * 0.6) + (homeWin * 0.4);
                    hybridDraw = (eloPredictions.draw * 0.6) + (draw * 0.4);
                    hybridAwayWin = (eloPredictions.away_win * 0.6) + (awayWin * 0.4);
                    
                    // Detect value bets (10%+ divergence between Elo and Market)
                    const homeDiv = Math.abs(eloPredictions.home_win - homeWin);
                    const drawDiv = Math.abs(eloPredictions.draw - draw);
                    const awayDiv = Math.abs(eloPredictions.away_win - awayWin);
                    
                    if (homeDiv >= 0.10) {
                        hasEloDivergence = true;
                        valueBetOutcome = { type: 'Home Win', eloProb: eloPredictions.home_win, marketProb: homeWin, divergence: homeDiv };
                    } else if (awayDiv >= 0.10) {
                        hasEloDivergence = true;
                        valueBetOutcome = { type: 'Away Win', eloProb: eloPredictions.away_win, marketProb: awayWin, divergence: awayDiv };
                    } else if (drawDiv >= 0.10) {
                        hasEloDivergence = true;
                        valueBetOutcome = { type: 'Draw', eloProb: eloPredictions.draw, marketProb: draw, divergence: drawDiv };
                    }
                }
                
                // Calculate double chance probabilities (use Hybrid if available, otherwise Market)
                const dc1X = hybridHomeWin + hybridDraw;  // Home or Draw
                const dc12 = hybridHomeWin + hybridAwayWin;  // Home or Away
                const dcX2 = hybridDraw + hybridAwayWin;  // Draw or Away
                
                // Create array of betting options (use Hybrid probabilities when Elo available)
                const options = [
                    { name: 'Home Win', prob: hybridHomeWin, type: '1x2' },
                    { name: 'Draw', prob: hybridDraw, type: '1x2' },
                    { name: 'Away Win', prob: hybridAwayWin, type: '1x2' },
                    { name: 'Double Chance 1X (Home or Draw)', prob: dc1X, type: 'double_chance' },
                    { name: 'Double Chance 12 (Home or Away)', prob: dc12, type: 'double_chance' },
                    { name: 'Double Chance X2 (Draw or Away)', prob: dcX2, type: 'double_chance' }
                ];
                
                // Add Over/Under options if available
                if (overUnderData && overUnderData.predictions) {
                    overUnderData.predictions.forEach(pred => {
                        const overProb = pred.probabilities.over || 0;
                        const underProb = pred.probabilities.under || 0;
                        
                        options.push({
                            name: `Over ${pred.line} Goals`,
                            prob: overProb,
                            type: 'totals',
                            line: pred.line
                        });
                        
                        options.push({
                            name: `Under ${pred.line} Goals`,
                            prob: underProb,
                            type: 'totals',
                            line: pred.line
                        });
                    });
                }
                
                // Sort by probability
                options.sort((a, b) => b.prob - a.prob);
                
                // Find safest, balanced, and risky bets
                const safest = options.find(opt => opt.prob >= 0.60);
                const balanced = options.find(opt => opt.prob >= 0.30 && opt.prob < 0.60);
                const risky = options.find(opt => opt.prob >= 0.15 && opt.prob < 0.30);
                
                let html = '<div class="analysis-section mb-3">';
                html += '<div class="analysis-title">üí° Betting Tips <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="AI-powered recommendations using Hybrid Model (60% Elo historical data + 40% Market odds). Identifies value bets where Elo and Market diverge ‚â•10%. Source: ClubElo.com + 30+ bookmakers" style="cursor: help; font-size: 0.85em;"></i></div>';
                
                // Show value bet alert ONLY if Elo > Market (true value bet)
                if (hasEloDivergence && valueBetOutcome && valueBetOutcome.eloProb > valueBetOutcome.marketProb) {
                    const divergencePercent = (valueBetOutcome.divergence * 100).toFixed(1);
                    html += `
                        <div class="alert alert-warning mb-3" style="border: 2px solid #f59e0b; background-color: #fef3c7;">
                            <strong style="color: var(--bs-body-color);">üíé VALUE BET DETECTED:</strong> <span style="color: var(--bs-body-color);">${valueBetOutcome.type}</span>
                            <br><span class="badge bg-warning text-dark">Elo ${(valueBetOutcome.eloProb * 100).toFixed(1)}% vs Market ${(valueBetOutcome.marketProb * 100).toFixed(1)}% = ${divergencePercent}% divergence</span>
                            <br><small style="color: var(--bs-body-color); opacity: 0.8;">Elo model sees higher probability than market - potential betting opportunity</small>
                        </div>
                    `;
                }
                
                if (safest) {
                    const typeIcon = safest.type === 'totals' ? '‚öΩ' : safest.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-success mb-2">
                            <strong style="color: var(--bs-body-color);">üõ°Ô∏è SAFEST BET:</strong> <span style="color: var(--bs-body-color);">${typeIcon} ${safest.name}</span>
                            <br><span class="badge bg-success" style="color: white;">${(safest.prob * 100).toFixed(1)}% probability</span>
                            <br><small style="color: var(--bs-body-color); opacity: 0.8;">Lower odds but highest chance of winning</small>
                        </div>
                    `;
                }
                
                if (balanced) {
                    const typeIcon = balanced.type === 'totals' ? '‚öΩ' : balanced.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-info mb-2">
                            <strong style="color: var(--bs-body-color);">‚öñÔ∏è BALANCED BET:</strong> <span style="color: var(--bs-body-color);">${typeIcon} ${balanced.name}</span>
                            <br><span class="badge bg-info" style="color: white;">${(balanced.prob * 100).toFixed(1)}% probability</span>
                            <br><small style="color: var(--bs-body-color); opacity: 0.8;">Moderate odds with reasonable chance</small>
                        </div>
                    `;
                }
                
                if (risky) {
                    const typeIcon = risky.type === 'totals' ? '‚öΩ' : risky.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-warning mb-2">
                            <strong style="color: var(--bs-body-color);">üé≤ VALUE BET:</strong> <span style="color: var(--bs-body-color);">${typeIcon} ${risky.name}</span>
                            <br><span class="badge bg-warning text-dark">${(risky.prob * 100).toFixed(1)}% probability</span>
                            <br><small style="color: var(--bs-body-color); opacity: 0.8;">Higher odds but lower probability</small>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Add xG-based insights if available
                if (xgData && xgData.available) {
                    const themeColors = getThemeColors();
                    html += `<div class="analysis-section mb-3" style="border: 2px solid ${themeColors.xgAnalysisBorder}; background-color: ${themeColors.xgAnalysisBg};">`;
                    html += `<div class="analysis-title" style="color: ${themeColors.xgAnalysisText};"><i class="fas fa-chart-line me-2"></i>xG Analysis <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Calculation: Home xG = (Team xGF + Opponent xGA) / 2 √ó 1.15 home boost, Away xG = (Team xGF + Opponent xGA) / 2 (no boost). Uses rolling 5-game averages when ‚â•3 matches available, otherwise FBref 2025/26 season averages for recent form accuracy." style="cursor: help; font-size: 0.85em;"></i></div>`;
                    
                    html += `
                        <p class="mb-2">
                            <strong>Expected Goals Prediction:</strong>
                            <span class="badge bg-primary">${xgData.home_xg.toFixed(2)}</span>
                            -
                            <span class="badge bg-danger">${xgData.away_xg.toFixed(2)}</span>
                        </p>
                        <p class="small text-muted mb-3">
                            Total expected goals: ${xgData.total_xg.toFixed(2)}
                            (${xgData.over_under_2_5.prediction} 2.5 goals at ${xgData.over_under_2_5.over_probability}%)
                        </p>
                    `;
                    
                    // xG-based match result recommendation
                    const xgResult = xgData.result_prediction;
                    const xgResultText = xgResult.prediction === 'HOME_WIN' ? 'üè† Home Win' : 
                                        xgResult.prediction === 'AWAY_WIN' ? '‚úàÔ∏è Away Win' : 'ü§ù Draw';
                    html += `
                        <div class="alert alert-primary mb-2">
                            <strong style="color: var(--bs-body-color);">üìä xG Result Prediction:</strong> <span style="color: var(--bs-body-color);">${xgResultText}</span>
                            <br><span class="badge bg-primary">${xgResult.confidence}% confidence (based on xG data)</span>
                            <br><small style="color: var(--bs-body-color); opacity: 0.8;">Statistical prediction based on team attacking/defensive strength</small>
                        </div>
                    `;
                    
                    // xG-based Over/Under recommendation
                    const xgOverUnder = xgData.over_under_2_5;
                    html += `
                        <div class="alert ${xgOverUnder.over_probability >= 60 ? 'alert-success' : 'alert-secondary'} mb-2">
                            <strong>‚öΩ xG Over/Under 2.5:</strong> ${xgOverUnder.prediction} <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Statistical model based on xG data. Different from Market-based Over/Under which uses bookmaker odds. xG calculates from team offensive/defensive strength." style="cursor: help; font-size: 0.75em;"></i>
                            <br><span class="badge ${xgOverUnder.over_probability >= 60 ? 'bg-success' : 'bg-secondary'}">
                                ${xgOverUnder.prediction === 'OVER' ? xgOverUnder.over_probability : xgOverUnder.under_probability}% probability
                            </span>
                            <br><small class="text-muted">Based on combined xG: ${xgData.total_xg.toFixed(2)} expected goals</small>
                        </div>
                    `;
                    
                    html += '<p class="small text-muted mt-2"><i class="fas fa-info-circle me-1"></i>xG (Expected Goals) is a statistical measure based on FBref data showing team offensive and defensive strength</p>';
                    html += '</div>';
                }
                
                return html;
            }
            
            function displayOddsBasedAnalysis(match) {
                const predictions = match.predictions || {};
                const pred1x2 = predictions['1x2'] || {};
                const bestOdds = predictions.best_odds || {};
                const arbitrage = predictions.arbitrage || null;
                
                let html = '<div class="analysis-section mb-3">';
                html += '<div class="analysis-title">üìä Market Data</div>';
                html += `<p><strong>Bookmakers:</strong> ${pred1x2.bookmaker_count || 0} bookmakers providing odds</p>`;
                html += '</div>';
                
                if (bestOdds.home || bestOdds.draw || bestOdds.away) {
                    html += '<div class="analysis-section mb-3">';
                    html += '<div class="analysis-title">üí∞ Best Odds</div>';
                    if (bestOdds.home && bestOdds.home.price) {
                        html += `<p><strong>Home Win:</strong> ${bestOdds.home.price.toFixed(2)} at ${bestOdds.home.bookmaker}</p>`;
                    }
                    if (bestOdds.draw && bestOdds.draw.price) {
                        html += `<p><strong>Draw:</strong> ${bestOdds.draw.price.toFixed(2)} at ${bestOdds.draw.bookmaker}</p>`;
                    }
                    if (bestOdds.away && bestOdds.away.price) {
                        html += `<p><strong>Away Win:</strong> ${bestOdds.away.price.toFixed(2)} at ${bestOdds.away.bookmaker}</p>`;
                    }
                    html += '</div>';
                }
                
                if (arbitrage && arbitrage.is_arbitrage) {
                    html += '<div class="analysis-section mb-3" style="border: 2px solid #10b981; background-color: #d1fae5;">';
                    html += '<div class="analysis-title" style="color: #10b981;">‚úÖ Arbitrage Opportunity! <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Risk-free profit by exploiting odds differences across bookmakers. Bet on all outcomes to guarantee profit regardless of result." style="cursor: help; font-size: 0.85em;"></i></div>';
                    html += `<p><strong>Profit Margin:</strong> ${arbitrage.profit_margin}%</p>`;
                    html += `<p><strong>Optimal Stakes (per $100):</strong></p>`;
                    html += `<ul style="list-style: none; padding-left: 0;">`;
                    
                    if (arbitrage.best_odds && arbitrage.best_odds.home) {
                        html += `<li class="mb-2">üí∞ <strong>Home:</strong> $${arbitrage.stakes.home} @ <span class="text-primary">${arbitrage.best_odds.home.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.home.price.toFixed(2)}</span></li>`;
                    }
                    if (arbitrage.best_odds && arbitrage.best_odds.draw) {
                        html += `<li class="mb-2">üí∞ <strong>Draw:</strong> $${arbitrage.stakes.draw} @ <span class="text-primary">${arbitrage.best_odds.draw.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.draw.price.toFixed(2)}</span></li>`;
                    }
                    if (arbitrage.best_odds && arbitrage.best_odds.away) {
                        html += `<li class="mb-2">üí∞ <strong>Away:</strong> $${arbitrage.stakes.away} @ <span class="text-primary">${arbitrage.best_odds.away.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.away.price.toFixed(2)}</span></li>`;
                    }
                    
                    html += `</ul>`;
                    html += `<p class="small text-muted mt-3"><i class="fas fa-info-circle me-1"></i>Guaranteed profit: $${arbitrage.profit_margin} per $100 wagered</p>`;
                    html += '</div>';
                }
                
                // Add Betting Tips (include Over/Under, xG, and Elo predictions if available)
                const eloPreds = match.elo_predictions || null;
                html += generateBettingTips(pred1x2, currentOverUnderData, currentXgData, eloPreds);
                
                bettingAnalysis.innerHTML = html;
                
                // Tooltips will be auto-initialized by the global MutationObserver
            }
            
            function displayBettingAnalysis(match) {
                const analysis = match.betting_analysis || {};
                
                if (Object.keys(analysis).length === 0) {
                    bettingAnalysis.innerHTML = `<p class="text-muted">No betting analysis available</p>`;
                    return;
                }
                
                let html = '';
                
                for (const [title, content] of Object.entries(analysis)) {
                    html += `
                        <div class="analysis-section mb-3">
                            <div class="analysis-title">${title}</div>
                            <div>${content}</div>
                        </div>
                    `;
                }
                
                bettingAnalysis.innerHTML = html;
            }
            
            function loadingSpinner() {
                return `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
            }
            
            // Initialize Bootstrap tooltips with event delegation for dynamic content
            function initTooltips() {
                console.log('üîß Initializing tooltips...');
                
                // Dispose all existing tooltip instances first
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                    const instance = bootstrap.Tooltip.getInstance(el);
                    if (instance) instance.dispose();
                });
                
                // Initialize tooltips with event delegation support
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                console.log(`üîß Creating ${tooltipTriggerList.length} tooltips`);
                
                tooltipTriggerList.forEach(el => {
                    new bootstrap.Tooltip(el, {
                        html: true,
                        trigger: 'hover focus',  // Add focus for better accessibility
                        boundary: 'window',
                        sanitize: false  // Allow HTML content without sanitization
                    });
                });
            }
            
            // Global initialization on page load
            document.addEventListener('DOMContentLoaded', function() {
                initTooltips();
            });
            
            // Use MutationObserver to auto-initialize tooltips when new content is added
            const tooltipObserver = new MutationObserver((mutations) => {
                let shouldReinit = false;
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            if (node.hasAttribute && node.hasAttribute('data-bs-toggle')) {
                                shouldReinit = true;
                            } else if (node.querySelectorAll) {
                                const tooltips = node.querySelectorAll('[data-bs-toggle="tooltip"]');
                                if (tooltips.length > 0) shouldReinit = true;
                            }
                        }
                    });
                });
                if (shouldReinit) {
                    console.log('üîß Auto-reinitializing tooltips for new content');
                    initTooltips();
                }
            });
            
            // Start observing the document for tooltip additions
            tooltipObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Auto-load popular upcoming matches on page load
            getUpcomingMatches('CL');
        });
        
        // Theme toggle functionality (outside DOMContentLoaded for onclick access)
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            // Toggle dark theme class
            body.classList.toggle('dark-theme');
            
            // Update button icon and text
            const isDark = body.classList.contains('dark-theme');
            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            }
            
            // Refresh charts if they exist (they'll pick up new theme colors)
            if (window.homeXgChart) {
                const homeCanvas = document.getElementById('home-xg-chart');
                if (homeCanvas && currentMatchData && currentXgData && currentXgData.home_stats && currentXgData.home_stats.recent_matches) {
                    window.homeXgChart.destroy();
                    window.homeXgChart = createXgTrendChart('home-xg-chart', currentXgData.home_stats.recent_matches, currentMatchData.home_team);
                }
            }
            if (window.awayXgChart) {
                const awayCanvas = document.getElementById('away-xg-chart');
                if (awayCanvas && currentMatchData && currentXgData && currentXgData.away_stats && currentXgData.away_stats.recent_matches) {
                    window.awayXgChart.destroy();
                    window.awayXgChart = createXgTrendChart('away-xg-chart', currentXgData.away_stats.recent_matches, currentMatchData.away_team);
                }
            }
        }
        
        // Initialize theme from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
            }
        });
    </script>
</body>
</html>
