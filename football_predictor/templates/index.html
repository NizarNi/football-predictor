<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Prediction - Safe Bet Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #0ea5e9;
            --accent-color: #f59e0b;
            --background-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --muted-text: #64748b;
            --analysis-bg: #f1f5f9;
            --league-badge-bg: #e2e8f0;
            --probability-bar-bg: #e2e8f0;
            --autocomplete-bg: #ffffff;
            --autocomplete-hover: #f8f9fa;
            --autocomplete-border: #dddddd;
        }
        
        body.dark-theme {
            --primary-color: #6366f1;
            --secondary-color: #22d3ee;
            --accent-color: #f59e0b;
            --background-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #e2e8f0;
            --border-color: #334155;
            --muted-text: #94a3b8;
            --analysis-bg: #334155;
            --league-badge-bg: #334155;
            --probability-bar-bg: #334155;
            --autocomplete-bg: #1e293b;
            --autocomplete-hover: #334155;
            --autocomplete-border: #475569;
        }
        
        /* Dark mode text visibility fixes */
        body.dark-theme #match-context {
            color: var(--text-color);
        }
        
        body.dark-theme #match-context div:not([class*="text-"]),
        body.dark-theme #match-context span:not([class*="text-"]):not([class*="badge"]),
        body.dark-theme #match-context p:not([class*="text-"]) {
            color: var(--text-color);
        }
        
        body.dark-theme .table {
            color: var(--text-color);
        }
        
        body.dark-theme .table strong,
        body.dark-theme #match-context strong:not([class*="text-"]) {
            color: #f1f5f9;
        }
        
        body.dark-theme .text-muted {
            color: var(--muted-text) !important;
        }
        
        body.dark-theme h6, 
        body.dark-theme h5, 
        body.dark-theme h4 {
            color: var(--text-color);
        }
        
        body.dark-theme .alert {
            color: var(--text-color);
        }
        
        body.dark-theme .text-primary {
            color: var(--primary-color) !important;
        }
        
        body.dark-theme .text-danger {
            color: #ef4444 !important;
        }
        
        body.dark-theme .text-success {
            color: #10b981 !important;
        }
        
        body.dark-theme .badge {
            color: white;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .card {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background-color: var(--card-bg);
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #152b63;
            border-color: #152b63;
        }
        
        body.dark-theme .btn-primary:hover {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .match-card {
            cursor: pointer;
        }
        
        .match-card:hover {
            border-color: var(--secondary-color);
        }
        
        .match-card.popular-match {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, #fff9e6 0%, var(--card-bg) 100%);
        }
        
        body.dark-theme .match-card.popular-match {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--card-bg) 100%);
        }
        
        .match-card.popular-match::before {
            content: "‚≠ê POPULAR";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .match-card.arbitrage-match {
            border: 2px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, var(--card-bg) 100%);
        }
        
        body.dark-theme .match-card.arbitrage-match {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, var(--card-bg) 100%);
        }
        
        .match-card.arbitrage-match::after {
            content: "üí∞ ARBITRAGE";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #10b981;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .match-card.safe-bet-match {
            border: 2px solid #6366f1;
            background: linear-gradient(135deg, #eff6ff 0%, var(--card-bg) 100%);
        }
        
        body.dark-theme .match-card.safe-bet-match {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, var(--card-bg) 100%);
        }
        
        .match-card.safe-bet-match::after {
            content: "üéØ SAFE BET";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #6366f1;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .match-card {
            position: relative;
        }
        
        .prediction-badge {
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .safe-bet {
            background-color: #10b981;
            color: white;
        }
        
        .risky-bet {
            background-color: #f59e0b;
            color: white;
        }
        
        .very-risky {
            background-color: #ef4444;
            color: white;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .team-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
            margin-right: 10px;
        }
        
        .odds-table {
            font-size: 0.9rem;
        }
        
        .odds-table th, .odds-table td {
            padding: 8px;
        }
        
        .stats-bar {
            height: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .home-stats {
            background-color: var(--primary-color);
        }
        
        .away-stats {
            background-color: var(--secondary-color);
        }
        
        .exact-score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .exact-score-item:last-child {
            border-bottom: none;
        }
        
        .probability-bar {
            height: 20px;
            border-radius: 10px;
            background-color: var(--probability-bar-bg);
            overflow: hidden;
            margin: 5px 0;
            transition: background-color 0.3s ease;
        }
        
        .probability-fill {
            height: 100%;
            background-color: var(--secondary-color);
        }
        
        .league-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: var(--league-badge-bg);
            color: var(--text-color);
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }
        
        .match-date {
            font-size: 0.8rem;
            color: var(--muted-text);
        }
        
        .analysis-section {
            background-color: var(--analysis-bg);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        
        .analysis-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            z-index: 999999;
            background: var(--autocomplete-bg);
            border: 1px solid var(--autocomplete-border);
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            width: calc(100% - 12px);
            margin-top: 2px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .autocomplete-item:hover {
            background-color: var(--autocomplete-hover);
        }
        
        .autocomplete-item .team-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .autocomplete-item .team-alias {
            font-size: 0.85rem;
            color: var(--muted-text);
            margin-left: 5px;
        }
        
        .autocomplete-item .team-league {
            font-size: 0.75rem;
            color: var(--muted-text);
            display: block;
        }
        
        @media (max-width: 768px) {
            .card-header {
                font-size: 1rem;
            }
            
            .prediction-badge {
                font-size: 0.8rem;
                padding: 5px 8px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-futbol me-2"></i>
                Football Prediction - Safe Bet Analyzer
            </a>
            <button id="theme-toggle" class="btn btn-outline-light btn-sm" onclick="toggleTheme()">
                <i id="theme-icon" class="fas fa-moon"></i>
                <span id="theme-text" class="ms-2 d-none d-md-inline">Dark Mode</span>
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-search me-2"></i> Find Matches
                    </div>
                    <div class="card-body">
                        <!-- Centered Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-8 offset-md-2" style="position: relative; z-index: 100000;">
                                <div style="position: relative; z-index: 100001;">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" id="team-search" class="form-control" placeholder="Search by team name or nickname (PSG, Barca, Bayern)..." autocomplete="off">
                                        <button class="btn btn-primary" id="search-btn">
                                            Search
                                        </button>
                                    </div>
                                    <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Bar -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap align-items-center justify-content-center gap-3">
                                    <div class="d-flex align-items-center">
                                        <label class="me-2 mb-0 fw-bold">
                                            <i class="fas fa-filter me-1"></i> Show Only:
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="arbitrage-filter-checkbox">
                                        <label class="form-check-label" for="arbitrage-filter-checkbox">
                                            üí∞ Arbitrage Opportunities
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="safe-bets-checkbox">
                                        <label class="form-check-label" for="safe-bets-checkbox">
                                            üéØ Safe Bet Opportunities (‚â•75%)
                                        </label>
                                    </div>
                                    
                                    <div id="filter-badge" class="badge bg-success" style="display: none; font-size: 0.9rem;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- League Browse Buttons -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-2">Browse by League:</small>
                                    <div class="d-flex flex-wrap justify-content-center">
                                        <button class="btn btn-outline-primary m-1" data-league="PL">Premier League</button>
                                        <button class="btn btn-outline-primary m-1" data-league="PD">La Liga</button>
                                        <button class="btn btn-outline-primary m-1" data-league="BL1">Bundesliga</button>
                                        <button class="btn btn-outline-primary m-1" data-league="SA">Serie A</button>
                                        <button class="btn btn-outline-primary m-1" data-league="FL1">Ligue 1</button>
                                        <button class="btn btn-outline-primary m-1" data-league="CL">Champions League</button>
                                        <button class="btn btn-outline-primary m-1" data-league="EL">Europa League</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div id="matches-container">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calendar-alt me-2"></i> Matches
                        </div>
                        <div class="card-body">
                            <div id="matches-list">
                                <div class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div id="prediction-container" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i> Match Prediction
                        </div>
                        <div class="card-body">
                            <div id="match-details">
                                <h4 id="match-teams" class="mb-3"></h4>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span id="match-league" class="league-badge"></span>
                                    <span id="match-date" class="match-date"></span>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-trophy me-2"></i> 1X2 Prediction
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Based on 30+ bookmaker odds. Considers: team form, injuries, head-to-head records, betting market movements. Source: The Odds API" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="prediction-1x2">
                                                <div class="loading">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <i class="fas fa-chart-line me-2"></i> Match Context
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Team standings, recent form, and Expected Goals (xG) statistics. Form and xG data: FBref. Standings: football-data.org" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="match-context">
                                                <p class="text-muted">Select a match to view context</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-exchange-alt me-2"></i> Over/Under Predictions
                                            <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Averaged across 2.25, 2.5, and 2.75 goal lines from 30+ bookmakers for more robust predictions. Source: The Odds API" style="cursor: help; font-size: 0.9em;"></i>
                                        </div>
                                        <div class="card-body">
                                            <div id="prediction-over-under">
                                                <div class="text-center">
                                                    <button id="load-over-under-btn" class="btn btn-primary">
                                                        <i class="fas fa-chart-bar me-2"></i> Show Over/Under Odds
                                                    </button>
                                                    <p class="text-muted mt-2 small">Click to fetch detailed over/under predictions from bookmakers</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-chart-bar me-2"></i> Betting Analysis
                                        </div>
                                        <div class="card-body">
                                            <div id="betting-analysis">
                                                <div class="text-center">
                                                    <button onclick="loadBettingAnalysis()" class="btn btn-primary">
                                                        <i class="fas fa-coins me-2"></i> Show Betting Analysis
                                                    </button>
                                                    <p class="text-muted mt-2 small">View arbitrage opportunities, best odds, and betting tips</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">¬© 2025 Football Prediction - Safe Bet Analyzer</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables for theme toggle access
        let currentMatchData = null;
        let currentOverUnderData = null;
        let currentXgData = null;
        
        // Theme-aware color helper functions (global scope for theme toggle)
        function isDarkTheme() {
            return document.body.classList.contains('dark-theme');
        }
        
        function getThemeColors() {
            const dark = isDarkTheme();
            return {
                primary: dark ? '#6366f1' : '#1e3a8a',
                secondary: dark ? '#22d3ee' : '#0ea5e9',
                muted: dark ? '#94a3b8' : '#64748b',
                xgFor: '#28a745',  // Keep green for xGF
                xgAgainst: '#dc3545',  // Keep red for xGA
                winGreen: '#28a745',
                drawGray: dark ? '#94a3b8' : '#6c757d',
                lossRed: '#dc3545',
                chartGrid: dark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(0, 0, 0, 0.05)',
                chartText: dark ? '#94a3b8' : '#64748b',
                infoBoxBg: dark ? 'rgba(99, 102, 241, 0.15)' : '#e7f3ff',
                infoBoxBorder: dark ? 'rgba(99, 102, 241, 0.3)' : '#b3d9ff',
                infoBoxIcon: dark ? '#6366f1' : '#0066cc',
                xgAnalysisBg: dark ? 'rgba(99, 102, 241, 0.15)' : '#f0f4ff',
                xgAnalysisBorder: dark ? 'rgba(99, 102, 241, 0.3)' : '#6366f1',
                xgAnalysisText: dark ? '#818cf8' : '#6366f1'
            };
        }
        
        // Format form indicators helper (global scope for theme toggle)
        function formatFormIndicators(formString) {
            if (!formString) return '';
            
            const colors = getThemeColors();
            const formArray = formString.split('');
            return `<div style="display: inline-flex; gap: 2px; white-space: nowrap;">` + formArray.map(result => {
                let bgColor = '';
                
                if (result === 'W') {
                    bgColor = colors.winGreen;
                } else if (result === 'D') {
                    bgColor = colors.drawGray;
                } else if (result === 'L') {
                    bgColor = colors.lossRed;
                }
                
                return `<span style="display: inline-block; width: 24px; height: 24px; background-color: ${bgColor}; color: white; text-align: center; line-height: 24px; font-size: 12px; font-weight: bold; border-radius: 3px;">${result}</span>`;
            }).join('') + `</div>`;
        }
        
        // Create xG trend chart helper (global scope for theme toggle)
        function createXgTrendChart(canvasId, recentMatches, teamName) {
            if (!recentMatches || recentMatches.length === 0) return null;
            
            const matches = [...recentMatches];
            const colors = getThemeColors();
            
            const rollingWindow = 5;
            const xgForRolling = [];
            const xgAgainstRolling = [];
            const labels = [];
            
            for (let i = 0; i < matches.length; i++) {
                const startIdx = Math.max(0, i - rollingWindow + 1);
                const window = matches.slice(startIdx, i + 1);
                
                const avgXgFor = window.reduce((sum, m) => sum + m.xg_for, 0) / window.length;
                const avgXgAgainst = window.reduce((sum, m) => sum + m.xg_against, 0) / window.length;
                
                xgForRolling.push(avgXgFor);
                xgAgainstRolling.push(avgXgAgainst);
                
                const vs = matches[i].is_home ? 'vs' : '@';
                labels.push(`${vs} ${matches[i].opponent.substring(0, 10)}`);
            }
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'xG For (Rolling Avg)',
                            data: xgForRolling,
                            borderColor: colors.xgFor,
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'xG Against (Rolling Avg)',
                            data: xgAgainstRolling,
                            borderColor: colors.xgAgainst,
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 },
                                color: colors.chartText
                            }
                        },
                        title: {
                            display: true,
                            text: `${teamName} - Rolling 5-Match xG Trend`,
                            font: { size: 12, weight: 'bold' },
                            color: colors.chartText
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const match = matches[idx];
                                    const vs = match.is_home ? 'vs' : '@';
                                    const result = match.result || 'N/A';
                                    const score = match.score || '';
                                    return `${vs} ${match.opponent} ${score ? '(' + score + ')' : ''} - ${result}`;
                                },
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const match = matches[idx];
                                    const rollingAvg = context.parsed.y.toFixed(2);
                                    const actualXg = context.datasetIndex === 0 ? match.xg_for.toFixed(2) : match.xg_against.toFixed(2);
                                    const metric = context.datasetIndex === 0 ? 'xGF' : 'xGA';
                                    return [
                                        `Rolling Avg: ${rollingAvg}`,
                                        `This Match ${metric}: ${actualXg}`
                                    ];
                                },
                                footer: function(tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const xgFor = xgForRolling[idx];
                                    const xgAgainst = xgAgainstRolling[idx];
                                    if (xgFor > xgAgainst) {
                                        return '‚úÖ Good form (Creating > Conceding)';
                                    } else if (xgAgainst > xgFor) {
                                        return '‚ùå Struggling (Conceding > Creating)';
                                    } else {
                                        return '‚öñÔ∏è Balanced';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Expected Goals per Game',
                                font: { size: 11, weight: 'bold' },
                                color: colors.chartText
                            },
                            ticks: {
                                font: { size: 10 },
                                color: colors.chartText
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return isDarkTheme() ? 'rgba(148, 163, 184, 0.3)' : 'rgba(0, 0, 0, 0.3)';
                                    }
                                    return colors.chartGrid;
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                color: colors.chartText
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const teamSearchInput = document.getElementById('team-search');
            const searchBtn = document.getElementById('search-btn');
            const leagueButtons = document.querySelectorAll('[data-league]');
            const matchesList = document.getElementById('matches-list');
            const predictionContainer = document.getElementById('prediction-container');
            const matchTeams = document.getElementById('match-teams');
            const matchLeague = document.getElementById('match-league');
            const matchDate = document.getElementById('match-date');
            const prediction1x2 = document.getElementById('prediction-1x2');
            const predictionOverUnder = document.getElementById('prediction-over-under');
            const bettingAnalysis = document.getElementById('betting-analysis');
            const matchContext = document.getElementById('match-context');
            
            // Comprehensive team database with nicknames and aliases (unique aliases only)
            const teamDatabase = [
                { name: "Arsenal", aliases: ["Gunners", "AFC"], league: "Premier League" },
                { name: "Liverpool", aliases: ["Reds", "LFC"], league: "Premier League" },
                { name: "Manchester United", aliases: ["Man Utd", "Man United", "United", "Red Devils", "MUFC"], league: "Premier League" },
                { name: "Manchester City", aliases: ["Man City", "City", "Citizens", "MCFC"], league: "Premier League" },
                { name: "Chelsea", aliases: ["Blues", "CFC"], league: "Premier League" },
                { name: "Tottenham", aliases: ["Spurs", "Tottenham Hotspur", "THFC"], league: "Premier League" },
                { name: "Newcastle", aliases: ["Newcastle United", "Magpies", "NUFC"], league: "Premier League" },
                { name: "Aston Villa", aliases: ["Villa", "AVFC"], league: "Premier League" },
                { name: "Brighton", aliases: ["Brighton & Hove Albion", "Seagulls", "BHAFC"], league: "Premier League" },
                { name: "West Ham", aliases: ["West Ham United", "Hammers", "WHUFC"], league: "Premier League" },
                { name: "Barcelona", aliases: ["Barca", "Bar√ßa", "Blaugrana"], league: "La Liga" },
                { name: "Real Madrid", aliases: ["Madrid", "Real", "Los Blancos", "RM"], league: "La Liga" },
                { name: "Atletico Madrid", aliases: ["Atleti", "Atletico", "ATM"], league: "La Liga" },
                { name: "Sevilla", aliases: ["SFC"], league: "La Liga" },
                { name: "Valencia", aliases: ["VCF"], league: "La Liga" },
                { name: "Real Betis", aliases: ["Betis"], league: "La Liga" },
                { name: "Bayern Munich", aliases: ["Bayern", "FCB", "FC Bayern", "Die Roten"], league: "Bundesliga" },
                { name: "Borussia Dortmund", aliases: ["Dortmund", "BVB", "Die Schwarzgelben"], league: "Bundesliga" },
                { name: "RB Leipzig", aliases: ["Leipzig", "RBL"], league: "Bundesliga" },
                { name: "Bayer Leverkusen", aliases: ["Leverkusen", "B04"], league: "Bundesliga" },
                { name: "Juventus", aliases: ["Juve", "Bianconeri", "Old Lady"], league: "Serie A" },
                { name: "Inter Milan", aliases: ["Inter", "Internazionale", "Nerazzurri"], league: "Serie A" },
                { name: "AC Milan", aliases: ["Milan", "Rossoneri", "ACM"], league: "Serie A" },
                { name: "Roma", aliases: ["AS Roma", "Giallorossi"], league: "Serie A" },
                { name: "Napoli", aliases: ["SSC Napoli", "Partenopei"], league: "Serie A" },
                { name: "Lazio", aliases: ["SS Lazio", "Biancocelesti"], league: "Serie A" },
                { name: "Paris Saint Germain", aliases: ["PSG", "Paris SG", "Paris"], league: "Ligue 1" },
                { name: "Marseille", aliases: ["OM", "Olympique Marseille"], league: "Ligue 1" },
                { name: "Lyon", aliases: ["Olympique Lyon", "OL"], league: "Ligue 1" },
                { name: "Monaco", aliases: ["AS Monaco", "ASM"], league: "Ligue 1" },
                { name: "Lille", aliases: ["LOSC"], league: "Ligue 1" }
            ];
            
            // Fuzzy team name normalization for logo matching (league-gated to prevent cross-league collisions)
            function fuzzyNormalizeTeamName(apiName, league) {
                apiName = apiName.trim();
                const lower = apiName.toLowerCase();
                
                // Normalize league identifier to handle variations
                const leagueLower = (league || '').toLowerCase();
                const isPremierLeague = leagueLower.includes('premier') || leagueLower === 'epl';
                const isLaLiga = leagueLower.includes('la liga') || leagueLower.includes('spain') || leagueLower === 'pd';
                const isBundesliga = leagueLower.includes('bundesliga') || leagueLower.includes('germany') || leagueLower === 'bl1';
                const isSerieA = leagueLower.includes('serie a') || leagueLower.includes('italy') || leagueLower === 'sa';
                const isLigue1 = leagueLower.includes('ligue 1') || leagueLower.includes('france') || leagueLower === 'fl1';
                
                // League-specific patterns to avoid cross-league collisions (e.g., Inter Miami vs Inter Milan)
                const patterns = [
                    // Bundesliga teams
                    { test: /^bayern/i, result: 'FC Bayern M√ºnchen', leagues: [isBundesliga] },
                    
                    // La Liga teams
                    { test: /^bar[c√ß]a|^barcelona/i, result: 'FC Barcelona', leagues: [isLaLiga] },
                    { test: /^real\s+madrid/i, result: 'Real Madrid CF', leagues: [isLaLiga] },
                    { test: /^atl[e√©]tico\s+madrid/i, result: 'Atl√©tico de Madrid', leagues: [isLaLiga] },
                    
                    // Serie A teams (Inter/Milan only for Serie A to avoid Inter Miami collision)
                    { test: /^inter(?:\s+milan)?$/i, result: 'FC Internazionale Milano', leagues: [isSerieA] },
                    { test: /^(?:ac\s+)?milan$/i, result: 'AC Milan', leagues: [isSerieA] },
                    { test: /^juve|^juventus/i, result: 'Juventus FC', leagues: [isSerieA] },
                    
                    // Ligue 1 teams (PSG only for Ligue 1 to avoid Paris FC collision)
                    { test: /^psg$|^paris\s+saint/i, result: 'Paris Saint-Germain', leagues: [isLigue1] },
                    
                    // Premier League teams
                    { test: /^arsenal$/i, result: 'Arsenal FC', leagues: [isPremierLeague] },
                    { test: /^liverpool$/i, result: 'Liverpool FC', leagues: [isPremierLeague] },
                    { test: /^chelsea$/i, result: 'Chelsea FC', leagues: [isPremierLeague] },
                    { test: /^(?:man(?:chester)?\s+)?city$/i, result: 'Manchester City', leagues: [isPremierLeague] },
                    { test: /^(?:man(?:chester)?\s+)?united$/i, result: 'Manchester United', leagues: [isPremierLeague] },
                    { test: /^tottenham|^spurs$/i, result: 'Tottenham Hotspur', leagues: [isPremierLeague] },
                    { test: /^newcastle/i, result: 'Newcastle United', leagues: [isPremierLeague] },
                    { test: /^west\s+ham/i, result: 'West Ham United', leagues: [isPremierLeague] },
                    { test: /^aston\s+villa$/i, result: 'Aston Villa', leagues: [isPremierLeague] },
                    { test: /^brighton/i, result: 'Brighton & Hove Albion', leagues: [isPremierLeague] },
                    { test: /^(?:afc\s+)?bournemouth$/i, result: 'AFC Bournemouth', leagues: [isPremierLeague] },
                    { test: /^wolves|^wolverhampton/i, result: 'Wolverhampton Wanderers', leagues: [isPremierLeague] },
                    { test: /^everton$/i, result: 'Everton FC', leagues: [isPremierLeague] },
                    { test: /^brentford$/i, result: 'Brentford FC', leagues: [isPremierLeague] },
                    { test: /^fulham$/i, result: 'Fulham FC', leagues: [isPremierLeague] },
                    { test: /^crystal\s+palace$/i, result: 'Crystal Palace', leagues: [isPremierLeague] },
                    { test: /^nottingham\s+forest$/i, result: 'Nottingham Forest', leagues: [isPremierLeague] },
                    { test: /^southampton$/i, result: 'Southampton FC', leagues: [isPremierLeague] },
                    { test: /^leicester/i, result: 'Leicester City', leagues: [isPremierLeague] },
                    { test: /^ipswich/i, result: 'Ipswich Town', leagues: [isPremierLeague] },
                ];
                
                // Check pattern matches with league gating
                for (const pattern of patterns) {
                    // Only apply pattern if ANY of the league conditions match
                    const leagueMatches = pattern.leagues.some(condition => condition === true);
                    if (leagueMatches && pattern.test.test(apiName)) {
                        return pattern.result;
                    }
                }
                
                // If no pattern matched, return original (safe fallback)
                return apiName;
            }
            
            // Team name to filename mapping (Odds API name ‚Üí GitHub filename)
            function normalizeTeamNameForLogo(teamName) {
                const nameMap = {
                    // Premier League
                    'Arsenal': 'Arsenal FC',
                    'Liverpool': 'Liverpool FC',
                    'Manchester United': 'Manchester United',
                    'Manchester City': 'Manchester City',
                    'Chelsea': 'Chelsea FC',
                    'Tottenham': 'Tottenham Hotspur',
                    'Tottenham Hotspur': 'Tottenham Hotspur',
                    'Newcastle': 'Newcastle United',
                    'Newcastle United': 'Newcastle United',
                    'Aston Villa': 'Aston Villa',
                    'Brighton': 'Brighton & Hove Albion',
                    'Brighton & Hove Albion': 'Brighton & Hove Albion',
                    'West Ham': 'West Ham United',
                    'West Ham United': 'West Ham United',
                    'Everton': 'Everton FC',
                    'Brentford': 'Brentford FC',
                    'Fulham': 'Fulham FC',
                    'Crystal Palace': 'Crystal Palace',
                    'AFC Bournemouth': 'AFC Bournemouth',
                    'Bournemouth': 'AFC Bournemouth',
                    'Wolves': 'Wolverhampton Wanderers',
                    'Wolverhampton': 'Wolverhampton Wanderers',
                    'Nottingham Forest': 'Nottingham Forest',
                    'Southampton': 'Southampton FC',
                    'Leicester': 'Leicester City',
                    'Leicester City': 'Leicester City',
                    'Ipswich': 'Ipswich Town',
                    'Ipswich Town': 'Ipswich Town',
                    // La Liga
                    'Barcelona': 'FC Barcelona',
                    'Real Madrid': 'Real Madrid CF',
                    'Atletico Madrid': 'Atl√©tico de Madrid',
                    'Atl√©tico Madrid': 'Atl√©tico de Madrid',
                    'Sevilla': 'Sevilla FC',
                    'Valencia': 'Valencia CF',
                    'Real Betis': 'Real Betis',
                    'Villarreal': 'Villarreal CF',
                    'Athletic Bilbao': 'Athletic Club',
                    'Real Sociedad': 'Real Sociedad',
                    // Bundesliga
                    'Bayern Munich': 'FC Bayern M√ºnchen',
                    'Bayern M√ºnchen': 'FC Bayern M√ºnchen',
                    'Borussia Dortmund': 'Borussia Dortmund',
                    'RB Leipzig': 'RB Leipzig',
                    'Bayer Leverkusen': 'Bayer 04 Leverkusen',
                    'Union Berlin': '1. FC Union Berlin',
                    'Freiburg': 'SC Freiburg',
                    'Eintracht Frankfurt': 'Eintracht Frankfurt',
                    // Serie A
                    'Juventus': 'Juventus FC',
                    'Inter': 'FC Internazionale Milano',
                    'Inter Milan': 'FC Internazionale Milano',
                    'AC Milan': 'AC Milan',
                    'Milan': 'AC Milan',
                    'Roma': 'AS Roma',
                    'AS Roma': 'AS Roma',
                    'Napoli': 'SSC Napoli',
                    'SSC Napoli': 'SSC Napoli',
                    'Lazio': 'SS Lazio',
                    'Atalanta': 'Atalanta BC',
                    'Fiorentina': 'ACF Fiorentina',
                    // Ligue 1
                    'Paris Saint-Germain': 'Paris Saint-Germain',
                    'Paris Saint Germain': 'Paris Saint-Germain',
                    'PSG': 'Paris Saint-Germain',
                    'Marseille': 'Olympique de Marseille',
                    'Lyon': 'Olympique Lyonnais',
                    'Monaco': 'AS Monaco',
                    'Lille': 'LOSC Lille',
                    'Nice': 'OGC Nice',
                    'Lens': 'RC Lens',
                    'Rennes': 'Stade Rennais FC'
                };
                
                return nameMap[teamName] || teamName;
            }
            
            // Team logo helper function
            function getTeamLogoUrl(teamName, league) {
                const leagueMap = {
                    'Premier League': 'England - Premier League',
                    'EPL': 'England - Premier League',
                    'English Premier League': 'England - Premier League',
                    'La Liga': 'Spain - LaLiga',
                    'Spanish La Liga': 'Spain - LaLiga',
                    'Spain La Liga': 'Spain - LaLiga',
                    'Bundesliga': 'Germany - Bundesliga',
                    'German Bundesliga': 'Germany - Bundesliga',
                    'Germany Bundesliga': 'Germany - Bundesliga',
                    'Serie A': 'Italy - Serie A',
                    'Italian Serie A': 'Italy - Serie A',
                    'Italy Serie A': 'Italy - Serie A',
                    'Ligue 1': 'France - Ligue 1',
                    'French Ligue 1': 'France - Ligue 1',
                    'France Ligue 1': 'France - Ligue 1',
                    'Ligue 1 - France': 'France - Ligue 1',
                    'UEFA Champions League': null,  // No CL folder, teams fallback to domestic league
                    'Champions League': null,
                    'UEFA Europa League': null,
                    'Europa League': null
                };
                
                const leagueFolder = leagueMap[league];
                if (!leagueFolder) {
                    // For UEFA competitions, we don't have logos available
                    return '';
                }
                
                // Try pattern-based fuzzy normalization first
                let normalizedTeamName = fuzzyNormalizeTeamName(teamName, league);
                
                // If fuzzy didn't change it, try the explicit mapping table
                if (normalizedTeamName === teamName) {
                    normalizedTeamName = normalizeTeamNameForLogo(teamName);
                }
                
                // Encode team name for URL (keep spaces, &, etc. as they appear in filenames)
                const teamFileName = encodeURIComponent(normalizedTeamName + '.png');
                
                return `https://raw.githubusercontent.com/luukhopman/football-logos/master/logos/${encodeURIComponent(leagueFolder)}/${teamFileName}`;
            }
            
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
            
            // Autocomplete functionality
            teamSearchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }
                
                // Find matching teams
                const matches = teamDatabase.filter(team => {
                    const nameMatch = team.name.toLowerCase().includes(query);
                    const aliasMatch = team.aliases.some(alias => alias.toLowerCase().includes(query));
                    return nameMatch || aliasMatch;
                }).slice(0, 3); // Limit to 3 results
                
                if (matches.length > 0) {
                    autocompleteDropdown.innerHTML = matches.map(team => {
                        const matchedAlias = team.aliases.find(alias => alias.toLowerCase().includes(query));
                        const displayAlias = matchedAlias ? `<span class="team-alias">(${matchedAlias})</span>` : '';
                        
                        return `
                            <div class="autocomplete-item" data-team="${team.name}">
                                <span class="team-name">${team.name}</span>
                                ${displayAlias}
                                <span class="team-league">${team.league}</span>
                            </div>
                        `;
                    }).join('');
                    
                    autocompleteDropdown.style.display = 'block';
                    
                    // Add click listeners to autocomplete items
                    document.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const teamName = this.getAttribute('data-team');
                            teamSearchInput.value = teamName;
                            autocompleteDropdown.style.display = 'none';
                            searchTeam();
                        });
                    });
                } else {
                    autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!teamSearchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                    autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Event listeners
            searchBtn.addEventListener('click', searchTeam);
            teamSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    autocompleteDropdown.style.display = 'none';
                    searchTeam();
                }
            });
            
            leagueButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const league = this.getAttribute('data-league');
                    getUpcomingMatches(league);
                });
            });
            
            // Filter control event listeners
            const arbitrageFilterCheckbox = document.getElementById('arbitrage-filter-checkbox');
            const safeBetsCheckbox = document.getElementById('safe-bets-checkbox');
            
            if (arbitrageFilterCheckbox) {
                arbitrageFilterCheckbox.addEventListener('change', applyFilters);
            }
            
            if (safeBetsCheckbox) {
                safeBetsCheckbox.addEventListener('change', applyFilters);
            }
            
            // Functions
            function normalizeTeamName(input) {
                // Check if input matches any team name or alias
                const inputLower = input.toLowerCase();
                
                for (const team of teamDatabase) {
                    // Check if it matches the canonical name
                    if (team.name.toLowerCase() === inputLower) {
                        return team.name;
                    }
                    
                    // Check if it matches any alias
                    const matchedAlias = team.aliases.find(alias => alias.toLowerCase() === inputLower);
                    if (matchedAlias) {
                        return team.name;
                    }
                }
                
                // If no match found, return original input
                return input;
            }
            
            function searchTeam() {
                let teamName = teamSearchInput.value.trim();
                if (!teamName) return;
                
                // Normalize the team name (resolve aliases to canonical names)
                teamName = normalizeTeamName(teamName);
                
                matchesList.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `team_name=${encodeURIComponent(teamName)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        matchesList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayMatches(data.matches);
                })
                .catch(error => {
                    console.error('Error:', error);
                    matchesList.innerHTML = `<p class="text-danger">Error searching for team: ${error.message}</p>`;
                });
            }
            
            function getUpcomingMatches(league) {
                matchesList.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                fetch(`/upcoming?league=${encodeURIComponent(league)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        matchesList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayMatches(data.matches);
                })
                .catch(error => {
                    console.error('Error:', error);
                    matchesList.innerHTML = `<p class="text-danger">Error getting upcoming matches: ${error.message}</p>`;
                });
            }
            
            // Helper function to get maximum confidence from betting tips
            // Note: Only checks 1X2 predictions which are available upfront
            // Over/Under data is loaded on-demand when viewing a specific match
            function getMaxBettingConfidence(match) {
                if (!match.predictions) return 0;
                
                let maxConfidence = 0;
                
                // Check 1X2 predictions (always available)
                if (match.predictions.probabilities) {
                    const probs = match.predictions.probabilities;
                    maxConfidence = Math.max(
                        probs.HOME_WIN || 0,
                        probs.DRAW || 0,
                        probs.AWAY_WIN || 0
                    );
                }
                
                // Check Over/Under if it's embedded in the match object
                // (Future enhancement: pre-load Over/Under for all matches to improve filtering)
                if (match.totals && match.totals.predictions) {
                    Object.values(match.totals.predictions).forEach(pred => {
                        if (pred.over) maxConfidence = Math.max(maxConfidence, pred.over);
                        if (pred.under) maxConfidence = Math.max(maxConfidence, pred.under);
                    });
                }
                
                return maxConfidence * 100; // Convert to percentage
            }
            
            // Update the filter badge with match counts
            function updateFilterBadge(filteredCount, totalCount, arbitrageFilter, safeBetsFilter) {
                const badge = document.getElementById('filter-badge');
                
                if (filteredCount === totalCount) {
                    badge.style.display = 'none';
                    return;
                }
                
                badge.style.display = 'inline-block';
                
                let badgeText = '';
                if (arbitrageFilter && safeBetsFilter) {
                    badgeText = `${filteredCount} Match${filteredCount === 1 ? '' : 'es'} Found`;
                } else if (arbitrageFilter) {
                    badgeText = `${filteredCount} Arbitrage ${filteredCount === 1 ? 'Opportunity' : 'Opportunities'}`;
                } else if (safeBetsFilter) {
                    badgeText = `${filteredCount} Safe Bet ${filteredCount === 1 ? 'Opportunity' : 'Opportunities'}`;
                }
                
                badge.textContent = badgeText;
            }
            
            function displayMatches(matches) {
                if (!matches || matches.length === 0) {
                    matchesList.innerHTML = `<p class="text-center text-muted">No matches found</p>`;
                    return;
                }
                
                // Store matches globally
                window.currentMatches = matches;
                
                // Get current filter settings from the top filter bar
                const arbitrageFilter = document.getElementById('arbitrage-filter-checkbox')?.checked || false;
                const safeBetsFilter = document.getElementById('safe-bets-checkbox')?.checked || false;
                
                // Apply filters
                let filteredMatches = matches;
                
                // Filter for arbitrage
                if (arbitrageFilter) {
                    filteredMatches = filteredMatches.filter(match => 
                        match.predictions && 
                        match.predictions.arbitrage && 
                        match.predictions.arbitrage.is_arbitrage
                    );
                }
                
                // Filter for safe bet opportunities (‚â•75% confidence)
                if (safeBetsFilter) {
                    filteredMatches = filteredMatches.filter(match => 
                        getMaxBettingConfidence(match) >= 75
                    );
                }
                
                // Update filter badge
                updateFilterBadge(filteredMatches.length, matches.length, arbitrageFilter, safeBetsFilter);
                
                const popularTeams = [
                    'Bayern M√ºnchen', 'Paris Saint-Germain', 'Arsenal', 'Real Madrid', 'Liverpool FC',
                    'Barcelona', 'Chelsea FC', 'Manchester City', 'Inter Milan', 'Borussia Dortmund',
                    'Atl√©tico Madrid', 'SSC Napoli', 'Palmeiras', 'AS Roma', 'Crystal Palace',
                    'Atalanta', 'Aston Villa', 'Newcastle United', 'Bayer Leverkusen', 'AC Milan',
                    'Sporting', 'Villarreal', 'Juventus', 'Flamengo', 'PSV Eindhoven',
                    'Brighton & Hove Albion', 'Galatasaray', 'Benfica', 'AFC Bournemouth', 'Real Betis',
                    'Tottenham Hotspur', 'FC Porto', 'Eintracht Frankfurt', 'Feyenoord', 'Marseille',
                    'Everton FC', 'Lille', 'RB Leipzig', 'Club Brugge', 'Slavia Prague',
                    'Union St.Gilloise', 'Olympiakos', 'Lyon', 'Lazio', 'Al Hilal',
                    'FK Red Star Belgrade', 'Brentford FC', 'Bologna', 'Athletic Bilbao', 'Manchester United'
                ];
                
                let html = '';
                filteredMatches.forEach((match, filteredIndex) => {
                    const homeTeam = match.home_team.toLowerCase();
                    const awayTeam = match.away_team.toLowerCase();
                    const isPopular = popularTeams.some(team => 
                        homeTeam.includes(team.toLowerCase()) || awayTeam.includes(team.toLowerCase())
                    );
                    const hasArbitrage = match.predictions && 
                                       match.predictions.arbitrage && 
                                       match.predictions.arbitrage.is_arbitrage;
                    const hasSafeBet = getMaxBettingConfidence(match) >= 75;
                    const popularClass = isPopular ? ' popular-match' : '';
                    const arbitrageClass = hasArbitrage ? ' arbitrage-match' : '';
                    const safeBetClass = hasSafeBet ? ' safe-bet-match' : '';
                    
                    // Find the original index in the full matches array
                    const originalIndex = matches.findIndex(m => 
                        m.home_team === match.home_team && 
                        m.away_team === match.away_team && 
                        m.commence_time === match.commence_time
                    );
                    
                    const homeLogo = getTeamLogoUrl(match.home_team, match.league);
                    const awayLogo = getTeamLogoUrl(match.away_team, match.league);
                    
                    html += `
                        <div class="card match-card mb-2${popularClass}${arbitrageClass}${safeBetClass}" data-match-index="${originalIndex}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <img src="${homeLogo}" alt="${match.home_team}" style="width: 28px; height: 28px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">
                                            <span class="fw-bold">${match.home_team}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <img src="${awayLogo}" alt="${match.away_team}" style="width: 28px; height: 28px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">
                                            <span class="fw-bold">${match.away_team}</span>
                                        </div>
                                        <div class="small text-muted mt-2">${match.league || 'Unknown League'}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small text-muted">${match.datetime || 'TBD'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                matchesList.innerHTML = html;
                
                // Add click event to match cards
                document.querySelectorAll('.match-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const matchIndex = parseInt(this.getAttribute('data-match-index'));
                        displayMatchPredictions(window.currentMatches[matchIndex]);
                    });
                });
            }
            
            // Reapply filters when filter controls change
            function applyFilters() {
                if (window.currentMatches) {
                    displayMatches(window.currentMatches);
                }
            }
            
            function displayMatchPredictions(match) {
                // Show prediction container
                predictionContainer.style.display = 'block';
                
                // Store current match data
                currentMatchData = match;
                
                // Update match details with logos
                const homeLogo = getTeamLogoUrl(match.home_team, match.league);
                const awayLogo = getTeamLogoUrl(match.away_team, match.league);
                matchTeams.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <div class="d-flex align-items-center">
                            <img src="${homeLogo}" alt="${match.home_team}" style="width: 36px; height: 36px; object-fit: contain; margin-right: 10px;" onerror="this.style.display='none'">
                            <span>${match.home_team}</span>
                        </div>
                        <span class="text-muted">vs</span>
                        <div class="d-flex align-items-center">
                            <img src="${awayLogo}" alt="${match.away_team}" style="width: 36px; height: 36px; object-fit: contain; margin-right: 10px;" onerror="this.style.display='none'">
                            <span>${match.away_team}</span>
                        </div>
                    </div>
                `;
                matchLeague.textContent = match.league || 'Unknown League';
                matchDate.textContent = match.datetime || 'TBD';
                
                // Load match context
                loadMatchContext(match);
                
                // Display predictions from Odds API
                if (match.predictions && match.predictions['1x2']) {
                    display1X2Prediction(match.predictions['1x2']);
                    resetOverUnderButton();
                    resetBettingAnalysisButton();
                } else {
                    prediction1x2.innerHTML = '<p class="text-muted">No predictions available for this match</p>';
                    resetOverUnderButton();
                    resetBettingAnalysisButton();
                }
            }
            
            function resetOverUnderButton() {
                predictionOverUnder.innerHTML = `
                    <div class="text-center">
                        <button onclick="loadOverUnderPredictions()" class="btn btn-primary">
                            <i class="fas fa-chart-bar me-2"></i> Show Over/Under Odds
                        </button>
                        <p class="text-muted mt-2 small">Click to fetch detailed over/under predictions from bookmakers</p>
                    </div>
                `;
            }
            
            function loadOverUnderPredictions() {
                console.log('loadOverUnderPredictions called');
                console.log('currentMatchData:', currentMatchData);
                
                if (!currentMatchData) {
                    console.error('No currentMatchData available');
                    predictionOverUnder.innerHTML = '<p class="text-danger">No match data available</p>';
                    return;
                }
                
                predictionOverUnder.innerHTML = loadingSpinner();
                
                const eventId = currentMatchData.event_id;
                const sportKey = currentMatchData.sport_key;
                
                console.log('eventId:', eventId, 'sportKey:', sportKey);
                
                if (!eventId || !sportKey) {
                    predictionOverUnder.innerHTML = '<p class="text-danger">Unable to load over/under odds for this match (missing event_id or sport_key)</p>';
                    return;
                }
                
                const url = `/match/${eventId}/totals?sport_key=${sportKey}`;
                console.log('Fetching:', url);
                
                fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.error) {
                        predictionOverUnder.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }
                    
                    displayTotalsData(data.totals);
                })
                .catch(error => {
                    console.error('Error fetching over/under:', error);
                    predictionOverUnder.innerHTML = `<p class="text-danger">Failed to load over/under odds: ${error.message}</p>`;
                });
            }
            
            // Make function available globally for inline onclick handler
            window.loadOverUnderPredictions = loadOverUnderPredictions;
            
            function resetBettingAnalysisButton() {
                bettingAnalysis.innerHTML = `
                    <div class="text-center">
                        <button onclick="loadBettingAnalysis()" class="btn btn-primary">
                            <i class="fas fa-coins me-2"></i> Show Betting Analysis
                        </button>
                        <p class="text-muted mt-2 small">View arbitrage opportunities, best odds, and betting tips</p>
                    </div>
                `;
            }
            
            function loadBettingAnalysis() {
                if (!currentMatchData) {
                    bettingAnalysis.innerHTML = '<p class="text-danger">No match data available</p>';
                    return;
                }
                
                bettingAnalysis.innerHTML = loadingSpinner();
                
                // Fetch xG data if not already loaded (from Match Context)
                if (!currentXgData && currentMatchData.league) {
                    const leagueMap = {
                        'UEFA Champions League': 'CL',
                        'EPL': 'PL',
                        'Premier League': 'PL',
                        'English Premier League': 'PL',
                        'La Liga': 'PD',
                        'Spanish La Liga': 'PD',
                        'Spain La Liga': 'PD',
                        'Bundesliga': 'BL1',
                        'German Bundesliga': 'BL1',
                        'Germany Bundesliga': 'BL1',
                        'Serie A': 'SA',
                        'Italian Serie A': 'SA',
                        'Italy Serie A': 'SA',
                        'Ligue 1': 'FL1',
                        'French Ligue 1': 'FL1',
                        'France Ligue 1': 'FL1',
                        'Ligue 1 - France': 'FL1',
                        'UEFA Europa League': 'EL'
                    };
                    
                    const leagueCode = leagueMap[currentMatchData.league] || currentMatchData.league;
                    
                    fetch(`/match/${currentMatchData.id}/xg?league=${leagueCode}&home_team=${encodeURIComponent(currentMatchData.home_team)}&away_team=${encodeURIComponent(currentMatchData.away_team)}`)
                    .then(r => r.json())
                    .then(xgData => {
                        currentXgData = xgData.xg || null;
                        displayOddsBasedAnalysis(currentMatchData);
                    })
                    .catch(error => {
                        console.error('Error fetching xG:', error);
                        currentXgData = null;
                        displayOddsBasedAnalysis(currentMatchData);
                    });
                } else {
                    // xG data already loaded or unavailable
                    displayOddsBasedAnalysis(currentMatchData);
                }
            }
            
            // Make function available globally for inline onclick handler
            window.loadBettingAnalysis = loadBettingAnalysis;
            
            function displayTotalsData(totalsData) {
                if (!totalsData || !totalsData.predictions || totalsData.predictions.length === 0) {
                    predictionOverUnder.innerHTML = '<p class="text-muted">No over/under odds available for this match</p>';
                    return;
                }
                
                // Store Over/Under data globally
                currentOverUnderData = totalsData;
                
                let html = `<div class="row">`;
                
                totalsData.predictions.forEach(prediction => {
                    const safetyClass = prediction.confidence >= 60 ? 'safe-bet' : 'risky-bet';
                    const safetyText = prediction.confidence >= 60 ? 'Confident' : 'Lower Confidence';
                    
                    const enhancedInfo = prediction.enhanced && prediction.lines_used ? 
                        `<p class="text-info small mt-2"><i class="fas fa-info-circle me-1"></i>Enhanced calculation using ${prediction.lines_used.join(', ')} goal lines from ${prediction.bookmaker_count} bookmakers</p>` : 
                        '';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    Over/Under ${prediction.line} Goals
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <span class="prediction-badge ${safetyClass}">
                                            ${prediction.prediction} (${prediction.confidence}%)
                                            <i class="fas ${prediction.confidence >= 60 ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                                            ${safetyText}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Over ${prediction.line}:</span>
                                            <span>${(prediction.probabilities.over * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.over * 100}%; background-color: ${getThemeColors().secondary};"></div>
                                        </div>
                                        ${prediction.best_odds.over ? `<small class="text-muted">Best odds: ${prediction.best_odds.over.price.toFixed(2)} (${prediction.best_odds.over.bookmaker})</small>` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Under ${prediction.line}:</span>
                                            <span>${(prediction.probabilities.under * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.under * 100}%; background-color: ${getThemeColors().muted};"></div>
                                        </div>
                                        ${prediction.best_odds.under ? `<small class="text-muted">Best odds: ${prediction.best_odds.under.price.toFixed(2)} (${prediction.best_odds.under.bookmaker})</small>` : ''}
                                    </div>
                                    ${enhancedInfo || `<p class="text-muted small mt-2">${prediction.bookmaker_count} bookmakers</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                predictionOverUnder.innerHTML = html;
                
                // Regenerate betting tips with Over/Under data if betting analysis is already shown
                if (bettingAnalysis.innerHTML && !bettingAnalysis.innerHTML.includes('Show Betting Analysis')) {
                    displayOddsBasedAnalysis(currentMatchData);
                }
            }
            
            function loadMatchContext(match) {
                if (!match || !match.league) {
                    matchContext.innerHTML = '<p class="text-muted">Match context unavailable</p>';
                    return;
                }
                
                // Clear xG data from previous match to prevent stale data
                currentXgData = null;
                
                matchContext.innerHTML = loadingSpinner();
                
                const leagueMap = {
                    'UEFA Champions League': 'CL',
                    'EPL': 'PL',
                    'Premier League': 'PL',
                    'English Premier League': 'PL',
                    'La Liga': 'PD',
                    'Spanish La Liga': 'PD',
                    'Spain La Liga': 'PD',
                    'Bundesliga': 'BL1',
                    'German Bundesliga': 'BL1',
                    'Germany Bundesliga': 'BL1',
                    'Serie A': 'SA',
                    'Italian Serie A': 'SA',
                    'Italy Serie A': 'SA',
                    'Ligue 1': 'FL1',
                    'French Ligue 1': 'FL1',
                    'France Ligue 1': 'FL1',
                    'Ligue 1 - France': 'FL1',
                    'UEFA Europa League': 'EL'
                };
                
                const leagueCode = leagueMap[match.league] || match.league;
                
                // Fetch both standings context and xG data in parallel
                Promise.all([
                    fetch(`/match/${match.id}/context?league=${leagueCode}&home_team=${encodeURIComponent(match.home_team)}&away_team=${encodeURIComponent(match.away_team)}`).then(r => r.json()),
                    fetch(`/match/${match.id}/xg?league=${leagueCode}&home_team=${encodeURIComponent(match.home_team)}&away_team=${encodeURIComponent(match.away_team)}`).then(r => r.json())
                ])
                .then(([contextData, xgData]) => {
                    if (contextData.error) {
                        matchContext.innerHTML = `<p class="text-muted">${contextData.narrative || 'Context unavailable'}</p>`;
                        return;
                    }
                    
                    // Merge xG data into context data
                    contextData.xg = xgData.xg || null;
                    displayMatchContextData(contextData);
                })
                .catch(error => {
                    console.error('Error loading context:', error);
                    matchContext.innerHTML = '<p class="text-muted">Unable to load match context</p>';
                });
            }
            
            
            function displayMatchContextData(contextData) {
                let html = '';
                
                if (contextData.narrative) {
                    const alertClass = contextData.has_data ? 'alert-info' : 'alert-warning';
                    const icon = contextData.has_data ? 'fa-info-circle' : 'fa-exclamation-triangle';
                    html += `<div class="alert ${alertClass} mb-3 small"><i class="fas ${icon} me-2"></i>${contextData.narrative}</div>`;
                }
                
                const hasHomeData = contextData.home_team && (contextData.home_team.position || contextData.home_team.points || contextData.home_team.form);
                const hasAwayData = contextData.away_team && (contextData.away_team.position || contextData.away_team.points || contextData.away_team.form);
                
                if (hasHomeData || hasAwayData) {
                    html += `<div class="row">`;
                    
                    // Home team column
                    html += `<div class="col-md-6 ${hasAwayData ? 'border-end' : ''}">`;
                    const homeLogoUrl = getTeamLogoUrl(currentMatchData.home_team, currentMatchData.league);
                    html += `<h6 class="fw-bold text-primary mb-2"><i class="fas fa-home me-1"></i><img src="${homeLogoUrl}" alt="${currentMatchData.home_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.home_team}</h6>`;
                    
                    if (hasHomeData) {
                        html += `<table class="table table-sm table-borderless mb-0"><tbody>`;
                        if (contextData.home_team.position) {
                            html += `<tr><td class="text-muted" style="width: 80px;">Position:</td><td><span class="badge bg-secondary">${contextData.home_team.position}</span></td></tr>`;
                        }
                        if (contextData.home_team.points !== null && contextData.home_team.points !== undefined) {
                            html += `<tr><td class="text-muted">Points:</td><td><strong>${contextData.home_team.points}</strong></td></tr>`;
                        }
                        if (contextData.home_team.form) {
                            html += `<tr><td class="text-muted">Form:</td><td>${formatFormIndicators(contextData.home_team.form)}</td></tr>`;
                        }
                        // Add xG metrics if available
                        if (contextData.xg && contextData.xg.home_stats) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-chart-line me-1"></i>xG For: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Expected Goals created per game based on shot quality and positions" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.home_stats.xg_for_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-shield-alt me-1"></i>xGA: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Expected Goals conceded per game (Post-Shot xG faced by goalkeeper)" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.home_stats.xg_against_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            if (contextData.xg.home_stats.scoring_clinicality !== undefined && contextData.xg.home_stats.scoring_clinicality !== null) {
                                const clinicality = contextData.xg.home_stats.scoring_clinicality;
                                const clinicalityClass = clinicality > 0 ? 'text-success' : 'text-danger';
                                html += `<tr><td class="text-muted">Scoring Clinicality: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Goals scored vs expected per game. Positive = clinical finishing, Negative = wasteful" style="cursor: help; font-size: 0.8em;"></i></td><td class="${clinicalityClass}"><strong>${clinicality > 0 ? '+' : ''}${clinicality}</strong> <small class="text-muted">/game</small></td></tr>`;
                            }
                            // Add xG-based form (Last 5 matches from FBref)
                            if (contextData.xg.home_stats.form) {
                                html += `<tr><td class="text-muted">Recent Form: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Last 5 match results from FBref (üü© Win, ‚¨ú Draw, üü• Loss)" style="cursor: help; font-size: 0.8em;"></i></td><td>${formatFormIndicators(contextData.xg.home_stats.form)}</td></tr>`;
                            }
                        }
                        html += `</tbody></table>`;
                    } else {
                        html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                    }
                    html += `</div>`;
                    
                    // Away team column
                    html += `<div class="col-md-6">`;
                    const awayLogoUrl = getTeamLogoUrl(currentMatchData.away_team, currentMatchData.league);
                    html += `<h6 class="fw-bold text-danger mb-2"><i class="fas fa-plane-departure me-1"></i><img src="${awayLogoUrl}" alt="${currentMatchData.away_team}" style="height: 20px; width: 20px; object-fit: contain; margin-right: 8px;" onerror="this.style.display='none'">${currentMatchData.away_team}</h6>`;
                    
                    if (hasAwayData) {
                        html += `<table class="table table-sm table-borderless mb-0"><tbody>`;
                        if (contextData.away_team.position) {
                            html += `<tr><td class="text-muted" style="width: 80px;">Position:</td><td><span class="badge bg-secondary">${contextData.away_team.position}</span></td></tr>`;
                        }
                        if (contextData.away_team.points !== null && contextData.away_team.points !== undefined) {
                            html += `<tr><td class="text-muted">Points:</td><td><strong>${contextData.away_team.points}</strong></td></tr>`;
                        }
                        if (contextData.away_team.form) {
                            html += `<tr><td class="text-muted">Form:</td><td>${formatFormIndicators(contextData.away_team.form)}</td></tr>`;
                        }
                        // Add xG metrics if available
                        if (contextData.xg && contextData.xg.away_stats) {
                            html += `<tr><td colspan="2" class="pt-2"><hr class="my-1"></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-chart-line me-1"></i>xG For: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Expected Goals created per game based on shot quality and positions" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.away_stats.xg_for_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            html += `<tr><td class="text-muted"><i class="fas fa-shield-alt me-1"></i>xGA: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Expected Goals conceded per game (Post-Shot xG faced by goalkeeper)" style="cursor: help; font-size: 0.8em;"></i></td><td><strong>${contextData.xg.away_stats.xg_against_per_game}</strong> <small class="text-muted">/game</small></td></tr>`;
                            if (contextData.xg.away_stats.scoring_clinicality !== undefined && contextData.xg.away_stats.scoring_clinicality !== null) {
                                const clinicality = contextData.xg.away_stats.scoring_clinicality;
                                const clinicalityClass = clinicality > 0 ? 'text-success' : 'text-danger';
                                html += `<tr><td class="text-muted">Scoring Clinicality: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Goals scored vs expected per game. Positive = clinical finishing, Negative = wasteful" style="cursor: help; font-size: 0.8em;"></i></td><td class="${clinicalityClass}"><strong>${clinicality > 0 ? '+' : ''}${clinicality}</strong> <small class="text-muted">/game</small></td></tr>`;
                            }
                            // Add xG-based form (Last 5 matches from FBref)
                            if (contextData.xg.away_stats.form) {
                                html += `<tr><td class="text-muted">Recent Form: <i class="fas fa-info-circle" data-bs-toggle="tooltip" data-bs-title="Last 5 match results from FBref (üü© Win, ‚¨ú Draw, üü• Loss)" style="cursor: help; font-size: 0.8em;"></i></td><td>${formatFormIndicators(contextData.xg.away_stats.form)}</td></tr>`;
                            }
                        }
                        html += `</tbody></table>`;
                    } else {
                        html += `<p class="text-muted small"><i>No standings data available</i></p>`;
                    }
                    html += `</div>`;
                    
                    html += `</div>`;
                    
                    // Add side-by-side xG trend comparison section
                    const hasHomeXgChart = contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0;
                    const hasAwayXgChart = contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0;
                    
                    if (hasHomeXgChart || hasAwayXgChart) {
                        // Add explanation box before charts
                        const themeColors = getThemeColors();
                        html += `
                            <div class="alert alert-primary mb-3 small mt-4" style="background-color: ${themeColors.infoBoxBg}; border-color: ${themeColors.infoBoxBorder};">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-chart-line me-2 mt-1" style="color: ${themeColors.infoBoxIcon};"></i>
                                    <div>
                                        <strong>üìà How to Read xG Trend Charts:</strong><br>
                                        <span style="color: ${themeColors.xgFor}; font-weight: 600;">‚óè</span> <strong style="color: ${themeColors.xgFor};">Green line (xGF)</strong> = Goals created per game<br>
                                        <span style="color: ${themeColors.xgAgainst}; font-weight: 600;">‚óè</span> <strong style="color: ${themeColors.xgAgainst};">Red line (xGA)</strong> = Goals conceded per game<br>
                                        <span class="ms-3">‚úÖ Green ABOVE red = Good attacking form</span><br>
                                        <span class="ms-3">‚ùå Red ABOVE green = Defensive struggles</span><br>
                                        <span class="ms-3">üìà Rising green = Attack improving | üìâ Falling red = Defense improving</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        html += `
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3 text-center">
                                        <i class="fas fa-chart-area me-2"></i>xG Trend Comparison
                                    </h6>
                                </div>
                            </div>
                            <div class="row">
                        `;
                        
                        if (hasHomeXgChart) {
                            html += `
                                <div class="col-md-${hasAwayXgChart ? '5' : '12'}">
                                    <div class="text-center mb-2">
                                        <span class="badge bg-primary">${currentMatchData.home_team}</span>
                                    </div>
                                    <div style="max-height: 200px; overflow: hidden; position: relative;">
                                        <canvas id="home-xg-chart" style="height: 180px;"></canvas>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (hasHomeXgChart && hasAwayXgChart) {
                            html += `
                                <div class="col-md-2 d-flex align-items-center justify-content-center">
                                    <h4 class="text-muted mb-0">VS</h4>
                                </div>
                            `;
                        }
                        
                        if (hasAwayXgChart) {
                            html += `
                                <div class="col-md-${hasHomeXgChart ? '5' : '12'}">
                                    <div class="text-center mb-2">
                                        <span class="badge bg-danger">${currentMatchData.away_team}</span>
                                    </div>
                                    <div style="max-height: 200px; overflow: hidden; position: relative;">
                                        <canvas id="away-xg-chart" style="height: 180px;"></canvas>
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                }
                
                matchContext.innerHTML = html;
                
                // Destroy old charts if they exist to prevent memory leaks
                if (window.homeXgChart) {
                    window.homeXgChart.destroy();
                    window.homeXgChart = null;
                }
                if (window.awayXgChart) {
                    window.awayXgChart.destroy();
                    window.awayXgChart = null;
                }
                
                // Create xG trend charts if data available
                if (contextData.xg && contextData.xg.home_stats && contextData.xg.home_stats.recent_matches && contextData.xg.home_stats.recent_matches.length > 0) {
                    window.homeXgChart = createXgTrendChart('home-xg-chart', contextData.xg.home_stats.recent_matches, currentMatchData.home_team);
                }
                if (contextData.xg && contextData.xg.away_stats && contextData.xg.away_stats.recent_matches && contextData.xg.away_stats.recent_matches.length > 0) {
                    window.awayXgChart = createXgTrendChart('away-xg-chart', contextData.xg.away_stats.recent_matches, currentMatchData.away_team);
                }
                
                // Reinitialize tooltips for dynamically added content
                initTooltips();
            }
            
            function display1X2Prediction(prediction) {
                if (!prediction) {
                    prediction1x2.innerHTML = `<p class="text-muted">No prediction available</p>`;
                    return;
                }
                
                const safetyClass = prediction.is_safe_bet ? 'safe-bet' : 'risky-bet';
                const safetyText = prediction.is_safe_bet ? 'Safe Bet' : 'Risky Bet';
                
                let html = `
                    <div class="text-center mb-3">
                        <span class="prediction-badge ${safetyClass}">
                            ${prediction.prediction} (${prediction.confidence.toFixed(1)}%)
                            <i class="fas ${prediction.is_safe_bet ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                            ${safetyText}
                        </span>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Probability Breakdown:</h6>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Home Win:</span>
                                <span>${(prediction.probabilities.HOME_WIN * 100).toFixed(1)}%</span>
                            </div>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${prediction.probabilities.HOME_WIN * 100}%; background-color: ${getThemeColors().primary};"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Draw:</span>
                                <span>${(prediction.probabilities.DRAW * 100).toFixed(1)}%</span>
                            </div>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${prediction.probabilities.DRAW * 100}%; background-color: ${getThemeColors().muted};"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Away Win:</span>
                                <span>${(prediction.probabilities.AWAY_WIN * 100).toFixed(1)}%</span>
                            </div>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${prediction.probabilities.AWAY_WIN * 100}%; background-color: ${getThemeColors().secondary};"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                prediction1x2.innerHTML = html;
            }
            
            function displayOverUnderPredictions(predictions) {
                if (!predictions) {
                    predictionOverUnder.innerHTML = `<p class="text-muted">No predictions available</p>`;
                    return;
                }
                
                let html = `<div class="row">`;
                
                const thresholds = ['0.5', '1.5', '2.5', '3.5'];
                
                thresholds.forEach(threshold => {
                    const prediction = predictions[threshold];
                    if (!prediction) return;
                    
                    const safetyClass = prediction.is_safe_bet ? 'safe-bet' : 'risky-bet';
                    const safetyText = prediction.is_safe_bet ? 'Safe Bet' : 'Risky Bet';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    Over/Under ${threshold}
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <span class="prediction-badge ${safetyClass}">
                                            ${prediction.prediction} (${(prediction.confidence * 100).toFixed(1)}%)
                                            <i class="fas ${prediction.is_safe_bet ? 'fa-shield-alt' : 'fa-exclamation-triangle'} ms-1"></i>
                                            ${safetyText}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Over:</span>
                                            <span>${(prediction.probabilities.OVER * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.OVER * 100}%; background-color: ${getThemeColors().secondary};"></div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span>Under:</span>
                                            <span>${(prediction.probabilities.UNDER * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${prediction.probabilities.UNDER * 100}%; background-color: ${getThemeColors().muted};"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                predictionOverUnder.innerHTML = html;
            }
            
            function generateBettingTips(pred1x2, overUnderData, xgData) {
                if (!pred1x2.probabilities) {
                    return '';
                }
                
                const probs = pred1x2.probabilities;
                const homeWin = probs.HOME_WIN || 0;
                const draw = probs.DRAW || 0;
                const awayWin = probs.AWAY_WIN || 0;
                
                // Calculate double chance probabilities
                const dc1X = homeWin + draw;  // Home or Draw
                const dc12 = homeWin + awayWin;  // Home or Away
                const dcX2 = draw + awayWin;  // Draw or Away
                
                // Create array of betting options
                const options = [
                    { name: 'Home Win', prob: homeWin, type: '1x2' },
                    { name: 'Draw', prob: draw, type: '1x2' },
                    { name: 'Away Win', prob: awayWin, type: '1x2' },
                    { name: 'Double Chance 1X (Home or Draw)', prob: dc1X, type: 'double_chance' },
                    { name: 'Double Chance 12 (Home or Away)', prob: dc12, type: 'double_chance' },
                    { name: 'Double Chance X2 (Draw or Away)', prob: dcX2, type: 'double_chance' }
                ];
                
                // Add Over/Under options if available
                if (overUnderData && overUnderData.predictions) {
                    overUnderData.predictions.forEach(pred => {
                        const overProb = pred.probabilities.over || 0;
                        const underProb = pred.probabilities.under || 0;
                        
                        options.push({
                            name: `Over ${pred.line} Goals`,
                            prob: overProb,
                            type: 'totals',
                            line: pred.line
                        });
                        
                        options.push({
                            name: `Under ${pred.line} Goals`,
                            prob: underProb,
                            type: 'totals',
                            line: pred.line
                        });
                    });
                }
                
                // Sort by probability
                options.sort((a, b) => b.prob - a.prob);
                
                // Find safest, balanced, and risky bets
                const safest = options.find(opt => opt.prob >= 0.60);
                const balanced = options.find(opt => opt.prob >= 0.30 && opt.prob < 0.60);
                const risky = options.find(opt => opt.prob >= 0.15 && opt.prob < 0.30);
                
                let html = '<div class="analysis-section mb-3">';
                html += '<div class="analysis-title">üí° Betting Tips <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Recommendations based on bookmaker consensus odds. Factors: implied probability, value rating, confidence threshold. Source: 30+ bookmakers via The Odds API" style="cursor: help; font-size: 0.85em;"></i></div>';
                
                if (safest) {
                    const typeIcon = safest.type === 'totals' ? '‚öΩ' : safest.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-success mb-2">
                            <strong>üõ°Ô∏è SAFEST BET:</strong> ${typeIcon} ${safest.name}
                            <br><span class="badge bg-success">${(safest.prob * 100).toFixed(1)}% probability</span>
                            <br><small class="text-muted">Lower odds but highest chance of winning</small>
                        </div>
                    `;
                }
                
                if (balanced) {
                    const typeIcon = balanced.type === 'totals' ? '‚öΩ' : balanced.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-info mb-2">
                            <strong>‚öñÔ∏è BALANCED BET:</strong> ${typeIcon} ${balanced.name}
                            <br><span class="badge bg-info">${(balanced.prob * 100).toFixed(1)}% probability</span>
                            <br><small class="text-muted">Moderate odds with reasonable chance</small>
                        </div>
                    `;
                }
                
                if (risky) {
                    const typeIcon = risky.type === 'totals' ? '‚öΩ' : risky.type === 'double_chance' ? 'üéØ' : 'üèÜ';
                    html += `
                        <div class="alert alert-warning mb-2">
                            <strong>üé≤ VALUE BET:</strong> ${typeIcon} ${risky.name}
                            <br><span class="badge bg-warning text-dark">${(risky.prob * 100).toFixed(1)}% probability</span>
                            <br><small class="text-muted">Higher odds but lower probability</small>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Add xG-based insights if available
                if (xgData && xgData.available) {
                    const themeColors = getThemeColors();
                    html += `<div class="analysis-section mb-3" style="border: 2px solid ${themeColors.xgAnalysisBorder}; background-color: ${themeColors.xgAnalysisBg};">`;
                    html += `<div class="analysis-title" style="color: ${themeColors.xgAnalysisText};"><i class="fas fa-chart-line me-2"></i>xG Analysis <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Statistical predictions based on Expected Goals (xG). Considers: team attacking strength (xGF), defensive strength (xGA). Source: FBref via soccerdata" style="cursor: help; font-size: 0.85em;"></i></div>`;
                    
                    html += `
                        <p class="mb-2">
                            <strong>Expected Goals Prediction:</strong>
                            <span class="badge bg-primary">${xgData.home_xg.toFixed(2)}</span>
                            -
                            <span class="badge bg-danger">${xgData.away_xg.toFixed(2)}</span>
                        </p>
                        <p class="small text-muted mb-3">
                            Total expected goals: ${xgData.total_xg.toFixed(2)}
                            (${xgData.over_under_2_5.prediction} 2.5 goals at ${xgData.over_under_2_5.over_probability}%)
                        </p>
                    `;
                    
                    // xG-based match result recommendation
                    const xgResult = xgData.result_prediction;
                    const xgResultText = xgResult.prediction === 'HOME_WIN' ? 'üè† Home Win' : 
                                        xgResult.prediction === 'AWAY_WIN' ? '‚úàÔ∏è Away Win' : 'ü§ù Draw';
                    html += `
                        <div class="alert alert-primary mb-2">
                            <strong>üìä xG Result Prediction:</strong> ${xgResultText}
                            <br><span class="badge bg-primary">${xgResult.confidence}% confidence (based on xG data)</span>
                            <br><small class="text-muted">Statistical prediction based on team attacking/defensive strength</small>
                        </div>
                    `;
                    
                    // xG-based Over/Under recommendation
                    const xgOverUnder = xgData.over_under_2_5;
                    html += `
                        <div class="alert ${xgOverUnder.over_probability >= 60 ? 'alert-success' : 'alert-secondary'} mb-2">
                            <strong>‚öΩ xG Over/Under 2.5:</strong> ${xgOverUnder.prediction}
                            <br><span class="badge ${xgOverUnder.over_probability >= 60 ? 'bg-success' : 'bg-secondary'}">
                                ${xgOverUnder.prediction === 'OVER' ? xgOverUnder.over_probability : xgOverUnder.under_probability}% probability
                            </span>
                            <br><small class="text-muted">Based on combined xG: ${xgData.total_xg.toFixed(2)} expected goals</small>
                        </div>
                    `;
                    
                    html += '<p class="small text-muted mt-2"><i class="fas fa-info-circle me-1"></i>xG (Expected Goals) is a statistical measure based on FBref data showing team offensive and defensive strength</p>';
                    html += '</div>';
                }
                
                return html;
            }
            
            function displayOddsBasedAnalysis(match) {
                const predictions = match.predictions || {};
                const pred1x2 = predictions['1x2'] || {};
                const bestOdds = predictions.best_odds || {};
                const arbitrage = predictions.arbitrage || null;
                
                let html = '<div class="analysis-section mb-3">';
                html += '<div class="analysis-title">üìä Market Data</div>';
                html += `<p><strong>Bookmakers:</strong> ${pred1x2.bookmaker_count || 0} bookmakers providing odds</p>`;
                html += '</div>';
                
                if (bestOdds.home || bestOdds.draw || bestOdds.away) {
                    html += '<div class="analysis-section mb-3">';
                    html += '<div class="analysis-title">üí∞ Best Odds</div>';
                    if (bestOdds.home && bestOdds.home.price) {
                        html += `<p><strong>Home Win:</strong> ${bestOdds.home.price.toFixed(2)} at ${bestOdds.home.bookmaker}</p>`;
                    }
                    if (bestOdds.draw && bestOdds.draw.price) {
                        html += `<p><strong>Draw:</strong> ${bestOdds.draw.price.toFixed(2)} at ${bestOdds.draw.bookmaker}</p>`;
                    }
                    if (bestOdds.away && bestOdds.away.price) {
                        html += `<p><strong>Away Win:</strong> ${bestOdds.away.price.toFixed(2)} at ${bestOdds.away.bookmaker}</p>`;
                    }
                    html += '</div>';
                }
                
                if (arbitrage && arbitrage.is_arbitrage) {
                    html += '<div class="analysis-section mb-3" style="border: 2px solid #10b981; background-color: #d1fae5;">';
                    html += '<div class="analysis-title" style="color: #10b981;">‚úÖ Arbitrage Opportunity! <i class="fas fa-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Risk-free profit by exploiting odds differences across bookmakers. Bet on all outcomes to guarantee profit regardless of result." style="cursor: help; font-size: 0.85em;"></i></div>';
                    html += `<p><strong>Profit Margin:</strong> ${arbitrage.profit_margin}%</p>`;
                    html += `<p><strong>Optimal Stakes (per $100):</strong></p>`;
                    html += `<ul style="list-style: none; padding-left: 0;">`;
                    
                    if (arbitrage.best_odds && arbitrage.best_odds.home) {
                        html += `<li class="mb-2">üí∞ <strong>Home:</strong> $${arbitrage.stakes.home} @ <span class="text-primary">${arbitrage.best_odds.home.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.home.price.toFixed(2)}</span></li>`;
                    }
                    if (arbitrage.best_odds && arbitrage.best_odds.draw) {
                        html += `<li class="mb-2">üí∞ <strong>Draw:</strong> $${arbitrage.stakes.draw} @ <span class="text-primary">${arbitrage.best_odds.draw.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.draw.price.toFixed(2)}</span></li>`;
                    }
                    if (arbitrage.best_odds && arbitrage.best_odds.away) {
                        html += `<li class="mb-2">üí∞ <strong>Away:</strong> $${arbitrage.stakes.away} @ <span class="text-primary">${arbitrage.best_odds.away.bookmaker}</span> <span class="badge bg-secondary">${arbitrage.best_odds.away.price.toFixed(2)}</span></li>`;
                    }
                    
                    html += `</ul>`;
                    html += `<p class="small text-muted mt-3"><i class="fas fa-info-circle me-1"></i>Guaranteed profit: $${arbitrage.profit_margin} per $100 wagered</p>`;
                    html += '</div>';
                }
                
                // Add Betting Tips (include Over/Under and xG data if available)
                html += generateBettingTips(pred1x2, currentOverUnderData, currentXgData);
                
                bettingAnalysis.innerHTML = html;
                
                // Reinitialize tooltips for dynamically added content
                initTooltips();
            }
            
            function displayBettingAnalysis(match) {
                const analysis = match.betting_analysis || {};
                
                if (Object.keys(analysis).length === 0) {
                    bettingAnalysis.innerHTML = `<p class="text-muted">No betting analysis available</p>`;
                    return;
                }
                
                let html = '';
                
                for (const [title, content] of Object.entries(analysis)) {
                    html += `
                        <div class="analysis-section mb-3">
                            <div class="analysis-title">${title}</div>
                            <div>${content}</div>
                        </div>
                    `;
                }
                
                bettingAnalysis.innerHTML = html;
            }
            
            function loadingSpinner() {
                return `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
            }
            
            // Initialize Bootstrap tooltips
            function initTooltips() {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            }
            
            // Call it on page load
            initTooltips();
            
            // Auto-load popular upcoming matches on page load
            getUpcomingMatches('CL');
        });
        
        // Theme toggle functionality (outside DOMContentLoaded for onclick access)
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            // Toggle dark theme class
            body.classList.toggle('dark-theme');
            
            // Update button icon and text
            const isDark = body.classList.contains('dark-theme');
            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            }
            
            // Refresh charts if they exist (they'll pick up new theme colors)
            if (window.homeXgChart) {
                const homeCanvas = document.getElementById('home-xg-chart');
                if (homeCanvas && currentMatchData && currentXgData && currentXgData.home_stats && currentXgData.home_stats.recent_matches) {
                    window.homeXgChart.destroy();
                    window.homeXgChart = createXgTrendChart('home-xg-chart', currentXgData.home_stats.recent_matches, currentMatchData.home_team);
                }
            }
            if (window.awayXgChart) {
                const awayCanvas = document.getElementById('away-xg-chart');
                if (awayCanvas && currentMatchData && currentXgData && currentXgData.away_stats && currentXgData.away_stats.recent_matches) {
                    window.awayXgChart.destroy();
                    window.awayXgChart = createXgTrendChart('away-xg-chart', currentXgData.away_stats.recent_matches, currentMatchData.away_team);
                }
            }
        }
        
        // Initialize theme from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light Mode';
            }
        });
    </script>
</body>
</html>
