<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Sportmonks feed (beta)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style> body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:16px;}
    .card{border:1px solid #eee; border-radius:12px; padding:12px; margin:8px 0}
    .muted{color:#666; font-size:12px}
    button{padding:8px 12px; border-radius:8px; border:1px solid #ddd; cursor:pointer}
    #leagues-filter{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:16px 0}
    #leagues-filter label{display:flex; align-items:center; gap:4px; font-size:14px}
    #leagues-filter button{font-size:12px; padding:6px 10px}
  </style>
</head>
<body>
  <h2>Sportmonks feed (beta)</h2>
  <div class="muted">Endless timeline for Top 5. Click a match to see details (stub).</div>

  <form id="leagues-filter">
    <label><input type="checkbox" value="EPL"/> EPL</label>
    <label><input type="checkbox" value="LLIGA"/> LLIGA</label>
    <label><input type="checkbox" value="SERIEA"/> SERIEA</label>
    <label><input type="checkbox" value="BUNDES"/> BUNDES</label>
    <label><input type="checkbox" value="LIGUE1"/> LIGUE1</label>
    <button type="button" id="reset-leagues">Reset to Top-5</button>
  </form>

  <div id="feed"></div>
  <div id="sentinel" class="muted" style="text-align:center; padding:16px;">Loading…</div>

<script>
const FEED_URL = "/api/smonks/feed";
const STORAGE_KEY = "smonks_leagues";
const ALL_LEAGUES = ["EPL", "LLIGA", "SERIEA", "BUNDES", "LIGUE1"];
let cursor = null;
let loading = false;
let doneFuture = false;
let currentLeagues = [];
let feedGeneration = 0;
let emptyBurstsLeft = 3; // auto-advance through empty windows
let wantsAutoAdvance = false; // NEW: defer the next call until loading is cleared

function getStoredLeagues() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored === null) return [...ALL_LEAGUES];
  if (stored === "") return [];
  const parts = stored.split(",").map(s => s.trim()).filter(Boolean);
  const valid = parts.filter(code => ALL_LEAGUES.includes(code));
  return valid.length ? valid : [...ALL_LEAGUES];
}

function syncCheckboxes(leagues) {
  document.querySelectorAll('#leagues-filter input[type="checkbox"]').forEach(cb => {
    cb.checked = leagues.includes(cb.value);
  });
}

function getCheckedLeagues() {
  return Array.from(document.querySelectorAll('#leagues-filter input[type="checkbox"]:checked')).map(cb => cb.value);
}

function storeLeagues(leagues) {
  localStorage.setItem(STORAGE_KEY, leagues.join(","));
}

function resetFeedState() {
  feedGeneration += 1;
  cursor = null;
  doneFuture = false;
  loading = false;
  emptyBurstsLeft = 3;
  wantsAutoAdvance = false;
  document.getElementById("feed").innerHTML = "";
  document.getElementById("sentinel").textContent = "Loading…";
}

async function fetchPage() {
  const url = new URL(FEED_URL, location.origin);
  url.searchParams.set("dir", "future");
  if (cursor) url.searchParams.set("cursor", cursor);
  if (currentLeagues.length) {
    url.searchParams.set("leagues", currentLeagues.join(","));
  }
  const res = await fetch(url);
  if (!res.ok) throw new Error("feed fetch failed: " + res.status);
  return res.json();
}

function renderItem(item) {
  const div = document.createElement("div");
  div.className = "card";
  const h = item.home || {}, a = item.away || {};
  const when = new Date(item.kickoff_iso).toLocaleString();
  div.innerHTML = `
    <div><strong>${h.display_name || h.name || "Home"} vs ${a.display_name || a.name || "Away"}</strong></div>
    <div class="muted">${item.competition_code} — ${when} — ${item.status || "NS"}</div>
  `;
  div.onclick = () => location.href = "/api/smonks/match/" + encodeURIComponent(item.match_id);
  return div;
}

async function loadFeed() {
  if (loading || doneFuture) return;
  const generationAtCall = feedGeneration;
  loading = true;
  try {
    const data = await fetchPage();
    if (!data || generationAtCall !== feedGeneration) return;
    const feed = document.getElementById("feed");
    const got = Array.isArray(data.items) ? data.items : [];
    got.forEach(it => feed.appendChild(renderItem(it)));
    cursor = data.next_cursor || null;
    doneFuture = !data.has_more_future;
    document.getElementById("sentinel").textContent = doneFuture ? "Done." : "Loading…";

    // NEW: if nothing came back, mark that we want to auto-advance
    if (got.length === 0 && !doneFuture && emptyBurstsLeft > 0) {
      emptyBurstsLeft -= 1;
      wantsAutoAdvance = true;
    }
  } catch (e) {
    console.error(e);
    if (generationAtCall === feedGeneration) {
      document.getElementById("sentinel").textContent = "Error. Scroll to retry.";
    }
  } finally {
    if (generationAtCall === feedGeneration) {
      loading = false;
      // NEW: perform the deferred auto-advance now that loading is cleared
      if (wantsAutoAdvance) {
        wantsAutoAdvance = false;
        // Use microtask to yield UI thread
        Promise.resolve().then(() => {
          if (!loading && !doneFuture && generationAtCall === feedGeneration) {
            loadFeed();
          }
        });
      }
    }
  }
}

const io = new IntersectionObserver((entries) => {
  entries.forEach(e => { if (e.isIntersecting) loadFeed(); });
});
io.observe(document.getElementById("sentinel"));

const filterForm = document.getElementById("leagues-filter");
filterForm.addEventListener("change", (event) => {
  if (event.target.matches('input[type="checkbox"]')) {
    currentLeagues = getCheckedLeagues();
    storeLeagues(currentLeagues);
    resetFeedState();
    loadFeed();
  }
});

document.getElementById("reset-leagues").addEventListener("click", (event) => {
  event.preventDefault();
  currentLeagues = [...ALL_LEAGUES];
  syncCheckboxes(currentLeagues);
  storeLeagues(currentLeagues);
  resetFeedState();
  loadFeed();
});

currentLeagues = getStoredLeagues();
syncCheckboxes(currentLeagues);
storeLeagues(currentLeagues);
resetFeedState();
loadFeed();
</script>
</body>
</html>
